<!DOCTYPE html />

<html>
<head>
	<title>Room.js</title>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
	<link href="../nocco.css" rel="stylesheet" media="all" type="text/css" />
	<script src="../prettify.js" type="text/javascript"></script>
</head>
<body onload="prettyPrint()">
	<div id="container">
		<div id="background"></div>
			<div id="jump_to">
				Jump To &hellip;
				<div id="jump_wrapper">
					<div id="jump_page">
							<a class="source" href="../xrtc/ajax.html">
								xrtc\Ajax.js
							</a>
							<a class="source" href="../xrtc/authmanager.html">
								xrtc\AuthManager.js
							</a>
							<a class="source" href="../xrtc/class.html">
								xrtc\Class.js
							</a>
							<a class="source" href="../xrtc/common.html">
								xrtc\Common.js
							</a>
							<a class="source" href="../xrtc/commonerror.html">
								xrtc\CommonError.js
							</a>
							<a class="source" href="../xrtc/connection.html">
								xrtc\Connection.js
							</a>
							<a class="source" href="../xrtc/datachannel.html">
								xrtc\DataChannel.js
							</a>
							<a class="source" href="../xrtc/eventdispatcher.html">
								xrtc\EventDispatcher.js
							</a>
							<a class="source" href="../xrtc/handshakecontroller.html">
								xrtc\HandshakeController.js
							</a>
							<a class="source" href="../xrtc/logger.html">
								xrtc\Logger.js
							</a>
							<a class="source" href="../xrtc/room.html">
								xrtc\Room.js
							</a>
							<a class="source" href="../xrtc/serverconnector.html">
								xrtc\ServerConnector.js
							</a>
							<a class="source" href="../xrtc/stream.html">
								xrtc\Stream.js
							</a>
							<a class="source" href="../xrtc/usermedia.html">
								xrtc\UserMedia.js
							</a>
					</div>
				</div>
			</div>
		<table cellpadding="0" cellspacing="0">
			<thead>
				<tr>
					<th class="docs">
						<h1>Room.js</h1>
					</th>
					<th class="code"></th>
				</tr>
			</thead>
			<tbody>
					<tr id="section_1">
						<td class="docs">
							<div class="pilwrap">
								<a class="pilcrow" href="#section_1">&#182;</a>
							</div>
							<h4>Version 1.3.0</h4>

						</td>
						<td class="code">
							<pre><code class='prettyprint'>
</code></pre>
						</td>
					</tr>
					<tr id="section_2">
						<td class="docs">
							<div class="pilwrap">
								<a class="pilcrow" href="#section_2">&#182;</a>
							</div>
							<p><code>xRtc.Room</code> is one of the main objects of <strong>xRtc</strong> library.</p>

						</td>
						<td class="code">
							<pre><code class='prettyprint'>
&#39;use strict&#39;;

(function (exports) {
	var xrtc = exports.xRtc;

	xrtc.Class(xrtc, &#39;Room&#39;, function Room(info, am, sc) {
		var proxy = xrtc.Class.proxy(this),
			logger = new xrtc.Logger(this.className),
			hcEvents = xrtc.HandshakeController.events,
			scEvents = xrtc.ServerConnector.events,
			participants = [],
			isServerConnectorSubscribed = false,
			roomOptions = {},
			roomInfo = {},
			currentUserData = null,
			authManager = am || new xRtc.AuthManager(),
			serverConnector = sc || new xrtc.ServerConnector(),
			connections = [],
			handshakeControllers = {};

</code></pre>
						</td>
					</tr>
					<tr id="section_3">
						<td class="docs">
							<div class="pilwrap">
								<a class="pilcrow" href="#section_3">&#182;</a>
							</div>
							<p><code>roomInfo</code> initialization.</p>

						</td>
						<td class="code">
							<pre><code class='prettyprint'>		xrtc.Class.extend(roomInfo, xrtc.Room.settings.info);
		if (typeof info === &#39;string&#39;) {
			roomInfo.name = info;
		} else {
			xrtc.Class.extend(roomInfo, info);
		}

		xrtc.Class.extend(this, xrtc.EventDispatcher, {
			_logger: logger,

</code></pre>
						</td>
					</tr>
					<tr id="section_4">
						<td class="docs">
							<div class="pilwrap">
								<a class="pilcrow" href="#section_4">&#182;</a>
							</div>
							<p><strong>[Public API]:</strong> It is public method of <code>room</code> object. This method should be used for entering the room.</p>

						</td>
						<td class="code">
							<pre><code class='prettyprint'>			enter: function (credentials, options) {
				var user = &quot;&quot;, pass = &quot;&quot;;

				if (!credentials) {
					throw new xrtc.CommonError(&#39;enter&#39;, &#39;User credentials should be specified.&#39;);
				}

				if (typeof credentials === &#39;string&#39;) {
					user = credentials;
				} else {
					user = credentials.username;
					pass = credentials.password;
				}

				subscribeToServerEvents.call(this);

</code></pre>
						</td>
					</tr>
					<tr id="section_5">
						<td class="docs">
							<div class="pilwrap">
								<a class="pilcrow" href="#section_5">&#182;</a>
							</div>
							<p><code>roomOptions</code> initialization.</p>

						</td>
						<td class="code">
							<pre><code class='prettyprint'>				xrtc.Class.extend(roomOptions, xrtc.Room.settings.options);
				if (options) {
					xrtc.Class.extend(roomOptions, options);
				};

</code></pre>
						</td>
					</tr>
					<tr id="section_6">
						<td class="docs">
							<div class="pilwrap">
								<a class="pilcrow" href="#section_6">&#182;</a>
							</div>
							<p><code>userData</code> initialization.</p>

						</td>
						<td class="code">
							<pre><code class='prettyprint'>				currentUserData = {
					domain: roomInfo.domain,
					application: roomInfo.application,
					room: roomInfo.name,
					name: user,
					password: pass
				};

				authManager.getToken(currentUserData, function (token) {
					roomInfo.user = user;
					serverConnector.connect(token);
				});
			},

</code></pre>
						</td>
					</tr>
					<tr id="section_7">
						<td class="docs">
							<div class="pilwrap">
								<a class="pilcrow" href="#section_7">&#182;</a>
							</div>
							<p><strong>[Public API]:</strong> It is public method of <code>room</code> object. This method should be used for leaving the room.</p>

						</td>
						<td class="code">
							<pre><code class='prettyprint'>			leave: function () {
				serverConnector.disconnect();

				unsubscribeFromServerEvents.call(this);

				roomOptions = {};
				currentUserData = null;
				roomInfo.user = null;
				participants = [];

</code></pre>
						</td>
					</tr>
					<tr id="section_8">
						<td class="docs">
							<div class="pilwrap">
								<a class="pilcrow" href="#section_8">&#182;</a>
							</div>
							<p><strong>Todo:</strong> Maybe will be good to close all room connections. Need to discuss it with the team.</p>

						</td>
						<td class="code">
							<pre><code class='prettyprint'>				connections = [],
				handshakeControllers = {};
			},

</code></pre>
						</td>
					</tr>
					<tr id="section_9">
						<td class="docs">
							<div class="pilwrap">
								<a class="pilcrow" href="#section_9">&#182;</a>
							</div>
							<p><strong>[Public API]:</strong> It is public method of <code>room</code> object. This method should be used for connection to someone from the current room.</p>

						</td>
						<td class="code">
							<pre><code class='prettyprint'>			connect: function (userId, connectionOptions) {
				if (!roomInfo.user) {
					throw new xrtc.CommonError(&#39;connect&#39;, &#39;Need to enter the room before you connect someone.&#39;);
				}

				var connectionDataContainer = (connectionOptions &amp;&amp; connectionOptions.data) ? connectionOptions.data : null;

				createConnection.call(this, currentUserData, userId, connectionDataContainer, function (connectionData) {
					var connection = connectionData.connection;

					if (connectionOptions &amp;&amp; connectionOptions.createDataChannel === &#39;auto&#39;) {
						connection.createDataChannel(&#39;autoDataChannel&#39;);
					}

					connection._open(connectionOptions);
				});
			},

</code></pre>
						</td>
					</tr>
					<tr id="section_10">
						<td class="docs">
							<div class="pilwrap">
								<a class="pilcrow" href="#section_10">&#182;</a>
							</div>
							<p><strong>[Public API]:</strong> It is public method of <code>room</code> object. This method should be used for access room information.</p>

						</td>
						<td class="code">
							<pre><code class='prettyprint'>			getInfo: function () {
				return roomInfo;
			},

</code></pre>
						</td>
					</tr>
					<tr id="section_11">
						<td class="docs">
							<div class="pilwrap">
								<a class="pilcrow" href="#section_11">&#182;</a>
							</div>
							<p><strong>[Public API]:</strong> It is public method of <code>room</code> object. Returns existed connections (<code>xRtc.Connection[]</code>) of the room.</p>

						</td>
						<td class="code">
							<pre><code class='prettyprint'>			getConnections: function () {
</code></pre>
						</td>
					</tr>
					<tr id="section_12">
						<td class="docs">
							<div class="pilwrap">
								<a class="pilcrow" href="#section_12">&#182;</a>
							</div>
							<p>Return the copy of internal array.</p>

						</td>
						<td class="code">
							<pre><code class='prettyprint'>				return connections.map(function (connection) {
					return connection;
				});
			},

</code></pre>
						</td>
					</tr>
					<tr id="section_13">
						<td class="docs">
							<div class="pilwrap">
								<a class="pilcrow" href="#section_13">&#182;</a>
							</div>
							<p><strong>[Public API]:</strong> It is public method of <code>room</code> object. Returns array of participans from the current room.</p>

						</td>
						<td class="code">
							<pre><code class='prettyprint'>			getParticipants: function () {
</code></pre>
						</td>
					</tr>
					<tr id="section_14">
						<td class="docs">
							<div class="pilwrap">
								<a class="pilcrow" href="#section_14">&#182;</a>
							</div>
							<p>return the copy of array</p>

						</td>
						<td class="code">
							<pre><code class='prettyprint'>				return participants.map(function (participant) {
					return participant;
				});
			}
		});

		function subscribeToServerEvents() {
			if (!isServerConnectorSubscribed) {
				serverConnector
					.on(scEvents.connectionOpen, proxy(function (event) { this.trigger(xrtc.Room.events.enter); }))
					.on(scEvents.connectionClose, proxy(function (event) { this.trigger(xrtc.Room.events.leave); }))
					.on(scEvents.tokenInvalid, proxy(function (event) { this.trigger(xrtc.Room.events.tokenInvalid); }))
					.on(scEvents.participantsUpdated, proxy(function (data) {
						participants = data.participants;
						sortParticipants();

						this.trigger(xrtc.Room.events.participantsUpdated, { participants: this.getParticipants() });
					}))
					.on(scEvents.participantConnected, proxy(function (data) {
						participants.push(data.participantId);
						sortParticipants();

						this.trigger(xrtc.Room.events.participantConnected, { participantId: data.participantId });
					}))
					.on(scEvents.participantDisconnected, proxy(function (data) {
						participants.splice(participants.indexOf(data.participantId), 1);
						sortParticipants();

						this.trigger(xrtc.Room.events.participantDisconnected, { participantId: data.participantId });
					}))
					.on(scEvents.receiveOffer, proxy(onIncomingConnection))
</code></pre>
						</td>
					</tr>
					<tr id="section_15">
						<td class="docs">
							<div class="pilwrap">
								<a class="pilcrow" href="#section_15">&#182;</a>
							</div>
							<p><strong>Note:</strong> everything works fine without sendbye functionality in case when connection was closed manually.
This functionality helps to detect 'close' action more quickly for Chrome because xRtc.Connection fires close event not immediately.</p>

						</td>
						<td class="code">
							<pre><code class='prettyprint'>					.on(scEvents.receiveBye, proxy(onCloseConnection));

				isServerConnectorSubscribed = true;
			}
		}

		function unsubscribeFromServerEvents() {
			if (isServerConnectorSubscribed) {
				serverConnector
					.off(scEvents.participantsUpdated)
					.off(scEvents.participantConnected)
					.off(scEvents.participantDisconnected);

</code></pre>
						</td>
					</tr>
					<tr id="section_16">
						<td class="docs">
							<div class="pilwrap">
								<a class="pilcrow" href="#section_16">&#182;</a>
							</div>
							<p><strong>Todo:</strong> What about another events? (<code>connectionOpen</code>, <code>connectionClose</code>, <code>tokenInvalid</code>). Need to think about it later.</p>

						</td>
						<td class="code">
							<pre><code class='prettyprint'>
				isServerConnectorSubscribed = false;
			}
		}

		function sortParticipants() {
			participants.sort();
		}

		function getConnectionIndexById(connectionsArray, connectionId) {
			var resultIndex = null;
			for (var i = 0, len = connectionsArray.length; i &lt; len; i++) {
				if (connectionsArray[i].getId() === connectionId) {
					resultIndex = i;
					break;
				}
			}

			return resultIndex;
		}

		function onIncomingConnection(data) {
</code></pre>
						</td>
					</tr>
					<tr id="section_17">
						<td class="docs">
							<div class="pilwrap">
								<a class="pilcrow" href="#section_17">&#182;</a>
							</div>
							<p>Skip <code>offer</code> if it is not for me. It is temporary fix, because server shouldn't pass the <code>offer</code> to wrong target.
Sometimes it happened that the server had sent the <code>offer</code> to all/wrong participants. So we decided not touch this check.</p>

						</td>
						<td class="code">
							<pre><code class='prettyprint'>			if (data.receiverId !== roomInfo.user) {
				return;
			}

			var self = this;

			var incomingConnectionData = {
				userId: data.senderId
			};

			if (!roomOptions.autoReply) {
				incomingConnectionData.data = data.connectionData;
				incomingConnectionData.accept = proxy(onAcceptCall);
				incomingConnectionData.decline = proxy(onDeclineCall);
			}

			this.trigger(xrtc.Room.events.incomingConnection, incomingConnectionData);

			if (roomOptions.autoReply) {
				onAcceptCall.call(self);
			}

			function onAcceptCall() {
</code></pre>
						</td>
					</tr>
					<tr id="section_18">
						<td class="docs">
							<div class="pilwrap">
								<a class="pilcrow" href="#section_18">&#182;</a>
							</div>
							<p><strong>Todo:</strong> Need to transfer remote connection data here.</p>

						</td>
						<td class="code">
							<pre><code class='prettyprint'>				createConnection.call(self, currentUserData, data.senderId, data.connectionData, function (connectionData) {
					var offerData = {
						offer: data.offer,
						iceServers: data.iceServers,
						connectionType: data.connectionType,
						connectionId: data.connectionId,
						connectionData: data.connectionData
					};

					connectionData.handshakeController.trigger(hcEvents.receiveOffer, offerData);
				});
			}

			function onDeclineCall() {
</code></pre>
						</td>
					</tr>
					<tr id="section_19">
						<td class="docs">
							<div class="pilwrap">
								<a class="pilcrow" href="#section_19">&#182;</a>
							</div>
							<p><strong>Note:</strong> Need to think about declining reason.
<strong>Todo:</strong> Need to think about <code>bye</code> options definition and about senderId property name.</p>

						</td>
						<td class="code">
							<pre><code class='prettyprint'>				serverConnector.sendBye(data.senderId, data.connectionId, null, { type: &#39;decline&#39; });
			}
		}

		function onCloseConnection(data) {
			if (data.targetConnectionId) {
				var targetHc = handshakeControllers[data.targetConnectionId];
				if (targetHc) {
					if (data.options &amp;&amp; data.options.type === &#39;decline&#39;) {
</code></pre>
						</td>
					</tr>
					<tr id="section_20">
						<td class="docs">
							<div class="pilwrap">
								<a class="pilcrow" href="#section_20">&#182;</a>
							</div>
							<p><strong>Todo:</strong> Think about sending decline reason.</p>

						</td>
						<td class="code">
							<pre><code class='prettyprint'>						this.trigger(xrtc.Room.events.connectionDeclined, { userId: data.senderId, connectionId: data.connectionId });
					}

</code></pre>
						</td>
					</tr>
					<tr id="section_21">
						<td class="docs">
							<div class="pilwrap">
								<a class="pilcrow" href="#section_21">&#182;</a>
							</div>
							<p><strong>Bug:</strong> This actin should be executed only in case when <code>bye</code> was send from target user <code>(userid === connection.targetUser)</code>. As a result near handshake controller need to store userId also.</p>

						</td>
						<td class="code">
							<pre><code class='prettyprint'>					targetHc.trigger(hcEvents.receiveBye);
				}

</code></pre>
						</td>
					</tr>
					<tr id="section_22">
						<td class="docs">
							<div class="pilwrap">
								<a class="pilcrow" href="#section_22">&#182;</a>
							</div>
							<p><strong>Bug:</strong> Close the connection in case when close command was received from target user of this connection.
Steps for reproduce:</p>

						</td>
						<td class="code">
							<pre><code class='prettyprint'>
</code></pre>
						</td>
					</tr>
					<tr id="section_23">
						<td class="docs">
							<div class="pilwrap">
								<a class="pilcrow" href="#section_23">&#182;</a>
							</div>
							<ol>
<li>Call to user;</li>
<li>Close created connection which was created for the user;</li>
<li>User accept incomin connection -> answer will be sent to me;</li>
<li>I received answer and send <code>bye</code> to the user, becuase my connection was closed already;</li>
<li>User receiving <code>bye</code> and doing nothing, but the connection should be closed.
<strong>Note:</strong> Do not forget about filtering close command by target user id.</li>
</ol>

						</td>
						<td class="code">
							<pre><code class='prettyprint'>			}
		}

		function createConnection(userData, targetUserId, connectionData, connectionCreated) {
			var self = this;
			var hc = new xrtc.HandshakeController();

			var connection = new xRtc.Connection(userData, targetUserId, hc, authManager, connectionData);
			var connectionId = connection.getId();

			handshakeControllers[connectionId] = hc;

			serverConnector.on(scEvents.receiveAnswer, function (data) {
				if (data.targetConnectionId) {
					var targetHc = handshakeControllers[data.targetConnectionId];
					if (targetHc) {
						targetHc.trigger(hcEvents.receiveAnswer, { connectionId: data.connectionId, answer: data.answer });
					} else {
						serverConnector.sendBye(data.senderId, data.connectionId, data.targetConnectionId);
					}
				}
			});

			serverConnector.on(scEvents.receiveIce, function (data) {
				if (data.targetConnectionId) {
					var targetHc = handshakeControllers[data.targetConnectionId];
					if (targetHc) {
						targetHc.trigger(hcEvents.receiveIce, { iceCandidate: data.iceCandidate });
					}
				}
			});

			hc.on(hcEvents.sendOffer, proxy(function (tUserId, tConnId, connId, sd) {
				serverConnector.sendOffer(tUserId, tConnId, connId, sd);
			}))
			.on(hcEvents.sendAnswer, proxy(function (tUserId, tConnId, connId, sd) {
				serverConnector.sendAnswer(tUserId, tConnId, connId, sd);
			}))
			.on(hcEvents.sendIce, proxy(function (tUserId, tConnId, connId, sd) {
				serverConnector.sendIce(tUserId, tConnId, connId, sd);
			}))
			.on(hcEvents.sendBye, proxy(function (tUserId, tConnId, connId) {
				serverConnector.sendBye(tUserId, tConnId, connId);
			}));

			connection.on(xrtc.Connection.events.connectionClosed, function () {
				connections.splice(getConnectionIndexById(connections, connectionId), 1);
</code></pre>
						</td>
					</tr>
					<tr id="section_24">
						<td class="docs">
							<div class="pilwrap">
								<a class="pilcrow" href="#section_24">&#182;</a>
							</div>
							<p>todo: maybe need to unsubscribe this handshake controllers from all events</p>

						</td>
						<td class="code">
							<pre><code class='prettyprint'>				delete handshakeControllers[connectionId];
			});

			connections.push(connection);

			self.trigger(xrtc.Room.events.connectionCreated, { userId: targetUserId, connection: connection });

			if (typeof connectionCreated === &#39;function&#39;) {
				connectionCreated({ connection: connection, handshakeController: hc });
			}
		}
	});

</code></pre>
						</td>
					</tr>
					<tr id="section_25">
						<td class="docs">
							<div class="pilwrap">
								<a class="pilcrow" href="#section_25">&#182;</a>
							</div>
							<p><strong>Note:</strong> Full list of events for the <code>xRtc.Room</code> object.</p>

						</td>
						<td class="code">
							<pre><code class='prettyprint'>	xrtc.Room.extend({
		events: {
			enter: &#39;enter&#39;,
			leave: &#39;leave&#39;,

			incomingConnection: &#39;incomingconnection&#39;,
			connectionCreated: &#39;connectioncreated&#39;,
			connectionDeclined: &#39;connectiondeclined&#39;,

			participantsUpdated: &#39;participantsupdated&#39;,
			participantConnected: &#39;participantconnected&#39;,
			participantDisconnected: &#39;participantdisconnected&#39;,
			tokenInvalid: &#39;tokeninvalid&#39;
		},

		settings: {
			info: {
				domain: exports.document.domain,
				application: &#39;default&#39;,
				name: &#39;default&#39;
			},

			options: {
				autoReply: true
			}
		}
	});
})(window);
</code></pre>
						</td>
					</tr>
			</tbody>
		</table>
	</div>
</body>
</html>
