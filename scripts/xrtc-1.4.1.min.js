var xRtc={ajax:{}};
(function(a){"undefined"===typeof a.xRtc&&(a.xRtc={});var b=a.xRtc;b.Ajax={ajax:function(a,d,c,f){var e,r;r=b.Class.proxy(this);try{e=new XMLHttpRequest}catch(u){try{e=new ActiveXObject("Msxml2.XMLHTTP")}catch(n){try{e=new ActiveXObject("Microsoft.XMLHTTP")}catch(x){this._logger&&(r=new b.CommonError("ajax","XMLHttpRequest is not supported"),this._logger.error("ajax",r));return}}}this._logger&&this._logger.debug("ajax",a,c);d=d.toUpperCase();try{var y=!1;"GET"===d?(e.open(d,a+"?"+c,!0),c=""):(e.open(d,
a,!0),e.setRequestHeader("method",d+" "+a+" HTTP/1.1"),e.setRequestHeader("content-type","application/x-www-form-urlencoded"));e.onreadystatechange=r(function(){4!=e.readyState||y||(y=!0,this._logger&&this._logger.debug("ajax",e),"function"===typeof f&&f(e.responseText))});e.send(c)}catch(w){throw r=new b.CommonError("ajax","XMLHttpRequest exception",w),r.data={url:a,method:d,params:c},this._logger&&this._logger.error("ajax",r),r;}}}})(window);xRtc.baseClass={};
(function(a){"undefined"===typeof a.xRtc&&(a.xRtc={});a.xRtc.Class=function(b,l,d){b[l]=d;var c=b[l];c.fn=c.prototype;c.fn.className=l;c.extend=function(b){var d=b.extended;a.xRtc.Class.extend(c,b);d&&d(c)}};a.xRtc.Class.extend=function(b){for(var a=Array.prototype.slice.call(arguments,1),d=0,c=a.length;d<c;d++){var f=a[d],e;for(e in f)b[e]=f[e]}};a.xRtc.Class.property=function(b,a,d,c){"function"===typeof d&&b.__defineGetter__(a,d);"function"===typeof c&&b.__defineSetter__(a,c)};a.xRtc.Class.proxy=
function(b){return function(a){var d=[];1<arguments.length&&(d=Array.prototype.slice.call(arguments,1));return function(){for(var c=Array.prototype.slice.call(arguments),f=0;f<d.length;f++)c.push(d[f]);a.apply(b,c)}}}})(window);xRtc.common={};
(function(a){"undefined"===typeof a.xRtc&&(a.xRtc={});var b=a.xRtc;b.webrtc={getUserMedia:(navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia||navigator.getUserMedia).bind(navigator),RTCPeerConnection:a.mozRTCPeerConnection||a.webkitRTCPeerConnection||a.RTCPeerConnection,RTCIceCandidate:a.mozRTCIceCandidate||a.RTCIceCandidate,RTCSessionDescription:a.mozRTCSessionDescription||a.RTCSessionDescription,URL:a.webkitURL||a.msURL||a.oURL||a.URL,MediaStream:a.mozMediaStream||a.webkitMediaStream||
a.MediaStream,supportedBrowsers:{chrome:"chrome",firefox:"firefox"}};b.webrtc.detectedBrowser=navigator.mozGetUserMedia?b.webrtc.supportedBrowsers.firefox:b.webrtc.supportedBrowsers.chrome;b.webrtc.detectedBrowserVersion=b.webrtc.detectedBrowser===b.webrtc.supportedBrowsers.firefox?parseInt(a.navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1]):parseInt(a.navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./)[2]);xRtc.utils={newGuid:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,
function(b){var d=16*Math.random()|0;return("x"==b?d:d&3|8).toString(16)})}}})(window);xRtc.commonError={};(function(a){"undefined"===typeof a.xRtc&&(a.xRtc={});a=a.xRtc;a.Class(a,"CommonError",function(b,a,d){this.method=b;this.message=a;this.error=d})})(window);xRtc.eventDispatcher={};
(function(a){"undefined"===typeof a.xRtc&&(a.xRtc={});a.xRtc.EventDispatcher={on:function(b,a){this._logger&&this._logger.info("on",arguments);this._events=this._events||{};this._events[b]=this._events[b]||[];this._events[b].push(a);return this},off:function(b){this._logger&&this._logger.info("off",arguments);this._events=this._events||{};this._events[b]=this._events[b]||[];delete this._events[b];return this},trigger:function(b){this._logger&&this._logger.info("trigger",arguments);this._events=this._events||
{};var a=this._events[b];if(!a)return this._logger.warning("trigger","Trying to call event which is not listening. Event name is '"+b+"'"),this;for(var d=Array.prototype.slice.call(arguments,1),c=0,f=a.length;c<f;c++)a[c].apply(null,d);return this}}})(window);xRtc.logger={};
(function(a){"undefined"===typeof a.xRtc&&(a.xRtc={});var b=a.xRtc;b.Class(b,"Logger",function(a){function d(){for(var b=[],a,e=0,r=arguments.length;e<r;e++)if(a=arguments[e],"object"===typeof a&&a instanceof Object&&"undefined"!==typeof a.length){a=d.apply(null,Array.prototype.slice.call(a));for(var l=0,n=a.length;l<n;l++)b.push(a[l])}else b.push(a);return b}b.Class.extend(this,{info:function(c){if(!0===b.Logger.level||"object"===typeof b.Logger.level&&b.Logger.level.info)"string"===typeof c?console.info("Info:\t\t",
a+"."+c,d(Array.prototype.slice.call(arguments,1))):console.info("Info:\t\t",d(Array.prototype.slice.call(arguments)))},debug:function(c){if(!0===b.Logger.level||"object"===typeof b.Logger.level&&b.Logger.level.debug)"string"===typeof c?console.debug("Debug:\t\t",a+"."+c,d(Array.prototype.slice.call(arguments,1))):console.debug("Debug:\t\t",d(Array.prototype.slice.call(arguments)))},test:function(c){if(!0===b.Logger.level||"object"===typeof b.Logger.level&&b.Logger.level.test)"string"===typeof c?
console.debug("Test:\t\t",a+"."+c,d(Array.prototype.slice.call(arguments,1))):console.debug("Test:\t\t",d(Array.prototype.slice.call(arguments)))},warning:function(c){if(!0===b.Logger.level||"object"===typeof b.Logger.level&&b.Logger.level.warning)"string"===typeof c?console.warn("Warning:\t",a+"."+c,d(Array.prototype.slice.call(arguments,1))):console.warn("Warning:\t",d(Array.prototype.slice.call(arguments)))},error:function(c){if(!0===b.Logger.level||"object"===typeof b.Logger.level&&b.Logger.level.error)"string"===
typeof c?console.error("Error:\t\t",a+"."+c,d(Array.prototype.slice.call(arguments,1))):console.error("Error:\t\t",d(Array.prototype.slice.call(arguments)))}})});b.Logger.extend({level:!1,enable:function(b){this.level="undefined"===typeof b?!0:b},disable:function(){this.level=!1}})})(window);xRtc.authManager={};
(function(a){"undefined"===typeof a.xRtc&&(a.xRtc={});var b=a.xRtc;b.Class(b,"AuthManager",function(){function a(b){return["domain="+b.domain,"application="+b.application,"room="+b.room,"username="+b.name,"password="+b.password]}function d(a,d,c){var f=this;try{e.debug("getToken",a);""===a&&(e.error("getToken","Server returned an empty response."),f.trigger(b.AuthManager.events.serverError,"Server returned an empty response."));try{a=JSON.parse(a),e.debug("getToken",a)}catch(l){throw e.error("getToken",a),
l;}if(a&&a.e&&""!=a.e){var w=new b.CommonError("getToken",a.e);e.error("getToken",w);f.trigger(b.AuthManager.events.serverError,w)}else{var s=a.d.token;s?(e.info("getToken",s),"function"===typeof c&&c(s)):(e.error("getToken",a.d),f.trigger(b.AuthManager.events.serverError,a.d))}}catch(k){e.error("getToken. The request will be repeated after "+b.AuthManager.settings.unsuccessfulRequestRepeatTimeout/1E3+" sec.",k),setTimeout(function(){f.getToken(d,c)},b.AuthManager.settings.unsuccessfulRequestRepeatTimeout)}}
function c(a,d,c){var f=this;try{if(a=JSON.parse(a),e.debug("getIceServers",a),a&&a.e&&""!=a.e){var l=new b.CommonError("getIceServers",a.e);e.error("getIceServers",l);f.trigger(b.AuthManager.events.serverError,l)}else{var w=a.d.iceServers?a.d.iceServers.map(function(b){var a={};b.url&&(a.url=b.url);b.credential&&(a.credential=b.credential);b.username&&(a.username=b.username);return a}):[];e.info("getIceServers",w);"function"===typeof c&&c(w)}}catch(s){e.error("getIceServers. The request will be repeated after "+
b.AuthManager.settings.unsuccessfulRequestRepeatTimeout/1E3+" sec.",s),setTimeout(function(){f.getIceServers(d,c)},b.AuthManager.settings.unsuccessfulRequestRepeatTimeout)}}var f=b.Class.proxy(this),e=new b.Logger(this.className);b.Class.extend(this,b.Ajax,b.EventDispatcher,{_logger:e,getToken:function(e,c){var n=b.AuthManager.settings.tokenHandler,x=a.call(this,e).join("&");this.ajax(n,"POST",x,f(d,e,c))},getIceServers:function(d,e){var n=b.AuthManager.settings.iceHandler,x=a.call(this,d).join("&");
this.ajax(n,"POST",x,f(c,d,e))}})});b.AuthManager.extend({events:{serverError:"servererror"},settings:{unsuccessfulRequestRepeatTimeout:5E3,tokenHandler:"https://api.xirsys.com/getToken",iceHandler:"https://api.xirsys.com/getIceServers"}})})(window);xRtc.dataChannel={};
(function(a){"undefined"===typeof a.xRtc&&(a.xRtc={});var b=a.xRtc;b.Class(b,"DataChannel",function(a,d){var c=b.Class.proxy(this),f=new b.Logger(this.className),e=b.DataChannel.events;a.onopen=c(function(b){b={event:b};f.debug("open",b);this.trigger(e.open,b)});a.onmessage=c(function(b){b=JSON.parse(b.data);f.debug("message",b);this.trigger(e.receivedMessage,b)});a.onclose=c(function(b){b={event:b};f.debug("close",b);this.trigger(e.close,b)});a.onerror=c(function(a){a=new b.CommonError("onerror","DataChannel error.",
a);f.error("error",a);this.trigger(e.error,a)});a.ondatachannel=c(function(b){b={event:b};f.debug("datachannel",b);this.trigger(e.dataChannel,b)});b.Class.extend(this,b.EventDispatcher,{_logger:f,send:function(d){f.info("send",arguments);try{var c={message:d};a.send(JSON.stringify(c));this.trigger(e.sentMessage,c)}catch(n){c=new b.CommonError("onerror",'DataChannel sending error. Channel state is "'+this.getState()+'"',n),f.error("error",c),this.trigger(e.error,c)}},getRemoteUser:function(){return d},
getName:function(){return a.label},getState:function(){return a.readyState.toLowerCase()}})});b.DataChannel.extend({events:{open:"open",sentMessage:"sentMessage",receivedMessage:"receivedMessage",close:"close",error:"error",dataChannel:"datachannel"},states:{connecting:"connecting",open:"open",closing:"closing",closed:"closed"}})})(window);xRtc.handshakeController={};
(function(a){"undefined"===typeof a.xRtc&&(a.xRtc={});var b=a.xRtc;b.Class(b,"HandshakeController",function(){var a=new b.Logger(this.className);b.Class.extend(this,b.EventDispatcher,{_logger:a,sendIce:function(a,c,f){this.trigger(b.HandshakeController.events.sendIce,a,c,f)},sendOffer:function(a,c,f){this.trigger(b.HandshakeController.events.sendOffer,a,c,f)},sendAnswer:function(a,c,f){this.trigger(b.HandshakeController.events.sendAnswer,a,c,f)},sendBye:function(a,c,f){this.trigger(b.HandshakeController.events.sendBye,a,
c,f)}})});b.HandshakeController.extend({events:{sendIce:"sendice",sendOffer:"sendoffer",sendAnswer:"sendanswer",sendBye:"sendbye",receiveIce:"receiveice",receiveOffer:"receiveoffer",receiveAnswer:"receiveanswer",receiveBye:"receivebye"}})})(window);xRtc.serverConnector={};
(function(a){"undefined"===typeof a.xRtc&&(a.xRtc={});var b=a.xRtc;b.Class(b,"ServerConnector",function(l){function d(a){if(!z){var d=new b.CommonError("send","Trying to call method without established connection","WebSocket is not connected!");k.error("send",d);throw d;}d={eventName:a.eventName};"undefined"!==typeof a.data&&(d.data=a.data);"undefined"!==typeof a.targetUserId&&(d.targetUserId=a.targetUserId.toString());a=JSON.stringify(d);k.debug("send",d,a);z.send(a)}function c(a,d){try{if(a=JSON.parse(a),
k.debug("getWebSocketURL",a),a&&a.e&&""!=a.e){var e=new b.CommonError("getWebSocketURL","Error occured while getting the URL of WebSockets",a.e);k.error("getWebSocketURL",e);this.trigger(g.serverError,{error:e})}else{var n=a.d.value;k.info("getWebSocketURL",n);"function"===typeof d&&d(n)}}catch(f){this.ajax(b.ServerConnector.settings.URL,"POST","",s(c,d))}}function f(b,a){z=new WebSocket(b+"/ws/"+encodeURIComponent(a));z.onopen=s(e);z.onclose=s(r);z.onerror=s(u);z.onmessage=s(n)}function e(b){b={event:b};
k.debug("open",b);q&&(t=w.call(this,q));this.trigger(g.connectionOpen,b)}function r(b){t&&(a.clearInterval(t),t=null);b={event:b};k.debug("close",b);this.trigger(g.connectionClose,b);z=null}function u(a){a=new b.CommonError("onerror","WebSocket has got an error",a);k.error("error",a);this.trigger(g.connectionError,{error:a})}function n(b){var a={message:b};k.debug("message",a);this.trigger(g.message,a);if(x(b))if(b=y(b),a=b.type,a==g.usersUpdated||a==g.userConnected||a==g.userDisconnected)if(a==g.usersUpdated){for(var a=
[],d=0,e=b.message.users.length;d<e;d++)a.push({id:b.message.users[d],name:b.message.users[d]});this.trigger(g.usersUpdated,{users:a})}else a==g.userConnected?this.trigger(g.userConnected,{user:{id:b.message,name:b.message}}):a==g.userDisconnected&&this.trigger(g.userDisconnected,{user:{id:b.message,name:b.message}});else if(a==g.receiveOffer||a==g.receiveAnswer||a==g.receiveIce||a==g.receiveBye)a==g.receiveOffer?this.trigger(g.receiveOffer,{senderId:b.userid,receiverId:b.message.targetUserId,connectionId:b.message.data.connectionId,
offer:b.message.data.offer.offer,iceServers:b.message.data.offer.iceServers,connectionType:b.message.data.offer.connectionType,connectionData:b.message.data.offer.connectionData}):a==g.receiveAnswer?this.trigger(g.receiveAnswer,{senderId:b.userid,connectionId:b.message.data.connectionId,answer:b.message.data.answer.answer,acceptData:b.message.data.answer.acceptData}):a==g.receiveIce?this.trigger(g.receiveIce,{senderId:b.userid,connectionId:b.message.data.connectionId,iceCandidate:b.message.data.iceCandidate}):
a==g.receiveBye&&this.trigger(g.receiveBye,{senderId:b.userid,connectionId:b.message.data.connectionId,byeData:b.message.data.byeData})}function x(b){var a=!0;'"Token invalid"'===b.data&&(a=!1,this.trigger(g.tokenInvalid,{token:A}));return a}function y(a){var d;try{d=JSON.parse(a.data)}catch(e){d=null;var c=new b.CommonError("parseServerMessage","Message format error",e);k.error("parseServerMessage",c,a);this.trigger(g.messageFormatError,{error:c})}return d}function w(b){return a.setInterval(function(){d.call(this,
{})},b)}var s=b.Class.proxy(this),k=new b.Logger(this.className),z=null,A=null,q=l?l.pingInterval:5E3,t=null,g=b.ServerConnector.events;b.Class.extend(this,b.EventDispatcher,b.Ajax,{_logger:k,connect:function(a){A=a;a=s(f,a);this.ajax(b.ServerConnector.settings.URL,"POST","",s(c,a))},disconnect:function(){z?(z.close(),A=z=null,k.info("disconnect","Connection with WS has been broken")):k.debug("disconnect","Connection with WS has not been established yet")},sendOffer:function(b,a,e){d({eventName:g.receiveOffer,
targetUserId:b,data:{connectionId:a,offer:e||{}}})},sendAnswer:function(b,a,e){d({eventName:g.receiveAnswer,targetUserId:b,data:{connectionId:a,answer:e||{}}})},sendIce:function(b,a,e){d({eventName:g.receiveIce,targetUserId:b,data:{connectionId:a,iceCandidate:e}})},sendBye:function(b,a,e){d({eventName:g.receiveBye,targetUserId:b,data:{connectionId:a,byeData:e||{}}})}})});b.ServerConnector.extend({events:{connectionOpen:"connectionopen",connectionClose:"connectionclose",connectionError:"connectionerror",
message:"message",messageFormatError:"messageformaterror",serverError:"servererror",tokenInvalid:"tokeninvalid",receiveOffer:"receiveoffer",receiveAnswer:"receiveanswer",receiveIce:"receiveice",receiveBye:"receivebye",usersUpdated:"peers",userConnected:"peer_connected",userDisconnected:"peer_removed"},settings:{URL:"https://api.xirsys.com/wsList"}})})(window);xRtc.stream={};
(function(a,b){var l=b.webrtc;b.Class(b,"Stream",function(d){function c(){if(l.detectedBrowser===l.supportedBrowsers.firefox&&22>l.detectedBrowserVersion)throw new b.CommonError("setVideoEnabled","Media track muting is not supported if your Firefox browser version less then 22.");}var f=b.Class.proxy(this),e=new b.Logger(this.className),r=b.Stream.events,u=null;b.Class.property(this,"videoEnabled",function(){var b=d.getVideoTracks();return this.videoAvailable&&b[0].enabled},function(b){c();for(var a=
d.getVideoTracks(),e=0,f=a.length;e<f;e++)a[e].enabled=b});b.Class.property(this,"audioEnabled",function(){var b=d.getAudioTracks();return this.audioAvailable&&b[0].enabled},function(b){c();for(var a=d.getAudioTracks(),e=0,f=a.length;e<f;e++)a[e].enabled=b});b.Class.property(this,"videoAvailable",function(){return 0<d.getVideoTracks().length});b.Class.property(this,"audioAvailable",function(){return 0<d.getAudioTracks().length});d.onended=f(function(b){b={id:b.srcElement.id};e.debug("ended",b);this.trigger(r.ended,
b)});b.Class.extend(this,b.EventDispatcher,{_logger:e,getStream:function(){return d},stop:function(){d.stop()},getId:function(){u||(u=d.id?d.id:b.utils.newGuid());return u},getURL:function(){return l.URL.createObjectURL(d)},assignTo:function(b){this.videoAvailable||this.audioAvailable||0<d.currentTime?(l.detectedBrowser===l.supportedBrowsers.firefox?b.mozSrcObject=d:b.src=this.getURL(),b.play()):a.setTimeout(f(this.assignTo,b),100)}})});b.Stream.extend({events:{ended:"ended"}})})(window,xRtc);xRtc.connection={};
(function(a){"undefined"===typeof a.xRtc&&(a.xRtc={});var b=a.xRtc,l={},d=b.webrtc;b.Class(l,"IceCandidateFilter",function(a,d){var e=a||b.Connection.connectionTypes["default"],l=/(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})/g;b.Class.extend(this,{getType:function(){return e},filterCandidate:function(a){var c=null;if(e===b.Connection.connectionTypes["default"])c=a;else if(e===b.Connection.connectionTypes.direct&&(u.isLocal(a)||u.isStun(a)))c=a;else if(e===b.Connection.connectionTypes.server)if(u.isTurn(a))c=a;
else if(u.isStun(a)){var c=null,y;y=null;if(d)for(var w=0;w<d.length;w++){var s=d[w];0===s.url.indexOf("turn:")&&(y=-1!==s.url.indexOf("@")?s.url.split("@")[1]:s.url.split("turn:")[1])}y&&(c=a,c.candidate=a.candidate.replace(l,y),c.candidate=a.candidate.replace("typ srflx","typ relay"))}return c},filterSDP:function(a){var d=a;e===b.Connection.connectionTypes.server?d=a.replace(/a=candidate:.*((typ host)|(typ srflx)).*\r\n/g,""):e===b.Connection.connectionTypes.direct&&(d=a.replace(/a=candidate:.*typ relay.*\r\n/g,
""));return d}});var u={isLocal:function(b){return/typ host/.test(b.candidate)},isStun:function(b){return/typ srflx/.test(b.candidate)},isTurn:function(b){return/typ relay/.test(b.candidate)}}});b.Class(b,"Connection",function(c,f,e,r,u,n){function x(a){var d=new b.CommonError(a,"The method can be called on '"+b.Room.events.connectionCreated+"' event of the xRtc.Room. Use xRtc.Room.events.connectionCreated for access the event name.");m.error(a,d)}function y(c,f){function l(){if("function"===typeof f)try{f()}catch(b){}}
function n(b){function a(b,d){var e=b;b[b.length-1]===d&&(e=b.substring(0,b.length-1));return e}for(var e=[],c=function(b){var e;if(d.detectedBrowser==d.supportedBrowsers.chrome){var c=b.url;e=b.username;b=b.credential;var h=null,v=c.split(":");0===v[0].indexOf("stun")?h={url:a(c,"/")}:0===v[0].indexOf("turn")&&(28>d.detectedBrowserVersion?(c=c.split("turn:"),h={url:"turn:"+e+"@"+c[1],credential:b}):h={url:a(c,"/"),credential:b,username:e})}else c=b.url,e=b.username,b=b.credential,h=null,v=c.split(":"),
0===v[0].indexOf("stun")?h={url:a(c,"/")}:0!==v[0].indexOf("turn")||-1===c.indexOf("transport=udp")&&-1!==c.indexOf("?transport")||(c=c.split("?"),h={url:a(c[0],"/"),credential:b,username:e});return e=h},h=0,v=b.length;h<v;h++){var G=c(b[h]);G&&e.push(G)}return e}function r(c){var v=this;c=n(c);h=new d.RTCPeerConnection(c&&0<c.length?{iceServers:c}:null,b.Connection.settings.peerConnectionOptions);m.info("initPeerConnection","PeerConnection created.");h.onicecandidate=p(function(b){b.candidate&&(m.debug("peerConnection.onIceCandidate",
b.candidate),b=JSON.parse(JSON.stringify(b.candidate)),b=K.filterCandidate(b),null!==b&&(L.push(b),O&&s.call(this)))});h.onstatechange=h.onsignalingstatechange=p(function(a){m.debug("onConnectionStateChange",a);this.trigger(b.Connection.events.stateChanged,{connection:this,state:this.getState()})});if(d.detectedBrowser===d.supportedBrowsers.firefox&&24>d.detectedBrowserVersion){var f=this.getState();P=a.setInterval(function(){var a=v.getState();a!=f&&(m.debug("setInterval -> xrtc.Connection.events.stateChanged",
a),f=a,v.trigger(b.Connection.events.stateChanged,{connection:v,state:f}))},500)}h.onicechange=h.oniceconnectionstatechange=p(function(d){d=H.call(v);m.debug("onIceStateChange",(new Date).getTime(),d);E&&(m.debug("onIceStateChange",(new Date).getTime(),"checkDisconnectedIceStateTimeout are clearing. ID = '"+E+"'"),a.clearTimeout(E),E=null,m.debug("onIceStateChange",(new Date).getTime(),"checkDisconnectedIceStateTimeout was cleared. ID = '"+E+"'"));"connected"===d?v.trigger(b.Connection.events.connectionEstablished,
{connection:v,user:e}):"disconnected"===d&&(m.debug("onIceStateChange",(new Date).getTime(),"checkDisconnectedIceStateTimeout(10sec.) was started."),E=a.setTimeout(function(){m.debug("onIceStateChange",(new Date).getTime(),"ice state equals 'disconnected' so closePeerConnection was called. Timeout is 10sec and it is expired.");g.call(v);a.clearInterval(E);E=null},1E4),m.debug("onIceStateChange",(new Date).getTime(),"checkDisconnectedIceStateTimeout ID ='"+E+"'"))});h.ondatachannel=function(a){a=new b.DataChannel(a.channel,
e);I.push(a);v.trigger(b.Connection.events.dataChannelCreated,{connection:v,channel:a})};h.onaddstream=p(function(a){a=new b.Stream(a.stream);D.push(a);a={user:e,connection:this,stream:a};m.debug("addRemoteStream",a);this.trigger(b.Connection.events.remoteStreamAdded,a)});h.onclosedconnection=function(b){m.debug("peerConnection.onclosedconnection",b);g.call(v)};c=0;for(var k=B.length;c<k;c++)h.addStream(B[c].getStream());c=0;for(k=G.length;c<k;c++)w.call(this,G[c]);l()}e=c;h?l():k.call(this,p(r))}
function w(a){try{var c=h.createDataChannel(a,d.detectedBrowser===d.supportedBrowsers.chrome?{reliable:!1}:{}),f=new b.DataChannel(c,e);I.push(f);this.trigger(b.Connection.events.dataChannelCreated,{connection:this,channel:f})}catch(G){c=new b.CommonError("createDataChannel","Can't create DataChannel.",G),m.error("createDataChannel",c),this.trigger(b.Connection.events.dataChannelCreationError,{connection:this,channelName:a,error:c})}}function s(){m.debug("sendIceCandidates",'Sending "'+L.length+'" ice candidates.');
for(var a=0,d=L.length;a<d;a++){var c=L[a];M.sendIce(e.id,N,JSON.stringify(c));this.trigger(b.Connection.events.iceSent,{connection:this,iceCandidate:c})}L=[]}function k(b){"function"===typeof b&&(F?b(F):C.getIceServers(J,function(a){F=a;b(F)}))}function z(a){m.debug("Ice candidate was received.",a);a=new d.RTCIceCandidate(JSON.parse(a.iceCandidate));h.addIceCandidate(a);this.trigger(b.Connection.events.iceAdded,{connection:this,iceCandidate:a})}function A(a){this.trigger(b.Connection.events.offerReceived,
{connection:this,user:e,offerData:a});this.trigger(b.Connection.events.connectionOpening,{connection:this,user:e});m.debug("Offer was received.",a);F=a.iceServers;y.call(this,e,p(function(){m.debug("receiveOffer",a);K=new l.IceCandidateFilter(a.connectionType,F);var c=JSON.parse(a.offer),c=new d.RTCSessionDescription(c);h.setRemoteDescription(c);h.createAnswer(p(function(c){d.detectedBrowser===d.supportedBrowsers.firefox&&(c.sdp=K.filterSDP(c.sdp));h.setLocalDescription(c);var f={answer:JSON.stringify(c),
acceptData:a.acceptData};m.debug("sendAnswer",a,c);M.sendAnswer(e.id,N,f);this.trigger(b.Connection.events.answerSent,{connection:this,user:e,answerData:f});this.trigger(b.Connection.events.connectionEstablishing,{connection:this,user:e});O=!0;s.call(this)}),p(function(a){a=new b.CommonError("sendAnswer","Cannot create WebRTC answer",a);m.error("sendAnswer",a);this.trigger(b.Connection.events.createAnswerError,{connection:this,error:a})}),b.Connection.settings.answerOptions)}))}function q(a){m.debug("Answer was received.",
a);O=!0;s.call(this);a=JSON.parse(a.answer);a=new d.RTCSessionDescription(a);h.setRemoteDescription(a);this.trigger(b.Connection.events.answerReceived,{connection:this,user:e,answerData:{answer:a}});this.trigger(b.Connection.events.connectionEstablishing,{connection:this,user:e})}function t(){g.call(this)}function g(){d.detectedBrowser===d.supportedBrowsers.firefox&&P&&(a.clearInterval(P),P=null);if(h){h.onicecandidate=null;h.close();h=null;L=[];F=null;Q=O=!1;var c={connection:this,user:e};e=null;
this.trigger(b.Connection.events.connectionClosed,c)}}function H(){return h&&(h.iceConnectionState||h.iceState)||"notinitialized"}var p=b.Class.proxy(this),m=new b.Logger(this.className),J=f,C=u||new xRtc.AuthManager,B=[],D=[],I=[],G=[],h=null,P=null,E=null,M=r,K=null,F=null,O=!1,L=[],N=c,Q=!1;(function(){var a=b.HandshakeController.events;M.on(a.receiveIce,p(z)).on(a.receiveOffer,p(A)).on(a.receiveAnswer,p(q)).on(a.receiveBye,p(t))}).call(this);b.Class.extend(this,b.EventDispatcher,{_logger:m,getId:function(){return N},
getRemoteUser:function(){return e},_open:function(a){Q=!0;var c=this,f={};b.Class.extend(f,b.Connection.settings.offerOptions);a&&a.offer&&b.Class.extend(f,a.offer);c.trigger(b.Connection.events.connectionOpening,{connection:c,user:e});y.call(c,e,function(){K=new l.IceCandidateFilter(a&&a.connectionType||null,F);h.createOffer(p(function(a){if(h){d.detectedBrowser===d.supportedBrowsers.firefox&&(a.sdp=K.filterSDP(a.sdp));m.debug("onCreateOfferSuccess",a);h.setLocalDescription(a);d.detectedBrowser===
d.supportedBrowsers.firefox&&21>=d.detectedBrowserVersion&&(a.sdp=-1==a.sdp.indexOf("a=crypto")?a.sdp.replace(/c=IN/g,"a=crypto:1 AES_CM_128_HMAC_SHA1_80 inline:FakeFakeFakeFakeFakeFakeFakeFakeFakeFake\r\nc=IN"):a.sdp);var f={offer:JSON.stringify(a),connectionData:n,connectionType:K.getType(),iceServers:F};m.debug("sendOffer",e.id,a);M.sendOffer(e.id,N,f);c.trigger(b.Connection.events.offerSent,{connection:this,user:e,offerData:f})}}),p(function(a){a=new b.CommonError("startSession","Cannot create WebRTC offer",
a);m.error("onCreateOfferError",a);c.trigger(b.Connection.events.createOfferError,{connection:c,error:a})}),f)})},close:function(b){M&&e&&M.sendBye(e.id,N,b);g.call(this)},addStream:function(a){Q&&x("addStream");B.push(a);a={connection:this,stream:a,user:{id:J.name,name:J.name}};m.debug("addLocalStream",a);this.trigger(b.Connection.events.localStreamAdded,a)},createDataChannel:function(b){Q&&x("createDataChannel");G.push(b)},getData:function(){return n},getState:function(){var b=0<B.length;return{notinitialized:b?
"ready":"not-ready","new":b?"ready":"not-ready",opening:"connecting",active:"connected",closing:"disconnecting",closed:b?"ready":"not-ready",stable:"connected","have-local-offer":"ready","have-remote-offer":"connecting"}[h&&(h.signalingState||h.readyState)||"notinitialized"]},getLocalStreams:function(){return B.map(function(b){return b})},getRemoteStreams:function(){return D.map(function(b){return b})},getDataChannels:function(){return I.map(function(b){return b})}})});b.Connection.extend({events:{connectionOpening:"connectionopening",
connectionEstablishing:"connectionestablishing",connectionEstablished:"connectionestablished",connectionClosed:"connectionclosed",localStreamAdded:"localstreamadded",remoteStreamAdded:"remotestreamadded",dataChannelCreated:"datachannelcreated",dataChannelCreationError:"datachannelcreationerror",stateChanged:"statechanged",createOfferError:"createoffererror",offerSent:"offersent",offerReceived:"offerreceived",createAnswerError:"createanswererror",answerSent:"answersent",answerReceived:"answerreceived",
iceSent:"icesent",iceAdded:"iceadded"},connectionTypes:{"default":"default",direct:"direct",server:"server"},settings:{offerOptions:{optional:[],mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}},answerOptions:{optional:[],mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}},peerConnectionOptions:{optional:[{RtpDataChannels:!0},{DtlsSrtpKeyAgreement:!0}]}}});d.RTCPeerConnection.prototype&&!d.RTCPeerConnection.prototype.getLocalStreams&&b.Class.extend(d.RTCPeerConnection.prototype,{getLocalStreams:function(){return this.localStreams},
getRemoteStreams:function(){return this.remoteStreams}});d.MediaStream.prototype.getVideoTracks||(d.detectedBrowser===d.supportedBrowsers.firefox?b.Class.extend(d.MediaStream.prototype,{getVideoTracks:function(){return[]},getAudioTracks:function(){return[]}}):b.Class.extend(d.MediaStream.prototype,{getVideoTracks:function(){return this.videoTracks},getAudioTracks:function(){return this.audioTracks}}))})(window);xRtc.room={};
(function(a){"undefined"===typeof a.xRtc&&(a.xRtc={});var b=a.xRtc;b.Class(b,"Room",function(a,d,c){function f(){var a=this;g||(C.on(q.connectionOpen,k(function(a){this.trigger(b.Room.events.enter)})).on(q.connectionClose,k(function(a){this.trigger(b.Room.events.leave)})).on(q.tokenInvalid,k(function(a){this.trigger(b.Room.events.tokenInvalid,a)})).on(q.usersUpdated,k(function(a){t=a.users;t.sort(n);this.trigger(b.Room.events.usersUpdated,{users:this.getUsers()})})).on(q.userConnected,k(function(a){t.push(a.user);
t.sort(n);this.trigger(b.Room.events.userConnected,{user:a.user})})).on(q.userDisconnected,k(function(a){t.splice(s(t,a.user.id),1);t.sort(n);this.trigger(b.Room.events.userDisconnected,{user:a.user})})).on(q.receiveOffer,k(e)).on(q.receiveBye,k(r)).on(q.receiveAnswer,function(c){if(c.senderId&&c.connectionId){var d=x(c.senderId);if(d){var e=D[c.connectionId];e?e.userId===d.id&&(a.trigger(b.Room.events.connectionAccepted,{user:d,connection:y(c.connectionId),data:c.acceptData}),e.hc.trigger(A.receiveAnswer,
{connectionId:c.connectionId,answer:c.answer})):C.sendBye(c.senderId,c.connectionId,{type:I.decline,data:"Remote connection not found."})}}}).on(q.receiveIce,function(b){if(b.senderId&&b.connectionId){var a=D[b.connectionId];a&&a.userId===b.senderId&&a.hc.trigger(A.receiveIce,{iceCandidate:b.iceCandidate,connectionId:b.connectionId})}}),g=!0)}function e(a){function c(b){u.call(e,a.connectionId,m,x(a.senderId),a.connectionData,function(c){c.handshakeController.trigger(A.receiveOffer,{offer:a.offer,
iceServers:a.iceServers,connectionType:a.connectionType,connectionId:a.connectionId,connectionData:a.connectionData,acceptData:b})})}function d(b){C.sendBye(a.senderId,a.connectionId,{type:I.decline,data:b})}if(a.senderId&&a.connectionId){var e=this,f={user:x(a.senderId)};H.autoReply||(f.data=a.connectionData,f.accept=k(c),f.decline=k(d));D[a.connectionId]={userId:a.senderId,hc:null};this.trigger(b.Room.events.incomingConnection,f);H.autoReply&&c.call(e)}}function r(a){if(a.senderId&&a.connectionId){var c=
x(a.senderId);if(c){var d=D[a.connectionId];d&&d.userId===c.id&&((a.byeData&&a.byeData.type===I.decline||!d.hc)&&this.trigger(b.Room.events.connectionDeclined,{user:c,connection:y(a.connectionId),data:a.byeData}),d.hc&&d.hc.trigger(A.receiveBye))}}}function u(a,c,d,e,f){var g=new b.HandshakeController;c=new xRtc.Connection(a,c,d,g,J,e);D[a]?D[a].hc=g:D[a]={userId:d.id,hc:g};g.on(A.sendOffer,k(function(a,b,c){C.sendOffer(a,b,c)})).on(A.sendAnswer,k(function(a,b,c){C.sendAnswer(a,b,c)})).on(A.sendIce,
k(function(a,b,c){C.sendIce(a,b,c)})).on(A.sendBye,k(function(a,b,c){C.sendBye(a,b,c)}));c.on(b.Connection.events.connectionClosed,function(){B.splice(w(B,a),1);delete D[a]});B.push(c);this.trigger(b.Room.events.connectionCreated,{user:d,connection:c});"function"===typeof f&&f({connection:c,handshakeController:g})}function n(a,b){var c=0;a.name<b.name?c=-1:a.name>b.name&&(c=1);return c}function x(a){for(var b=null,c=0,d=t.length;c<d;c++)if(t[c].id===a){b=t[c];break}return b}function y(a){for(var b=
null,c=0,d=B.length;c<d;c++)if(B[c].getId()===a){b=B[c];break}return b}function w(a,b){for(var c=-1,d=0,e=a.length;d<e;d++)if(a[d].getId()===b){c=d;break}return c}function s(a,b){for(var c=-1,d=0,e=a.length;d<e;d++)a[d].id===b&&(c=d);return c}var k=b.Class.proxy(this),z=new b.Logger(this.className),A=b.HandshakeController.events,q=b.ServerConnector.events,t=[],g=!1,H={},p={},m=null,J=d||new xRtc.AuthManager,C=c||new b.ServerConnector,B=[],D={},I={decline:"decline"};b.Class.extend(p,b.Room.settings.info);
"string"===typeof a?p.name=a:b.Class.extend(p,a);b.Class.extend(this,b.EventDispatcher,{_logger:z,enter:function(a,c){var d="",e="";if(!a)throw new b.CommonError("enter","User credentials should be specified.");"string"===typeof a?d=a:(d=a.username,e=a.password);f.call(this);b.Class.extend(H,b.Room.settings.enterOptions);c&&b.Class.extend(H,c);m={domain:p.domain,application:p.application,room:p.name,name:d,password:e};J.getToken(m,function(a){p.user={id:null,name:d};C.connect(a)})},leave:function(){C.on(b.ServerConnector.events.connectionClose,
function(){g&&(C.off(q.connectionOpen).off(q.connectionClose).off(q.tokenInvalid).off(q.usersUpdated).off(q.userConnected).off(q.userDisconnected).off(q.receiveOffer).off(q.receiveBye).off(q.receiveAnswer).off(q.receiveIce),g=!1);H={};m=null;p.user=null;t=[];B=[];D={}});C.disconnect()},connect:function(a,c){if(!p.user)throw new b.CommonError("connect","Need to enter the room before you connect someone.");var d=x(a);if(null==d)d=b.CommonError("connect","Target user not found."),this.trigger(b.Room.events.error,
{userId:a,error:d});else{var e=c&&c.data?c.data:null;u.call(this,b.utils.newGuid(),m,d,e,function(a){a=a.connection;c&&"auto"===c.createDataChannel&&a.createDataChannel("autoDataChannel");a._open(c)})}},getInfo:function(){return p},getConnections:function(){return B.map(function(a){return a})},getUsers:function(){return t.map(function(a){return a})}})});b.Room.extend({events:{enter:"enter",leave:"leave",incomingConnection:"incomingconnection",connectionCreated:"connectioncreated",connectionAccepted:"connectionaccepted",
connectionDeclined:"connectiondeclined",usersUpdated:"usersupdated",userConnected:"userconnected",userDisconnected:"userdisconnected",tokenInvalid:"tokeninvalid",error:"error"},settings:{info:{domain:a.document.domain,application:"default",name:"default"},enterOptions:{autoReply:!0}}})})(window);xRtc.userMedia={};
(function(a){"undefined"===typeof a.xRtc&&(a.xRtc={});var b=a.xRtc,l=b.webrtc,d=new b.Logger("UserMedia"),c=function(a,c,d){l.getUserMedia(a,function(a){"function"===typeof c&&c(new b.Stream(a))},function(a){"function"===typeof d&&d(a)})};b.getUserMedia=function(a,e,r){if(a&&!a.video&&!a.audio){var u=new b.CommonError("getUserMedia","video or audio property of the options parameter should be specified. No sense to create media stream without video and audio components.");d.error("onCreateOfferError",u)}var n=
a||{video:!0,audio:!0};n.video&&n.video.mandatory&&"screen"===n.video.mandatory.mediaSource?c.call(this,{video:{mandatory:{chromeMediaSource:"screen"}}},function(a){n.audio?c.call(this,{audio:!0},function(b){function c(a,b){for(var d=0;d<b.length;d++)a.push(b[d])}var d=[];c(d,b.getAudioTracks());c(d,a.getVideoTracks());e(new l.MediaStream(d))},r):e(a)},r):c.call(this,n,e,r)}})(window);
