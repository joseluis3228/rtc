var xRtc={ajax:{}};
(function(a){"undefined"===typeof a.xRtc&&(a.xRtc={});var b=a.xRtc;b.Ajax={ajax:function(a,c,d,f){var e,p;p=b.Class.proxy(this);try{e=new XMLHttpRequest}catch(t){try{e=new ActiveXObject("Msxml2.XMLHTTP")}catch(n){try{e=new ActiveXObject("Microsoft.XMLHTTP")}catch(w){this._logger&&(p=new b.CommonError("ajax","XMLHttpRequest is not supported"),this._logger.error("ajax",p));return}}}this._logger&&this._logger.debug("ajax",a,d);c=c.toUpperCase();try{var x=!1;"GET"===c?(e.open(c,a+"?"+d,!0),d=""):(e.open(c,
a,!0),e.setRequestHeader("method",c+" "+a+" HTTP/1.1"),e.setRequestHeader("content-type","application/x-www-form-urlencoded"));e.onreadystatechange=p(function(){4!=e.readyState||x||(x=!0,this._logger&&this._logger.debug("ajax",e),"function"===typeof f&&f(e.responseText))});e.send(d)}catch(v){throw p=new b.CommonError("ajax","XMLHttpRequest exception",v),p.data={url:a,method:c,params:d},this._logger&&this._logger.error("ajax",p),p;}}}})(window);xRtc.baseClass={};
(function(a){"undefined"===typeof a.xRtc&&(a.xRtc={});a.xRtc.Class=function(b,l,c){b[l]=c;var d=b[l];d.fn=d.prototype;d.fn.className=l;d.extend=function(b){var c=b.extended;a.xRtc.Class.extend(d,b);c&&c(d)}};a.xRtc.Class.extend=function(b){for(var a=Array.prototype.slice.call(arguments,1),c=0,d=a.length;c<d;c++){var f=a[c],e;for(e in f)b[e]=f[e]}};a.xRtc.Class.property=function(b,a,c,d){"function"===typeof c&&b.__defineGetter__(a,c);"function"===typeof d&&b.__defineSetter__(a,d)};a.xRtc.Class.proxy=
function(b){return function(a){var c=[];1<arguments.length&&(c=Array.prototype.slice.call(arguments,1));return function(){for(var d=Array.prototype.slice.call(arguments),f=0;f<c.length;f++)d.push(c[f]);a.apply(b,d)}}}})(window);xRtc.common={};
(function(a){"undefined"===typeof a.xRtc&&(a.xRtc={});var b=a.xRtc;b.webrtc={getUserMedia:(navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia||navigator.getUserMedia).bind(navigator),RTCPeerConnection:a.mozRTCPeerConnection||a.webkitRTCPeerConnection||a.RTCPeerConnection,RTCIceCandidate:a.mozRTCIceCandidate||a.RTCIceCandidate,RTCSessionDescription:a.mozRTCSessionDescription||a.RTCSessionDescription,URL:a.webkitURL||a.msURL||a.oURL||a.URL,MediaStream:a.mozMediaStream||a.webkitMediaStream||
a.MediaStream,supportedBrowsers:{chrome:"chrome",firefox:"firefox"}};b.webrtc.detectedBrowser=navigator.mozGetUserMedia?b.webrtc.supportedBrowsers.firefox:b.webrtc.supportedBrowsers.chrome;b.webrtc.detectedBrowserVersion=b.webrtc.detectedBrowser===b.webrtc.supportedBrowsers.firefox?parseInt(a.navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1]):parseInt(a.navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./)[2]);b.webrtc.supports=function(){if("undefined"===typeof b.webrtc.RTCPeerConnection)return{};
var a=!1,c=!1,d=!1,f;try{f=new b.webrtc.RTCPeerConnection(null,{optional:[{RtpDataChannels:!0}]});a=!0;try{f.createDataChannel("_XRTCTEST",{reliable:!1});var c=!0,e=new b.webrtc.RTCPeerConnection(null,{});try{d=e.createDataChannel("_XRTCRELIABLETEST",{reliable:!0}).reliable}catch(p){}e.close()}catch(t){}}catch(n){}f&&f.close();return{media:a,data:c,sctp:d}}();xRtc.utils={newGuid:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(b){var c=16*Math.random()|0;return("x"==
b?c:c&3|8).toString(16)})}}})(window);xRtc.commonError={};(function(a){"undefined"===typeof a.xRtc&&(a.xRtc={});a=a.xRtc;a.Class(a,"CommonError",function(b,a,c){this.method=b;this.message=a;this.error=c})})(window);xRtc.eventDispatcher={};
(function(a){"undefined"===typeof a.xRtc&&(a.xRtc={});a.xRtc.EventDispatcher={on:function(b,a){this._logger&&this._logger.info("on",arguments);this._events=this._events||{};this._events[b]=this._events[b]||[];this._events[b].push(a);return this},off:function(b){this._logger&&this._logger.info("off",arguments);this._events=this._events||{};this._events[b]=this._events[b]||[];delete this._events[b];return this},trigger:function(b){this._logger&&this._logger.info("trigger",arguments);this._events=this._events||
{};var a=this._events[b];if(!a)return this._logger.warning("trigger","Trying to call event which is not listening. Event name is '"+b+"'"),this;for(var c=Array.prototype.slice.call(arguments,1),d=0,f=a.length;d<f;d++)a[d].apply(null,c);return this}}})(window);xRtc.logger={};
(function(a){"undefined"===typeof a.xRtc&&(a.xRtc={});var b=a.xRtc;b.Class(b,"Logger",function(a){function c(){for(var b=[],a,e=0,p=arguments.length;e<p;e++)if(a=arguments[e],"object"===typeof a&&a instanceof Object&&"undefined"!==typeof a.length){a=c.apply(null,Array.prototype.slice.call(a));for(var l=0,n=a.length;l<n;l++)b.push(a[l])}else b.push(a);return b}b.Class.extend(this,{info:function(d){if(!0===b.Logger.level||"object"===typeof b.Logger.level&&b.Logger.level.info)"string"===typeof d?console.info("Info:\t\t",
a+"."+d,c(Array.prototype.slice.call(arguments,1))):console.info("Info:\t\t",c(Array.prototype.slice.call(arguments)))},debug:function(d){if(!0===b.Logger.level||"object"===typeof b.Logger.level&&b.Logger.level.debug)"string"===typeof d?console.debug("Debug:\t\t",a+"."+d,c(Array.prototype.slice.call(arguments,1))):console.debug("Debug:\t\t",c(Array.prototype.slice.call(arguments)))},test:function(d){if(!0===b.Logger.level||"object"===typeof b.Logger.level&&b.Logger.level.test)"string"===typeof d?
console.debug("Test:\t\t",a+"."+d,c(Array.prototype.slice.call(arguments,1))):console.debug("Test:\t\t",c(Array.prototype.slice.call(arguments)))},warning:function(d){if(!0===b.Logger.level||"object"===typeof b.Logger.level&&b.Logger.level.warning)"string"===typeof d?console.warn("Warning:\t",a+"."+d,c(Array.prototype.slice.call(arguments,1))):console.warn("Warning:\t",c(Array.prototype.slice.call(arguments)))},error:function(d){if(!0===b.Logger.level||"object"===typeof b.Logger.level&&b.Logger.level.error)"string"===
typeof d?console.error("Error:\t\t",a+"."+d,c(Array.prototype.slice.call(arguments,1))):console.error("Error:\t\t",c(Array.prototype.slice.call(arguments)))}})});b.Logger.extend({level:!1,enable:function(b){this.level="undefined"===typeof b?!0:b},disable:function(){this.level=!1}})})(window);xRtc.authManager={};
(function(a){"undefined"===typeof a.xRtc&&(a.xRtc={});var b=a.xRtc;b.Class(b,"AuthManager",function(){function a(b){return["domain="+b.domain,"application="+b.application,"room="+b.room,"username="+b.name,"password="+b.password]}function c(a,c,d){var f=this;try{e.debug("getToken",a);""===a&&(e.error("getToken","Server returned an empty response."),f.trigger(b.AuthManager.events.serverError,"Server returned an empty response."));try{a=JSON.parse(a),e.debug("getToken",a)}catch(l){throw e.error("getToken",a),
l;}if(a&&a.e&&""!=a.e){var v=new b.CommonError("getToken",a.e);e.error("getToken",v);f.trigger(b.AuthManager.events.serverError,v)}else{var s=a.d.token;s?(e.info("getToken",s),"function"===typeof d&&d(s)):(e.error("getToken",a.d),f.trigger(b.AuthManager.events.serverError,a.d))}}catch(k){e.error("getToken. The request will be repeated after "+b.AuthManager.settings.unsuccessfulRequestRepeatTimeout/1E3+" sec.",k),setTimeout(function(){f.getToken(c,d)},b.AuthManager.settings.unsuccessfulRequestRepeatTimeout)}}
function d(a,c,d){var f=this;try{if(a=JSON.parse(a),e.debug("getIceServers",a),a&&a.e&&""!=a.e){var l=new b.CommonError("getIceServers",a.e);e.error("getIceServers",l);f.trigger(b.AuthManager.events.serverError,l)}else{var v=a.d.iceServers?a.d.iceServers.map(function(b){var a={};b.url&&(a.url=b.url);b.credential&&(a.credential=b.credential);b.username&&(a.username=b.username);return a}):[];e.info("getIceServers",v);"function"===typeof d&&d(v)}}catch(s){e.error("getIceServers. The request will be repeated after "+
b.AuthManager.settings.unsuccessfulRequestRepeatTimeout/1E3+" sec.",s),setTimeout(function(){f.getIceServers(c,d)},b.AuthManager.settings.unsuccessfulRequestRepeatTimeout)}}var f=b.Class.proxy(this),e=new b.Logger(this.className);b.Class.extend(this,b.Ajax,b.EventDispatcher,{_logger:e,getToken:function(e,d){var n=b.AuthManager.settings.tokenHandler,w=a.call(this,e).join("&");this.ajax(n,"POST",w,f(c,e,d))},getIceServers:function(c,e){var n=b.AuthManager.settings.iceHandler,w=a.call(this,c).join("&");
this.ajax(n,"POST",w,f(d,c,e))}})});b.AuthManager.extend({events:{serverError:"servererror"},settings:{unsuccessfulRequestRepeatTimeout:5E3,tokenHandler:"https://api.xirsys.com/getToken",iceHandler:"https://api.xirsys.com/getIceServers"}})})(window);xRtc.dataChannel={};
(function(a){"undefined"===typeof a.xRtc&&(a.xRtc={});var b=a.xRtc;b.Class(b,"DataChannel",function(a,c){var d=b.Class.proxy(this),f=new b.Logger(this.className),e=b.DataChannel.events;a.onopen=d(function(b){b={event:b};f.debug("open",b);this.trigger(e.open,b)});a.onmessage=d(function(b){f.debug("message",b.data);this.trigger(e.receivedMessage,{data:b.data})});a.onclose=d(function(b){b={event:b};f.debug("close",b);this.trigger(e.close,b)});a.onerror=d(function(a){a=new b.CommonError("onerror","DataChannel error.",
a);f.error("error",a);this.trigger(e.error,a)});a.ondatachannel=d(function(b){b={event:b};f.debug("datachannel",b);this.trigger(e.dataChannel,b)});b.Class.extend(this,b.EventDispatcher,{_logger:f,send:function(c){f.info("send",arguments);try{a.send(c)}catch(d){var n=new b.CommonError("onerror",'DataChannel sending error. Channel state is "'+this.getState()+'"',d);f.error("error",n);this.trigger(e.error,n)}this.trigger(e.sentMessage,{data:c})},getRemoteUser:function(){return c},getName:function(){return a.label},
getState:function(){return a.readyState.toLowerCase()}})});b.DataChannel.extend({events:{open:"open",sentMessage:"sentMessage",receivedMessage:"receivedMessage",close:"close",error:"error",dataChannel:"datachannel"},states:{connecting:"connecting",open:"open",closing:"closing",closed:"closed"}})})(window);xRtc.handshakeController={};
(function(a){"undefined"===typeof a.xRtc&&(a.xRtc={});var b=a.xRtc;b.Class(b,"HandshakeController",function(){var a=new b.Logger(this.className);b.Class.extend(this,b.EventDispatcher,{_logger:a,sendIce:function(a,d,f){this.trigger(b.HandshakeController.events.sendIce,a,d,f)},sendOffer:function(a,d,f){this.trigger(b.HandshakeController.events.sendOffer,a,d,f)},sendAnswer:function(a,d,f){this.trigger(b.HandshakeController.events.sendAnswer,a,d,f)},sendBye:function(a,d,f){this.trigger(b.HandshakeController.events.sendBye,a,
d,f)}})});b.HandshakeController.extend({events:{sendIce:"sendice",sendOffer:"sendoffer",sendAnswer:"sendanswer",sendBye:"sendbye",receiveIce:"receiveice",receiveOffer:"receiveoffer",receiveAnswer:"receiveanswer",receiveBye:"receivebye"}})})(window);xRtc.serverConnector={};
(function(a){"undefined"===typeof a.xRtc&&(a.xRtc={});var b=a.xRtc;b.Class(b,"ServerConnector",function(l){function c(a){if(!y){var c=new b.CommonError("send","Trying to call method without established connection","WebSocket is not connected!");k.error("send",c);throw c;}c={eventName:a.eventName};"undefined"!==typeof a.data&&(c.data=a.data);"undefined"!==typeof a.targetUserId&&(c.targetUserId=a.targetUserId.toString());a=JSON.stringify(c);k.debug("send",c,a);y.send(a)}function d(a,c){try{if(a=JSON.parse(a),
k.debug("getWebSocketURL",a),a&&a.e&&""!=a.e){var e=new b.CommonError("getWebSocketURL","Error occured while getting the URL of WebSockets",a.e);k.error("getWebSocketURL",e);this.trigger(h.serverError,{error:e})}else{var f=a.d.value;k.info("getWebSocketURL",f);"function"===typeof c&&c(f)}}catch(n){this.ajax(b.ServerConnector.settings.URL,"POST","",s(d,c))}}function f(b,a){y=new WebSocket(b+"/ws/"+encodeURIComponent(a));y.onopen=s(e);y.onclose=s(p);y.onerror=s(t);y.onmessage=s(n)}function e(b){b={event:b};
k.debug("open",b);r&&(u=v.call(this,r));this.trigger(h.connectionOpen,b)}function p(b){u&&(a.clearInterval(u),u=null);b={event:b};k.debug("close",b);this.trigger(h.connectionClose,b);y=null}function t(a){a=new b.CommonError("onerror","WebSocket has got an error",a);k.error("error",a);this.trigger(h.connectionError,{error:a})}function n(b){var a={message:b};k.debug("message",a);this.trigger(h.message,a);if(w(b))if(b=x(b),a=b.type,a==h.usersUpdated||a==h.userConnected||a==h.userDisconnected)if(a==h.usersUpdated){for(var a=
[],c=0,e=b.message.users.length;c<e;c++)a.push({id:b.message.users[c],name:b.message.users[c]});this.trigger(h.usersUpdated,{users:a})}else a==h.userConnected?this.trigger(h.userConnected,{user:{id:b.message,name:b.message}}):a==h.userDisconnected&&this.trigger(h.userDisconnected,{user:{id:b.message,name:b.message}});else if(a==h.receiveOffer||a==h.receiveAnswer||a==h.receiveIce||a==h.receiveBye)a==h.receiveOffer?this.trigger(h.receiveOffer,{senderId:b.userid,receiverId:b.message.targetUserId,connectionId:b.message.data.connectionId,
offer:b.message.data.offer.offer,iceServers:b.message.data.offer.iceServers,connectionType:b.message.data.offer.connectionType,connectionData:b.message.data.offer.connectionData}):a==h.receiveAnswer?this.trigger(h.receiveAnswer,{senderId:b.userid,connectionId:b.message.data.connectionId,answer:b.message.data.answer.answer,acceptData:b.message.data.answer.acceptData}):a==h.receiveIce?this.trigger(h.receiveIce,{senderId:b.userid,connectionId:b.message.data.connectionId,iceCandidate:b.message.data.iceCandidate}):
a==h.receiveBye&&this.trigger(h.receiveBye,{senderId:b.userid,connectionId:b.message.data.connectionId,byeData:b.message.data.byeData})}function w(b){var a=!0;'"Token invalid"'===b.data&&(a=!1,this.trigger(h.tokenInvalid,{token:z}));return a}function x(a){var c;try{c=JSON.parse(a.data)}catch(e){c=null;var d=new b.CommonError("parseServerMessage","Message format error",e);k.error("parseServerMessage",d,a);this.trigger(h.messageFormatError,{error:d})}return c}function v(b){return a.setInterval(function(){c.call(this,
{})},b)}var s=b.Class.proxy(this),k=new b.Logger(this.className),y=null,z=null,r=l?l.pingInterval:5E3,u=null,h=b.ServerConnector.events;b.Class.extend(this,b.EventDispatcher,b.Ajax,{_logger:k,connect:function(a){z=a;a=s(f,a);this.ajax(b.ServerConnector.settings.URL,"POST","",s(d,a))},disconnect:function(){y?(y.close(),z=y=null,k.info("disconnect","Connection with WS has been broken")):k.debug("disconnect","Connection with WS has not been established yet")},sendOffer:function(b,a,e){c({eventName:h.receiveOffer,
targetUserId:b,data:{connectionId:a,offer:e||{}}})},sendAnswer:function(b,a,e){c({eventName:h.receiveAnswer,targetUserId:b,data:{connectionId:a,answer:e||{}}})},sendIce:function(b,a,e){c({eventName:h.receiveIce,targetUserId:b,data:{connectionId:a,iceCandidate:e}})},sendBye:function(b,a,e){c({eventName:h.receiveBye,targetUserId:b,data:{connectionId:a,byeData:e||{}}})}})});b.ServerConnector.extend({events:{connectionOpen:"connectionopen",connectionClose:"connectionclose",connectionError:"connectionerror",
message:"message",messageFormatError:"messageformaterror",serverError:"servererror",tokenInvalid:"tokeninvalid",receiveOffer:"receiveoffer",receiveAnswer:"receiveanswer",receiveIce:"receiveice",receiveBye:"receivebye",usersUpdated:"peers",userConnected:"peer_connected",userDisconnected:"peer_removed"},settings:{URL:"https://api.xirsys.com/wsList"}})})(window);xRtc.stream={};
(function(a,b){var l=b.webrtc;b.Class(b,"Stream",function(c){function d(){if(l.detectedBrowser===l.supportedBrowsers.firefox&&22>l.detectedBrowserVersion)throw new b.CommonError("setVideoEnabled","Media track muting is not supported if your Firefox browser version less then 22.");}var f=b.Class.proxy(this),e=new b.Logger(this.className),p=b.Stream.events,t=null;b.Class.property(this,"videoEnabled",function(){var b=c.getVideoTracks();return this.videoAvailable&&b[0].enabled},function(b){d();for(var a=
c.getVideoTracks(),e=0,f=a.length;e<f;e++)a[e].enabled=b});b.Class.property(this,"audioEnabled",function(){var b=c.getAudioTracks();return this.audioAvailable&&b[0].enabled},function(b){d();for(var a=c.getAudioTracks(),e=0,f=a.length;e<f;e++)a[e].enabled=b});b.Class.property(this,"videoAvailable",function(){return 0<c.getVideoTracks().length});b.Class.property(this,"audioAvailable",function(){return 0<c.getAudioTracks().length});c.onended=f(function(b){b={id:b.srcElement.id};e.debug("ended",b);this.trigger(p.ended,
b)});b.Class.extend(this,b.EventDispatcher,{_logger:e,getStream:function(){return c},stop:function(){c.stop()},getId:function(){t||(t=c.id?c.id:b.utils.newGuid());return t},getURL:function(){return l.URL.createObjectURL(c)},assignTo:function(b){this.videoAvailable||this.audioAvailable||0<c.currentTime?(l.detectedBrowser===l.supportedBrowsers.firefox?b.mozSrcObject=c:b.src=this.getURL(),b.play()):a.setTimeout(f(this.assignTo,b),100)}})});b.Stream.extend({events:{ended:"ended"}})})(window,xRtc);xRtc.connection={};
(function(a){"undefined"===typeof a.xRtc&&(a.xRtc={});var b=a.xRtc,l={},c=b.webrtc;b.Class(l,"IceCandidateFilter",function(a,c){var e=a||b.Connection.connectionTypes["default"],l=/(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})/g;b.Class.extend(this,{getType:function(){return e},filterCandidate:function(a){var d=null;if(e===b.Connection.connectionTypes["default"])d=a;else if(e===b.Connection.connectionTypes.direct&&(t.isLocal(a)||t.isStun(a)))d=a;else if(e===b.Connection.connectionTypes.server)if(t.isTurn(a))d=a;
else if(t.isStun(a)){var d=null,x;x=null;if(c)for(var v=0;v<c.length;v++){var s=c[v];0===s.url.indexOf("turn:")&&(x=-1!==s.url.indexOf("@")?s.url.split("@")[1]:s.url.split("turn:")[1])}x&&(d=a,d.candidate=a.candidate.replace(l,x),d.candidate=a.candidate.replace("typ srflx","typ relay"))}return d},filterSDP:function(a){var c=a;e===b.Connection.connectionTypes.server?c=a.replace(/a=candidate:.*((typ host)|(typ srflx)).*\r\n/g,""):e===b.Connection.connectionTypes.direct&&(c=a.replace(/a=candidate:.*typ relay.*\r\n/g,
""));return c}});var t={isLocal:function(b){return/typ host/.test(b.candidate)},isStun:function(b){return/typ srflx/.test(b.candidate)},isTurn:function(b){return/typ relay/.test(b.candidate)}}});b.Class(b,"Connection",function(d,f,e,p,t,n){function w(a){var c=new b.CommonError(a,"The method can be called on '"+b.Room.events.connectionCreated+"' event of the xRtc.Room. Use xRtc.Room.events.connectionCreated for access the event name.");m.error(a,c)}function x(d,f){function l(){if("function"===typeof f)try{f()}catch(b){}}
function p(b){function a(b,c){var e=b;b[b.length-1]===c&&(e=b.substring(0,b.length-1));return e}for(var e=[],d=function(b){var e;if(c.detectedBrowser==c.supportedBrowsers.chrome){var g=b.url;e=b.username;b=b.credential;var d=null,f=g.split(":");0===f[0].indexOf("stun")?d={url:a(g,"/")}:0===f[0].indexOf("turn")&&(28>c.detectedBrowserVersion?(g=g.split("turn:"),d={url:"turn:"+e+"@"+g[1],credential:b}):d={url:a(g,"/"),credential:b,username:e})}else g=b.url,e=b.username,b=b.credential,d=null,f=g.split(":"),
0===f[0].indexOf("stun")?d={url:a(g,"/")}:0!==f[0].indexOf("turn")||-1===g.indexOf("transport=udp")&&-1!==g.indexOf("?transport")||(g=g.split("?"),d={url:a(g[0],"/"),credential:b,username:e});return e=d},g=0,f=b.length;g<f;g++){var I=d(b[g]);I&&e.push(I)}return e}function n(d){var f=this;d=p(d);g=new c.RTCPeerConnection(d&&0<d.length?{iceServers:d}:null,b.Connection.settings.peerConnectionOptions);m.info("initPeerConnection","PeerConnection created.");g.onicecandidate=q(function(b){b.candidate&&(m.debug("peerConnection.onIceCandidate",
b.candidate),b=JSON.parse(JSON.stringify(b.candidate)),b=J.filterCandidate(b),null!==b&&(K.push(b),N&&s.call(this)))});g.onstatechange=g.onsignalingstatechange=q(function(a){m.debug("onConnectionStateChange",a);this.trigger(b.Connection.events.stateChanged,{connection:this,state:this.getState()})});if(c.detectedBrowser===c.supportedBrowsers.firefox&&24>c.detectedBrowserVersion){var I=this.getState();O=a.setInterval(function(){var a=f.getState();a!=I&&(m.debug("setInterval -> xrtc.Connection.events.stateChanged",
a),I=a,f.trigger(b.Connection.events.stateChanged,{connection:f,state:I}))},500)}g.onicechange=g.oniceconnectionstatechange=q(function(c){c=F.call(f);m.debug("onIceStateChange",(new Date).getTime(),c);D&&(m.debug("onIceStateChange",(new Date).getTime(),"checkDisconnectedIceStateTimeout are clearing. ID = '"+D+"'"),a.clearTimeout(D),D=null,m.debug("onIceStateChange",(new Date).getTime(),"checkDisconnectedIceStateTimeout was cleared. ID = '"+D+"'"));"connected"===c?f.trigger(b.Connection.events.connectionEstablished,
{connection:f,user:e}):"disconnected"===c&&(m.debug("onIceStateChange",(new Date).getTime(),"checkDisconnectedIceStateTimeout(10sec.) was started."),D=a.setTimeout(function(){m.debug("onIceStateChange",(new Date).getTime(),"ice state equals 'disconnected' so closePeerConnection was called. Timeout is 10sec and it is expired.");h.call(f);a.clearInterval(D);D=null},1E4),m.debug("onIceStateChange",(new Date).getTime(),"checkDisconnectedIceStateTimeout ID ='"+D+"'"))});g.ondatachannel=function(a){a=new b.DataChannel(a.channel,
e);G.push(a);f.trigger(b.Connection.events.dataChannelCreated,{connection:f,channel:a})};g.onaddstream=q(function(a){a=new b.Stream(a.stream);C.push(a);a={user:e,connection:this,stream:a};m.debug("addRemoteStream",a);this.trigger(b.Connection.events.remoteStreamAdded,a)});g.onclosedconnection=function(b){m.debug("peerConnection.onclosedconnection",b);h.call(f)};d=0;for(var k=A.length;d<k;d++)g.addStream(A[d].getStream());d=0;for(k=Q.length;d<k;d++)v.call(this,Q[d]);l()}e=d;g?l():k.call(this,q(n))}
function v(a){try{var c;b.webrtc.supports.sctp?(c=g.createDataChannel(a.name,{reliable:!0}),c.binaryType="arraybuffer"):c=g.createDataChannel(a.name,{reliable:!1});var d=new b.DataChannel(c,e);G.push(d);this.trigger(b.Connection.events.dataChannelCreated,{connection:this,channel:d})}catch(f){c=new b.CommonError("createDataChannel","Can't create DataChannel.",f),m.error("createDataChannel",c),this.trigger(b.Connection.events.dataChannelCreationError,{connection:this,channelConfig:a,error:c})}}function s(){m.debug("sendIceCandidates",
'Sending "'+K.length+'" ice candidates.');for(var a=0,c=K.length;a<c;a++){var d=K[a];L.sendIce(e.id,M,JSON.stringify(d));this.trigger(b.Connection.events.iceSent,{connection:this,iceCandidate:d})}K=[]}function k(b){"function"===typeof b&&(E?b(E):B.getIceServers(H,function(a){E=a;b(E)}))}function y(a){m.debug("Ice candidate was received.",a);a=new c.RTCIceCandidate(JSON.parse(a.iceCandidate));g.addIceCandidate(a);this.trigger(b.Connection.events.iceAdded,{connection:this,iceCandidate:a})}function z(a){this.trigger(b.Connection.events.offerReceived,
{connection:this,user:e,offerData:a});this.trigger(b.Connection.events.connectionOpening,{connection:this,user:e});m.debug("Offer was received.",a);E=a.iceServers;x.call(this,e,q(function(){m.debug("receiveOffer",a);J=new l.IceCandidateFilter(a.connectionType,E);var d=JSON.parse(a.offer),d=new c.RTCSessionDescription(d);g.setRemoteDescription(d);g.createAnswer(q(function(d){c.detectedBrowser===c.supportedBrowsers.firefox&&(d.sdp=J.filterSDP(d.sdp));g.setLocalDescription(d);var f={answer:JSON.stringify(d),
acceptData:a.acceptData};m.debug("sendAnswer",a,d);L.sendAnswer(e.id,M,f);this.trigger(b.Connection.events.answerSent,{connection:this,user:e,answerData:f});this.trigger(b.Connection.events.connectionEstablishing,{connection:this,user:e});N=!0;s.call(this)}),q(function(a){a=new b.CommonError("sendAnswer","Cannot create WebRTC answer",a);m.error("sendAnswer",a);this.trigger(b.Connection.events.createAnswerError,{connection:this,error:a})}),b.Connection.settings.answerOptions)}))}function r(a){m.debug("Answer was received.",
a);N=!0;s.call(this);a=JSON.parse(a.answer);a=new c.RTCSessionDescription(a);g.setRemoteDescription(a);this.trigger(b.Connection.events.answerReceived,{connection:this,user:e,answerData:{answer:a}});this.trigger(b.Connection.events.connectionEstablishing,{connection:this,user:e})}function u(){h.call(this)}function h(){c.detectedBrowser===c.supportedBrowsers.firefox&&O&&(a.clearInterval(O),O=null);if(g){g.onicecandidate=null;g.close();g=null;K=[];E=null;P=N=!1;var d={connection:this,user:e};e=null;
this.trigger(b.Connection.events.connectionClosed,d)}}function F(){return g&&(g.iceConnectionState||g.iceState)||"notinitialized"}var q=b.Class.proxy(this),m=new b.Logger(this.className),H=f,B=t||new xRtc.AuthManager,A=[],C=[],G=[],Q=[],g=null,O=null,D=null,L=p,J=null,E=null,N=!1,K=[],M=d,P=!1;(function(){var a=b.HandshakeController.events;L.on(a.receiveIce,q(y)).on(a.receiveOffer,q(z)).on(a.receiveAnswer,q(r)).on(a.receiveBye,q(u))}).call(this);b.Class.extend(this,b.EventDispatcher,{_logger:m,getId:function(){return M},
getRemoteUser:function(){return e},_open:function(a){P=!0;var d=this,f={};b.Class.extend(f,b.Connection.settings.offerOptions);a&&a.offer&&b.Class.extend(f,a.offer);d.trigger(b.Connection.events.connectionOpening,{connection:d,user:e});x.call(d,e,function(){J=new l.IceCandidateFilter(a&&a.connectionType||null,E);g.createOffer(q(function(a){if(g){c.detectedBrowser===c.supportedBrowsers.firefox&&(a.sdp=J.filterSDP(a.sdp));m.debug("onCreateOfferSuccess",a);g.setLocalDescription(a);c.detectedBrowser===
c.supportedBrowsers.firefox&&21>=c.detectedBrowserVersion&&(a.sdp=-1==a.sdp.indexOf("a=crypto")?a.sdp.replace(/c=IN/g,"a=crypto:1 AES_CM_128_HMAC_SHA1_80 inline:FakeFakeFakeFakeFakeFakeFakeFakeFakeFake\r\nc=IN"):a.sdp);var f={offer:JSON.stringify(a),connectionData:n,connectionType:J.getType(),iceServers:E};m.debug("sendOffer",e.id,a);L.sendOffer(e.id,M,f);d.trigger(b.Connection.events.offerSent,{connection:this,user:e,offerData:f})}}),q(function(a){a=new b.CommonError("startSession","Cannot create WebRTC offer",
a);m.error("onCreateOfferError",a);d.trigger(b.Connection.events.createOfferError,{connection:d,error:a})}),f)})},close:function(b){L&&e&&L.sendBye(e.id,M,b);h.call(this)},addStream:function(a){P&&w("addStream");A.push(a);a={connection:this,stream:a,user:{id:H.name,name:H.name}};m.debug("addLocalStream",a);this.trigger(b.Connection.events.localStreamAdded,a)},createDataChannel:function(b,a){P&&w("createDataChannel");Q.push({name:b,config:a})},getData:function(){return n},getState:function(){var b=
0<A.length;return{notinitialized:b?"ready":"not-ready","new":b?"ready":"not-ready",opening:"connecting",active:"connected",closing:"disconnecting",closed:b?"ready":"not-ready",stable:"connected","have-local-offer":"ready","have-remote-offer":"connecting"}[g&&(g.signalingState||g.readyState)||"notinitialized"]},getLocalStreams:function(){return A.map(function(b){return b})},getRemoteStreams:function(){return C.map(function(b){return b})},getDataChannels:function(){return G.map(function(b){return b})}})});
b.Connection.extend({events:{connectionOpening:"connectionopening",connectionEstablishing:"connectionestablishing",connectionEstablished:"connectionestablished",connectionClosed:"connectionclosed",localStreamAdded:"localstreamadded",remoteStreamAdded:"remotestreamadded",dataChannelCreated:"datachannelcreated",dataChannelCreationError:"datachannelcreationerror",stateChanged:"statechanged",createOfferError:"createoffererror",offerSent:"offersent",offerReceived:"offerreceived",createAnswerError:"createanswererror",
answerSent:"answersent",answerReceived:"answerreceived",iceSent:"icesent",iceAdded:"iceadded"},connectionTypes:{"default":"default",direct:"direct",server:"server"},settings:{offerOptions:{optional:[],mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}},answerOptions:{optional:[],mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}},peerConnectionOptions:{optional:[{RtpDataChannels:!b.webrtc.supports.sctp},{DtlsSrtpKeyAgreement:!0}]}}});c.RTCPeerConnection.prototype&&!c.RTCPeerConnection.prototype.getLocalStreams&&
b.Class.extend(c.RTCPeerConnection.prototype,{getLocalStreams:function(){return this.localStreams},getRemoteStreams:function(){return this.remoteStreams}});c.MediaStream.prototype.getVideoTracks||(c.detectedBrowser===c.supportedBrowsers.firefox?b.Class.extend(c.MediaStream.prototype,{getVideoTracks:function(){return[]},getAudioTracks:function(){return[]}}):b.Class.extend(c.MediaStream.prototype,{getVideoTracks:function(){return this.videoTracks},getAudioTracks:function(){return this.audioTracks}}))})(window);xRtc.room={};
(function(a){"undefined"===typeof a.xRtc&&(a.xRtc={});var b=a.xRtc;b.Class(b,"Room",function(a,c,d){function f(){var a=this;h||(B.on(r.connectionOpen,k(function(a){this.trigger(b.Room.events.enter)})).on(r.connectionClose,k(function(a){this.trigger(b.Room.events.leave)})).on(r.tokenInvalid,k(function(a){this.trigger(b.Room.events.tokenInvalid,a)})).on(r.usersUpdated,k(function(a){u=a.users;u.sort(n);this.trigger(b.Room.events.usersUpdated,{users:this.getUsers()})})).on(r.userConnected,k(function(a){u.push(a.user);
u.sort(n);this.trigger(b.Room.events.userConnected,{user:a.user})})).on(r.userDisconnected,k(function(a){u.splice(s(u,a.user.id),1);u.sort(n);this.trigger(b.Room.events.userDisconnected,{user:a.user})})).on(r.receiveOffer,k(e)).on(r.receiveBye,k(p)).on(r.receiveAnswer,function(c){if(c.senderId&&c.connectionId){var d=w(c.senderId);if(d){var e=C[c.connectionId];e?e.userId===d.id&&(a.trigger(b.Room.events.connectionAccepted,{user:d,connection:x(c.connectionId),data:c.acceptData}),e.hc.trigger(z.receiveAnswer,
{connectionId:c.connectionId,answer:c.answer})):B.sendBye(c.senderId,c.connectionId,{type:G.decline,data:"Remote connection not found."})}}}).on(r.receiveIce,function(b){if(b.senderId&&b.connectionId){var a=C[b.connectionId];a&&a.userId===b.senderId&&a.hc.trigger(z.receiveIce,{iceCandidate:b.iceCandidate,connectionId:b.connectionId})}}),h=!0)}function e(a){function c(b){t.call(e,a.connectionId,m,w(a.senderId),a.connectionData,function(c){c.handshakeController.trigger(z.receiveOffer,{offer:a.offer,
iceServers:a.iceServers,connectionType:a.connectionType,connectionId:a.connectionId,connectionData:a.connectionData,acceptData:b})})}function d(b){B.sendBye(a.senderId,a.connectionId,{type:G.decline,data:b})}if(a.senderId&&a.connectionId){var e=this,f={user:w(a.senderId)};F.autoReply||(f.data=a.connectionData,f.accept=k(c),f.decline=k(d));C[a.connectionId]={userId:a.senderId,hc:null};this.trigger(b.Room.events.incomingConnection,f);F.autoReply&&c.call(e)}}function p(a){if(a.senderId&&a.connectionId){var c=
w(a.senderId);if(c){var d=C[a.connectionId];d&&d.userId===c.id&&((a.byeData&&a.byeData.type===G.decline||!d.hc)&&this.trigger(b.Room.events.connectionDeclined,{user:c,connection:x(a.connectionId),data:a.byeData}),d.hc&&d.hc.trigger(z.receiveBye))}}}function t(a,c,d,e,f){var h=new b.HandshakeController;c=new xRtc.Connection(a,c,d,h,H,e);C[a]?C[a].hc=h:C[a]={userId:d.id,hc:h};h.on(z.sendOffer,k(function(a,b,c){B.sendOffer(a,b,c)})).on(z.sendAnswer,k(function(a,b,c){B.sendAnswer(a,b,c)})).on(z.sendIce,
k(function(a,b,c){B.sendIce(a,b,c)})).on(z.sendBye,k(function(a,b,c){B.sendBye(a,b,c)}));c.on(b.Connection.events.connectionClosed,function(){A.splice(v(A,a),1);delete C[a]});A.push(c);this.trigger(b.Room.events.connectionCreated,{user:d,connection:c});"function"===typeof f&&f({connection:c,handshakeController:h})}function n(a,b){var c=0;a.name<b.name?c=-1:a.name>b.name&&(c=1);return c}function w(a){for(var b=null,c=0,d=u.length;c<d;c++)if(u[c].id===a){b=u[c];break}return b}function x(a){for(var b=
null,c=0,d=A.length;c<d;c++)if(A[c].getId()===a){b=A[c];break}return b}function v(a,b){for(var c=-1,d=0,e=a.length;d<e;d++)if(a[d].getId()===b){c=d;break}return c}function s(a,b){for(var c=-1,d=0,e=a.length;d<e;d++)a[d].id===b&&(c=d);return c}var k=b.Class.proxy(this),y=new b.Logger(this.className),z=b.HandshakeController.events,r=b.ServerConnector.events,u=[],h=!1,F={},q={},m=null,H=c||new xRtc.AuthManager,B=d||new b.ServerConnector,A=[],C={},G={decline:"decline"};b.Class.extend(q,b.Room.settings.info);
"string"===typeof a?q.name=a:b.Class.extend(q,a);b.Class.extend(this,b.EventDispatcher,{_logger:y,enter:function(a,c){var d="",e="";if(!a)throw new b.CommonError("enter","User credentials should be specified.");"string"===typeof a?d=a:(d=a.username,e=a.password);f.call(this);b.Class.extend(F,b.Room.settings.enterOptions);c&&b.Class.extend(F,c);m={domain:q.domain,application:q.application,room:q.name,name:d,password:e};H.getToken(m,function(a){q.user={id:null,name:d};B.connect(a)})},leave:function(){B.on(b.ServerConnector.events.connectionClose,
function(){h&&(B.off(r.connectionOpen).off(r.connectionClose).off(r.tokenInvalid).off(r.usersUpdated).off(r.userConnected).off(r.userDisconnected).off(r.receiveOffer).off(r.receiveBye).off(r.receiveAnswer).off(r.receiveIce),h=!1);F={};m=null;q.user=null;u=[];A=[];C={}});B.disconnect()},connect:function(a,c){if(!q.user)throw new b.CommonError("connect","Need to enter the room before you connect someone.");var d=w(a);if(null==d)d=b.CommonError("connect","Target user not found."),this.trigger(b.Room.events.error,
{userId:a,error:d});else{var e=c&&c.data?c.data:null;t.call(this,b.utils.newGuid(),m,d,e,function(a){a=a.connection;c&&"auto"===c.createDataChannel&&a.createDataChannel("autoDataChannel");a._open(c)})}},getInfo:function(){return q},getConnections:function(){return A.map(function(a){return a})},getUsers:function(){return u.map(function(a){return a})}})});b.Room.extend({events:{enter:"enter",leave:"leave",incomingConnection:"incomingconnection",connectionCreated:"connectioncreated",connectionAccepted:"connectionaccepted",
connectionDeclined:"connectiondeclined",usersUpdated:"usersupdated",userConnected:"userconnected",userDisconnected:"userdisconnected",tokenInvalid:"tokeninvalid",error:"error"},settings:{info:{domain:a.document.domain,application:"default",name:"default"},enterOptions:{autoReply:!0}}})})(window);xRtc.userMedia={};
(function(a){"undefined"===typeof a.xRtc&&(a.xRtc={});var b=a.xRtc,l=b.webrtc,c=new b.Logger("UserMedia"),d=function(a,c,d){l.getUserMedia(a,function(a){"function"===typeof c&&c(new b.Stream(a))},function(a){"function"===typeof d&&d(a)})};b.getUserMedia=function(a,e,p){if(a&&!a.video&&!a.audio){var t=new b.CommonError("getUserMedia","video or audio property of the options parameter should be specified. No sense to create media stream without video and audio components.");c.error("onCreateOfferError",t)}var n=
a||{video:!0,audio:!0};n.video&&n.video.mandatory&&"screen"===n.video.mandatory.mediaSource?d.call(this,{video:{mandatory:{chromeMediaSource:"screen"}}},function(a){n.audio?d.call(this,{audio:!0},function(b){function c(a,b){for(var d=0;d<b.length;d++)a.push(b[d])}var d=[];c(d,b.getAudioTracks());c(d,a.getVideoTracks());e(new l.MediaStream(d))},p):e(a)},p):d.call(this,n,e,p)}})(window);
