(function(d){function a(){this._pieces=[];this._parts=[]}function f(c){this.index=0;this.dataBuffer=c;this.dataView=new Uint8Array(this.dataBuffer);this.length=this.dataBuffer.byteLength}function b(){this.bufferBuilder=new a}function g(c){c=c.charCodeAt(0);return 2047>=c?"00":65535>=c?"000":2097151>=c?"0000":67108863>=c?"00000":"000000"}var h={},e;try{new Blob([]),e=!1}catch(k){e=!0}h.useBlobBuilder=e;if(e=!h.useBlobBuilder)try{e=0===(new Blob([new Uint8Array([])])).size}catch(t){e=!0}h.useArrayBufferView=
e;d.binaryFeatures=h;d.BlobBuilder=window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder||window.BlobBuilder;a.prototype.append=function(c){"number"===typeof c?this._pieces.push(c):(this.flush(),this._parts.push(c))};a.prototype.flush=function(){if(0<this._pieces.length){var c=new Uint8Array(this._pieces);h.useArrayBufferView||(c=c.buffer);this._parts.push(c);this._pieces=[]}};a.prototype.getBuffer=function(){this.flush();if(h.useBlobBuilder){for(var c=new BlobBuilder,a=0,b=this._parts.length;a<
b;a++)c.append(this._parts[a]);return c.getBlob()}return new Blob(this._parts)};d.BinaryPack={unpack:function(c){return(new f(c)).unpack()},pack:function(c){var a=new b;a.pack(c);return a.getBuffer()}};f.prototype.unpack=function(){var c=this.unpack_uint8();if(128>c)return c;if(32>(c^224))return(c^224)-32;var a;if(15>=(a=c^160))return this.unpack_raw(a);if(15>=(a=c^176))return this.unpack_string(a);if(15>=(a=c^144))return this.unpack_array(a);if(15>=(a=c^128))return this.unpack_map(a);switch(c){case 192:return null;
case 194:return!1;case 195:return!0;case 202:return this.unpack_float();case 203:return this.unpack_double();case 204:return this.unpack_uint8();case 205:return this.unpack_uint16();case 206:return this.unpack_uint32();case 207:return this.unpack_uint64();case 208:return this.unpack_int8();case 209:return this.unpack_int16();case 210:return this.unpack_int32();case 211:return this.unpack_int64();case 216:return a=this.unpack_uint16(),this.unpack_string(a);case 217:return a=this.unpack_uint32(),this.unpack_string(a);
case 218:return a=this.unpack_uint16(),this.unpack_raw(a);case 219:return a=this.unpack_uint32(),this.unpack_raw(a);case 220:return a=this.unpack_uint16(),this.unpack_array(a);case 221:return a=this.unpack_uint32(),this.unpack_array(a);case 222:return a=this.unpack_uint16(),this.unpack_map(a);case 223:return a=this.unpack_uint32(),this.unpack_map(a)}};f.prototype.unpack_uint8=function(){var c=this.dataView[this.index]&255;this.index++;return c};f.prototype.unpack_uint16=function(){var c=this.read(2),
c=256*(c[0]&255)+(c[1]&255);this.index+=2;return c};f.prototype.unpack_uint32=function(){var c=this.read(4),c=256*(256*(256*c[0]+c[1])+c[2])+c[3];this.index+=4;return c};f.prototype.unpack_uint64=function(){var c=this.read(8),c=256*(256*(256*(256*(256*(256*(256*c[0]+c[1])+c[2])+c[3])+c[4])+c[5])+c[6])+c[7];this.index+=8;return c};f.prototype.unpack_int8=function(){var c=this.unpack_uint8();return 128>c?c:c-256};f.prototype.unpack_int16=function(){var c=this.unpack_uint16();return 32768>c?c:c-65536};
f.prototype.unpack_int32=function(){var c=this.unpack_uint32();return c<Math.pow(2,31)?c:c-Math.pow(2,32)};f.prototype.unpack_int64=function(){var c=this.unpack_uint64();return c<Math.pow(2,63)?c:c-Math.pow(2,64)};f.prototype.unpack_raw=function(c){if(this.length<this.index+c)throw Error("BinaryPackFailure: index is out of range "+this.index+" "+c+" "+this.length);var a=this.dataBuffer.slice(this.index,this.index+c);this.index+=c;return a};f.prototype.unpack_string=function(c){for(var a=this.read(c),
b=0,e="",k;b<c;)k=a[b],128>k?(e+=String.fromCharCode(k),b++):32>(k^192)?(k=(k^192)<<6|a[b+1]&63,e+=String.fromCharCode(k),b+=2):(k=(k&15)<<12|(a[b+1]&63)<<6|a[b+2]&63,e+=String.fromCharCode(k),b+=3);this.index+=c;return e};f.prototype.unpack_array=function(c){for(var a=Array(c),b=0;b<c;b++)a[b]=this.unpack();return a};f.prototype.unpack_map=function(c){for(var a={},b=0;b<c;b++){var e=this.unpack(),k=this.unpack();a[e]=k}return a};f.prototype.unpack_float=function(){var c=this.unpack_uint32();return(0==
c>>31?1:-1)*(c&8388607|8388608)*Math.pow(2,(c>>23&255)-127-23)};f.prototype.unpack_double=function(){var c=this.unpack_uint32(),a=this.unpack_uint32(),b=c>>31,e=(c>>20&2047)-1023,c=(c&1048575|1048576)*Math.pow(2,e-20)+a*Math.pow(2,e-52);return(0==b?1:-1)*c};f.prototype.read=function(c){var a=this.index;if(a+c<=this.length)return this.dataView.subarray(a,a+c);throw Error("BinaryPackFailure: read index out of range");};b.prototype.getBuffer=function(){return this.bufferBuilder.getBuffer()};b.prototype.pack=
function(c){var a=typeof c;if("string"==a)this.pack_string(c);else if("number"==a)Math.floor(c)===c?this.pack_integer(c):this.pack_double(c);else if("boolean"==a)!0===c?this.bufferBuilder.append(195):!1===c&&this.bufferBuilder.append(194);else if("undefined"==a)this.bufferBuilder.append(192);else if("object"==a)if(null===c)this.bufferBuilder.append(192);else if(a=c.constructor,a==Array)this.pack_array(c);else if(a==Blob||a==File)this.pack_bin(c);else if(a==ArrayBuffer)h.useArrayBufferView?this.pack_bin(new Uint8Array(c)):
this.pack_bin(c);else if("BYTES_PER_ELEMENT"in c)h.useArrayBufferView?this.pack_bin(new Uint8Array(c.buffer)):this.pack_bin(c.buffer);else if(a==Object)this.pack_object(c);else if(a==Date)this.pack_string(c.toString());else if("function"==typeof c.toBinaryPack)this.bufferBuilder.append(c.toBinaryPack());else throw Error('Type "'+a.toString()+'" not yet supported');else throw Error('Type "'+a+'" not yet supported');this.bufferBuilder.flush()};b.prototype.pack_bin=function(a){var b=a.length||a.byteLength||
a.size;if(15>=b)this.pack_uint8(160+b);else if(65535>=b)this.bufferBuilder.append(218),this.pack_uint16(b);else if(4294967295>=b)this.bufferBuilder.append(219),this.pack_uint32(b);else throw Error("Invalid length");this.bufferBuilder.append(a)};b.prototype.pack_string=function(a){var b;b=600<a.length?(new Blob([a])).size:a.replace(/[^\u0000-\u007F]/g,g).length;if(15>=b)this.pack_uint8(176+b);else if(65535>=b)this.bufferBuilder.append(216),this.pack_uint16(b);else if(4294967295>=b)this.bufferBuilder.append(217),
this.pack_uint32(b);else throw Error("Invalid length");this.bufferBuilder.append(a)};b.prototype.pack_array=function(a){var b=a.length;if(15>=b)this.pack_uint8(144+b);else if(65535>=b)this.bufferBuilder.append(220),this.pack_uint16(b);else if(4294967295>=b)this.bufferBuilder.append(221),this.pack_uint32(b);else throw Error("Invalid length");for(var e=0;e<b;e++)this.pack(a[e])};b.prototype.pack_integer=function(a){if(-32<=a&&127>=a)this.bufferBuilder.append(a&255);else if(0<=a&&255>=a)this.bufferBuilder.append(204),
this.pack_uint8(a);else if(-128<=a&&127>=a)this.bufferBuilder.append(208),this.pack_int8(a);else if(0<=a&&65535>=a)this.bufferBuilder.append(205),this.pack_uint16(a);else if(-32768<=a&&32767>=a)this.bufferBuilder.append(209),this.pack_int16(a);else if(0<=a&&4294967295>=a)this.bufferBuilder.append(206),this.pack_uint32(a);else if(-2147483648<=a&&2147483647>=a)this.bufferBuilder.append(210),this.pack_int32(a);else if(-9223372036854775E3<=a&&9223372036854775E3>=a)this.bufferBuilder.append(211),this.pack_int64(a);
else if(0<=a&&1.8446744073709552E19>=a)this.bufferBuilder.append(207),this.pack_uint64(a);else throw Error("Invalid integer");};b.prototype.pack_double=function(a){var b=0;0>a&&(b=1,a=-a);var e=Math.floor(Math.log(a)/Math.LN2);a=a/Math.pow(2,e)-1;a=Math.floor(a*Math.pow(2,52));var k=Math.pow(2,32),b=b<<31|e+1023<<20|a/k&1048575,e=a%k;this.bufferBuilder.append(203);this.pack_int32(b);this.pack_int32(e)};b.prototype.pack_object=function(a){var b=Object.keys(a).length;if(15>=b)this.pack_uint8(128+b);
else if(65535>=b)this.bufferBuilder.append(222),this.pack_uint16(b);else if(4294967295>=b)this.bufferBuilder.append(223),this.pack_uint32(b);else throw Error("Invalid length");for(var e in a)a.hasOwnProperty(e)&&(this.pack(e),this.pack(a[e]))};b.prototype.pack_uint8=function(a){this.bufferBuilder.append(a)};b.prototype.pack_uint16=function(a){this.bufferBuilder.append(a>>8);this.bufferBuilder.append(a&255)};b.prototype.pack_uint32=function(a){a&=4294967295;this.bufferBuilder.append((a&4278190080)>>>
24);this.bufferBuilder.append((a&16711680)>>>16);this.bufferBuilder.append((a&65280)>>>8);this.bufferBuilder.append(a&255)};b.prototype.pack_uint64=function(a){var b=a/Math.pow(2,32);a%=Math.pow(2,32);this.bufferBuilder.append((b&4278190080)>>>24);this.bufferBuilder.append((b&16711680)>>>16);this.bufferBuilder.append((b&65280)>>>8);this.bufferBuilder.append(b&255);this.bufferBuilder.append((a&4278190080)>>>24);this.bufferBuilder.append((a&16711680)>>>16);this.bufferBuilder.append((a&65280)>>>8);this.bufferBuilder.append(a&
255)};b.prototype.pack_int8=function(a){this.bufferBuilder.append(a&255)};b.prototype.pack_int16=function(a){this.bufferBuilder.append((a&65280)>>8);this.bufferBuilder.append(a&255)};b.prototype.pack_int32=function(a){this.bufferBuilder.append(a>>>24&255);this.bufferBuilder.append((a&16711680)>>>16);this.bufferBuilder.append((a&65280)>>>8);this.bufferBuilder.append(a&255)};b.prototype.pack_int64=function(a){var b=Math.floor(a/Math.pow(2,32));a%=Math.pow(2,32);this.bufferBuilder.append((b&4278190080)>>>
24);this.bufferBuilder.append((b&16711680)>>>16);this.bufferBuilder.append((b&65280)>>>8);this.bufferBuilder.append(b&255);this.bufferBuilder.append((a&4278190080)>>>24);this.bufferBuilder.append((a&16711680)>>>16);this.bufferBuilder.append((a&65280)>>>8);this.bufferBuilder.append(a&255)}})(this);(function(d){"undefined"===typeof d.xRtc&&(d.xRtc={});var a=d.xRtc;a.Ajax={ajax:function(f,b,g,d){var e,k;k=a.Class.proxy(this);try{e=new XMLHttpRequest}catch(t){try{e=new ActiveXObject("Msxml2.XMLHTTP")}catch(c){try{e=new ActiveXObject("Microsoft.XMLHTTP")}catch(u){this._logger&&(k=new a.CommonError("ajax","XMLHttpRequest is not supported"),this._logger.error("ajax",k));return}}}this._logger&&this._logger.debug("ajax",f,g);b=b.toUpperCase();try{var x=!1;"GET"===b?(e.open(b,f+"?"+g,!0),g=""):(e.open(b,
f,!0),e.setRequestHeader("method",b+" "+f+" HTTP/1.1"),e.setRequestHeader("content-type","application/x-www-form-urlencoded"));e.onreadystatechange=k(function(){4!=e.readyState||x||(x=!0,this._logger&&this._logger.debug("ajax",e),"function"===typeof d&&d(e.responseText))});e.send(g)}catch(D){throw k=new a.CommonError("ajax","XMLHttpRequest exception",D),k.data={url:f,method:b,params:g},this._logger&&this._logger.error("ajax",k),k;}}}})(window);(function(d){"undefined"===typeof d.xRtc&&(d.xRtc={});d.xRtc.EventDispatcher={on:function(a,f){this._logger&&this._logger.info("on",arguments);this._events=this._events||{};this._events[a]=this._events[a]||[];this._events[a].push(f);return this},off:function(a){this._logger&&this._logger.info("off",arguments);this._events=this._events||{};this._events[a]=this._events[a]||[];delete this._events[a];return this},trigger:function(a){this._logger&&this._logger.info("trigger",arguments);this._events=this._events||
{};var f=this._events[a];if(!f)return this._logger.warning("trigger","Trying to call event which is not listening. Event name is '"+a+"'"),this;for(var b=Array.prototype.slice.call(arguments,1),d=0,h=f.length;d<h;d++)f[d].apply(null,b);return this}}})(window);(function(d){function a(a,f,d){if(a instanceof ArrayBuffer)"function"===typeof f&&f(a);else if(a instanceof Blob){var e=new FileReader;e.onerror=function(a){"function"===typeof d&&d(a.target.error)};e.onloadend=function(a){a.target.readyState!=FileReader.DONE||a.target.error||"function"!==typeof f||f(a.target.result)};e.readAsArrayBuffer(a)}else"function"===typeof d&&d("Can't parse 'source' to ArrayBuffer. 'source' should be from following list: Blob, File, ArrayBuffer.")}"undefined"===typeof d.xRtc&&
(d.xRtc={});var f=d.xRtc;f.webrtc={getUserMedia:(navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia||navigator.getUserMedia).bind(navigator),RTCPeerConnection:d.mozRTCPeerConnection||d.webkitRTCPeerConnection||d.RTCPeerConnection,RTCIceCandidate:d.mozRTCIceCandidate||d.RTCIceCandidate,RTCSessionDescription:d.mozRTCSessionDescription||d.RTCSessionDescription,URL:d.webkitURL||d.msURL||d.oURL||d.URL,MediaStream:d.mozMediaStream||d.webkitMediaStream||d.MediaStream,supportedBrowsers:{chrome:"chrome",
firefox:"firefox"}};f.webrtc.detectedBrowser=navigator.mozGetUserMedia?f.webrtc.supportedBrowsers.firefox:f.webrtc.supportedBrowsers.chrome;f.webrtc.detectedBrowserVersion=f.webrtc.detectedBrowser===f.webrtc.supportedBrowsers.firefox?parseInt(d.navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1]):parseInt(d.navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./)[2]);f.webrtc.supports=function(){if("undefined"===typeof f.webrtc.RTCPeerConnection)return{};var a=!1,d=!1,h=!1,e;try{e=new f.webrtc.RTCPeerConnection(null,
{optional:[{RtpDataChannels:!0}]});a=!0;try{e.createDataChannel("_XRTCTEST",{reliable:!1});var d=!0,k=new f.webrtc.RTCPeerConnection(null,{});try{h=k.createDataChannel("_XRTCRELIABLETEST",{reliable:!0}).reliable}catch(t){}k.close()}catch(c){}}catch(u){}e&&e.close();return{media:a,data:d,sctp:h}}();f.binarySerializer={pack:function(b,f,d){a(BinaryPack.pack(b),f,d)},unpack:BinaryPack.unpack};xRtc.utils={newGuid:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var f=
16*Math.random()|0;return("x"==a?f:f&3|8).toString(16)})}}})(window);(function(d){"undefined"===typeof d.xRtc&&(d.xRtc={});d.xRtc.Class=function(a,f,b){a[f]=b;var g=a[f];g.fn=g.prototype;g.fn.className=f;g.extend=function(a){var b=a.extended;d.xRtc.Class.extend(g,a);b&&b(g)}};d.xRtc.Class.extend=function(a){for(var f=Array.prototype.slice.call(arguments,1),b=0,d=f.length;b<d;b++){var h=f[b],e;for(e in h)a[e]=h[e]}};d.xRtc.Class.property=function(a,f,b,d){"function"===typeof b&&a.__defineGetter__(f,b);"function"===typeof d&&a.__defineSetter__(f,d)};d.xRtc.Class.proxy=
function(a){return function(d){var b=[];1<arguments.length&&(b=Array.prototype.slice.call(arguments,1));return function(){for(var g=Array.prototype.slice.call(arguments),h=0;h<b.length;h++)g.push(b[h]);d.apply(a,g)}}}})(window);(function(d){"undefined"===typeof d.xRtc&&(d.xRtc={});d=d.xRtc;d.Class(d,"CommonError",function(a,d,b){this.method=a;this.message=d;this.error=b})})(window);(function(d){"undefined"===typeof d.xRtc&&(d.xRtc={});var a=d.xRtc;a.Class(a,"Logger",function(d){function b(){for(var a=[],d,e=0,k=arguments.length;e<k;e++)if(d=arguments[e],"object"===typeof d&&d instanceof Object&&"undefined"!==typeof d.length){d=b.apply(null,Array.prototype.slice.call(d));for(var f=0,c=d.length;f<c;f++)a.push(d[f])}else a.push(d);return a}a.Class.extend(this,{info:function(g){if(!0===a.Logger.level||"object"===typeof a.Logger.level&&a.Logger.level.info)"string"===typeof g?console.info("Info:\t\t",
d+"."+g,b(Array.prototype.slice.call(arguments,1))):console.info("Info:\t\t",b(Array.prototype.slice.call(arguments)))},debug:function(g){if(!0===a.Logger.level||"object"===typeof a.Logger.level&&a.Logger.level.debug)"string"===typeof g?console.debug("Debug:\t\t",d+"."+g,b(Array.prototype.slice.call(arguments,1))):console.debug("Debug:\t\t",b(Array.prototype.slice.call(arguments)))},test:function(g){if(!0===a.Logger.level||"object"===typeof a.Logger.level&&a.Logger.level.test)"string"===typeof g?
console.debug("Test:\t\t",d+"."+g,b(Array.prototype.slice.call(arguments,1))):console.debug("Test:\t\t",b(Array.prototype.slice.call(arguments)))},warning:function(g){if(!0===a.Logger.level||"object"===typeof a.Logger.level&&a.Logger.level.warning)"string"===typeof g?console.warn("Warning:\t",d+"."+g,b(Array.prototype.slice.call(arguments,1))):console.warn("Warning:\t",b(Array.prototype.slice.call(arguments)))},error:function(g){if(!0===a.Logger.level||"object"===typeof a.Logger.level&&a.Logger.level.error)"string"===
typeof g?console.error("Error:\t\t",d+"."+g,b(Array.prototype.slice.call(arguments,1))):console.error("Error:\t\t",b(Array.prototype.slice.call(arguments)))}})});a.Logger.extend({level:!1,enable:function(a){this.level="undefined"===typeof a?!0:a},disable:function(){this.level=!1}})})(window);(function(d){"undefined"===typeof d.xRtc&&(d.xRtc={});var a=d.xRtc;a.Class(a,"AuthManager",function(){function d(a){return["domain="+a.domain,"application="+a.application,"room="+a.room,"username="+a.name,"password="+a.password]}function b(b,d,c){var f=this;try{e.debug("getToken",b);""===b&&(e.error("getToken","Server returned an empty response."),f.trigger(a.AuthManager.events.serverError,"Server returned an empty response."));try{b=JSON.parse(b),e.debug("getToken",b)}catch(g){throw e.error("getToken",
b),g;}if(b&&b.e&&""!=b.e){var h=new a.CommonError("getToken",b.e);e.error("getToken",h);f.trigger(a.AuthManager.events.serverError,h)}else{var s=b.d.token;s?(e.info("getToken",s),"function"===typeof c&&c(s)):(e.error("getToken",b.d),f.trigger(a.AuthManager.events.serverError,b.d))}}catch(n){e.error("getToken. The request will be repeated after "+a.AuthManager.settings.unsuccessfulRequestRepeatTimeout/1E3+" sec.",n),setTimeout(function(){f.getToken(d,c)},a.AuthManager.settings.unsuccessfulRequestRepeatTimeout)}}
function g(b,d,c){var f=this;try{if(b=JSON.parse(b),e.debug("getIceServers",b),b&&b.e&&""!=b.e){var g=new a.CommonError("getIceServers",b.e);e.error("getIceServers",g);f.trigger(a.AuthManager.events.serverError,g)}else{var h=b.d.iceServers?b.d.iceServers.map(function(a){var b={};a.url&&(b.url=a.url);a.credential&&(b.credential=a.credential);a.username&&(b.username=a.username);return b}):[];e.info("getIceServers",h);"function"===typeof c&&c(h)}}catch(s){e.error("getIceServers. The request will be repeated after "+
a.AuthManager.settings.unsuccessfulRequestRepeatTimeout/1E3+" sec.",s),setTimeout(function(){f.getIceServers(d,c)},a.AuthManager.settings.unsuccessfulRequestRepeatTimeout)}}var h=a.Class.proxy(this),e=new a.Logger(this.className);a.Class.extend(this,a.Ajax,a.EventDispatcher,{_logger:e,getToken:function(e,g){var c=a.AuthManager.settings.tokenHandler,u=d.call(this,e).join("&");this.ajax(c,"POST",u,h(b,e,g))},getIceServers:function(b,e){var c=a.AuthManager.settings.iceHandler,u=d.call(this,b).join("&");
this.ajax(c,"POST",u,h(g,b,e))}})});a.AuthManager.extend({events:{serverError:"servererror"},settings:{unsuccessfulRequestRepeatTimeout:5E3,tokenHandler:"https://api.xirsys.com/getToken",iceHandler:"https://api.xirsys.com/getIceServers"}})})(window);(function(d,a){var f=a.webrtc;a.Class(a,"Stream",function(b){function g(){if(f.detectedBrowser===f.supportedBrowsers.firefox&&22>f.detectedBrowserVersion)throw new a.CommonError("setVideoEnabled","Media track muting is not supported if your Firefox browser version less then 22.");}var h=a.Class.proxy(this),e=new a.Logger(this.className),k=a.Stream.events,t=null;a.Class.property(this,"videoEnabled",function(){var a=b.getVideoTracks();return this.videoAvailable&&a[0].enabled},function(a){g();for(var d=
b.getVideoTracks(),e=0,f=d.length;e<f;e++)d[e].enabled=a});a.Class.property(this,"audioEnabled",function(){var a=b.getAudioTracks();return this.audioAvailable&&a[0].enabled},function(a){g();for(var d=b.getAudioTracks(),e=0,f=d.length;e<f;e++)d[e].enabled=a});a.Class.property(this,"videoAvailable",function(){return 0<b.getVideoTracks().length});a.Class.property(this,"audioAvailable",function(){return 0<b.getAudioTracks().length});b.onended=h(function(a){a={id:a.srcElement.id};e.debug("ended",a);this.trigger(k.ended,
a)});a.Class.extend(this,a.EventDispatcher,{_logger:e,getStream:function(){return b},stop:function(){b.stop()},getId:function(){t||(t=b.id?b.id:a.utils.newGuid());return t},getURL:function(){return f.URL.createObjectURL(b)},assignTo:function(a){this.videoAvailable||this.audioAvailable||0<b.currentTime?(f.detectedBrowser===f.supportedBrowsers.firefox?a.mozSrcObject=b:a.src=this.getURL(),a.play()):d.setTimeout(h(this.assignTo,a),100)}})});a.Stream.extend({events:{ended:"ended"}})})(window,xRtc);(function(d){"undefined"===typeof d.xRtc&&(d.xRtc={});var a=d.xRtc;a.Class(a,"DataChannel",function(d,b){var g=a.Class.proxy(this),h=new a.Logger(this.className),e=a.DataChannel.events;d.onopen=g(function(a){a={event:a};h.debug("open",a);this.trigger(e.open,a)});d.onmessage=g(function(b){h.debug("message",b.data);b=a.binarySerializer.unpack(b.data);h.debug("deserialized message",b);this.trigger(e.receivedMessage,{data:b})});d.onclose=g(function(a){a={event:a};h.debug("close",a);this.trigger(e.close,
a)});d.onerror=g(function(b){b=new a.CommonError("onerror","DataChannel error.",b);h.error("error",b);this.trigger(e.error,b)});d.ondatachannel=g(function(a){a={event:a};h.debug("datachannel",a);this.trigger(e.dataChannel,a)});a.Class.extend(this,a.EventDispatcher,{_logger:h,getId:function(){return b.getId()+this.getName()},getRemoteUser:function(){return b.getRemoteUser()},getConnection:function(){return b},getName:function(){return d.label},getState:function(){return d.readyState.toLowerCase()},
send:function(b){var g=this;h.info("send",arguments);try{a.binarySerializer.pack(b,function(a){d.send(a)},function(b){b=new a.CommonError("onerror","DataChannel error.",b);h.error("error",b);g.trigger(e.error,b)})}catch(c){var u=new a.CommonError("onerror",'DataChannel sending error. Channel state is "'+g.getState()+'"',c);h.error("error",u);g.trigger(e.error,u)}g.trigger(e.sentMessage,{data:b})}})});a.DataChannel.extend({events:{open:"open",sentMessage:"sentMessage",receivedMessage:"receivedMessage",
close:"close",error:"error",dataChannel:"datachannel"},states:{connecting:"connecting",open:"open",closing:"closing",closed:"closed"}})})(window);(function(d){"undefined"===typeof d.xRtc&&(d.xRtc={});var a=d.xRtc,f={},b=a.webrtc;a.Class(f,"IceCandidateFilter",function(b,d){var e=b||a.Connection.connectionTypes["default"],f=/(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})/g;a.Class.extend(this,{getType:function(){return e},filterCandidate:function(b){var g=null;if(e===a.Connection.connectionTypes["default"])g=b;else if(e===a.Connection.connectionTypes.direct&&(t.isLocal(b)||t.isStun(b)))g=b;else if(e===a.Connection.connectionTypes.server)if(t.isTurn(b))g=
b;else if(t.isStun(b)){var g=null,x;x=null;if(d)for(var D=0;D<d.length;D++){var s=d[D];0===s.url.indexOf("turn:")&&(x=-1!==s.url.indexOf("@")?s.url.split("@")[1]:s.url.split("turn:")[1])}x&&(g=b,g.candidate=b.candidate.replace(f,x),g.candidate=b.candidate.replace("typ srflx","typ relay"))}return g},filterSDP:function(b){var d=b;e===a.Connection.connectionTypes.server?d=b.replace(/a=candidate:.*((typ host)|(typ srflx)).*\r\n/g,""):e===a.Connection.connectionTypes.direct&&(d=b.replace(/a=candidate:.*typ relay.*\r\n/g,
""));return d}});var t={isLocal:function(a){return/typ host/.test(a.candidate)},isStun:function(a){return/typ srflx/.test(a.candidate)},isTurn:function(a){return/typ relay/.test(a.candidate)}}});a.Class(a,"Connection",function(g,h,e,k,t,c){function u(b){var d=new a.CommonError(b,"The method can be called on '"+a.Room.events.connectionCreated+"' event of the xRtc.Room. Use xRtc.Room.events.connectionCreated for access the event name.");p.error(b,d)}function x(c,f){function g(){if("function"===typeof f)try{f()}catch(a){}}
function h(a){function d(a,b){var c=a;a[a.length-1]===b&&(c=a.substring(0,a.length-1));return c}for(var c=[],e=function(a){var c;if(b.detectedBrowser==b.supportedBrowsers.chrome){var e=a.url;c=a.username;a=a.credential;var f=null,m=e.split(":");0===m[0].indexOf("stun")?f={url:d(e,"/")}:0===m[0].indexOf("turn")&&(28>b.detectedBrowserVersion?(e=e.split("turn:"),f={url:"turn:"+c+"@"+e[1],credential:a}):f={url:d(e,"/"),credential:a,username:c})}else e=a.url,c=a.username,a=a.credential,f=null,m=e.split(":"),
0===m[0].indexOf("stun")?f={url:d(e,"/")}:0!==m[0].indexOf("turn")||-1===e.indexOf("transport=udp")&&-1!==e.indexOf("?transport")||(e=e.split("?"),f={url:d(e[0],"/"),credential:a,username:c});return c=f},f=0,m=a.length;f<m;f++){var w=e(a[f]);w&&c.push(w)}return c}function k(c){var f=this;c=h(c);m=new b.RTCPeerConnection(c&&0<c.length?{iceServers:c}:null,a.Connection.settings.peerConnectionOptions);p.info("initPeerConnection","PeerConnection created.");m.onicecandidate=q(function(a){a.candidate&&(p.debug("peerConnection.onIceCandidate",
a.candidate),a=JSON.parse(JSON.stringify(a.candidate)),a=H.filterCandidate(a),null!==a&&(I.push(a),M&&s.call(this)))});m.onstatechange=m.onsignalingstatechange=q(function(b){p.debug("onConnectionStateChange",b);this.trigger(a.Connection.events.stateChanged,{connection:this,state:this.getState()})});if(b.detectedBrowser===b.supportedBrowsers.firefox&&24>b.detectedBrowserVersion){var P=this.getState();N=d.setInterval(function(){var b=f.getState();b!=P&&(p.debug("setInterval -> xrtc.Connection.events.stateChanged",
b),P=b,f.trigger(a.Connection.events.stateChanged,{connection:f,state:P}))},500)}m.onicechange=m.oniceconnectionstatechange=q(function(b){b=w.call(f);p.debug("onIceStateChange",(new Date).getTime(),b);E&&(p.debug("onIceStateChange",(new Date).getTime(),"checkDisconnectedIceStateTimeout are clearing. ID = '"+E+"'"),d.clearTimeout(E),E=null,p.debug("onIceStateChange",(new Date).getTime(),"checkDisconnectedIceStateTimeout was cleared. ID = '"+E+"'"));"connected"===b?f.trigger(a.Connection.events.connectionEstablished,
{connection:f,user:e}):"disconnected"===b&&(p.debug("onIceStateChange",(new Date).getTime(),"checkDisconnectedIceStateTimeout(10sec.) was started."),E=d.setTimeout(function(){p.debug("onIceStateChange",(new Date).getTime(),"ice state equals 'disconnected' so closePeerConnection was called. Timeout is 10sec and it is expired.");l.call(f);d.clearInterval(E);E=null},1E4),p.debug("onIceStateChange",(new Date).getTime(),"checkDisconnectedIceStateTimeout ID ='"+E+"'"))});m.ondatachannel=function(b){b=new a.DataChannel(b.channel,
f);G.push(b);f.trigger(a.Connection.events.dataChannelCreated,{connection:f,channel:b})};m.onaddstream=q(function(b){b=new a.Stream(b.stream);C.push(b);b={user:e,connection:this,stream:b};p.debug("addRemoteStream",b);this.trigger(a.Connection.events.remoteStreamAdded,b)});m.onclosedconnection=function(a){p.debug("peerConnection.onclosedconnection",a);l.call(f)};c=0;for(var n=z.length;c<n;c++)m.addStream(z[c].getStream());c=0;for(n=Q.length;c<n;c++)D.call(this,Q[c]);g()}e=c;m?g():n.call(this,q(k))}
function D(b){try{var c;a.webrtc.supports.sctp?(c=m.createDataChannel(b.name,{reliable:!0}),c.binaryType="arraybuffer"):c=m.createDataChannel(b.name,{reliable:!1});var d=new a.DataChannel(c,this);G.push(d);this.trigger(a.Connection.events.dataChannelCreated,{connection:this,channel:d})}catch(e){c=new a.CommonError("createDataChannel","Can't create DataChannel.",e),p.error("createDataChannel",c),this.trigger(a.Connection.events.dataChannelCreationError,{connection:this,channelConfig:b,error:c})}}function s(){p.debug("sendIceCandidates",
'Sending "'+I.length+'" ice candidates.');for(var b=0,c=I.length;b<c;b++){var d=I[b];J.sendIce(e.id,L,JSON.stringify(d));this.trigger(a.Connection.events.iceSent,{connection:this,iceCandidate:d})}I=[]}function n(a){"function"===typeof a&&(F?a(F):B.getIceServers(K,function(b){F=b;a(F)}))}function y(c){p.debug("Ice candidate was received.",c);c=new b.RTCIceCandidate(JSON.parse(c.iceCandidate));m.addIceCandidate(c);this.trigger(a.Connection.events.iceAdded,{connection:this,iceCandidate:c})}function A(c){this.trigger(a.Connection.events.offerReceived,
{connection:this,user:e,offerData:c});this.trigger(a.Connection.events.connectionOpening,{connection:this,user:e});p.debug("Offer was received.",c);F=c.iceServers;x.call(this,e,q(function(){p.debug("receiveOffer",c);H=new f.IceCandidateFilter(c.connectionType,F);var d=JSON.parse(c.offer),d=new b.RTCSessionDescription(d);m.setRemoteDescription(d);m.createAnswer(q(function(d){b.detectedBrowser===b.supportedBrowsers.firefox&&(d.sdp=H.filterSDP(d.sdp));m.setLocalDescription(d);var f={answer:JSON.stringify(d),
acceptData:c.acceptData};p.debug("sendAnswer",c,d);J.sendAnswer(e.id,L,f);this.trigger(a.Connection.events.answerSent,{connection:this,user:e,answerData:f});this.trigger(a.Connection.events.connectionEstablishing,{connection:this,user:e});M=!0;s.call(this)}),q(function(b){b=new a.CommonError("sendAnswer","Cannot create WebRTC answer",b);p.error("sendAnswer",b);this.trigger(a.Connection.events.createAnswerError,{connection:this,error:b})}),a.Connection.settings.answerOptions)}))}function r(c){p.debug("Answer was received.",
c);M=!0;s.call(this);c=JSON.parse(c.answer);c=new b.RTCSessionDescription(c);m.setRemoteDescription(c);this.trigger(a.Connection.events.answerReceived,{connection:this,user:e,answerData:{answer:c}});this.trigger(a.Connection.events.connectionEstablishing,{connection:this,user:e})}function v(){l.call(this)}function l(){b.detectedBrowser===b.supportedBrowsers.firefox&&N&&(d.clearInterval(N),N=null);if(m){m.onicecandidate=null;m.close();m=null;I=[];F=null;O=M=!1;var c={user:e,connection:this};e=null;
this.trigger(a.Connection.events.connectionClosed,c)}}function w(){return m&&(m.iceConnectionState||m.iceState)||"notinitialized"}var q=a.Class.proxy(this),p=new a.Logger(this.className),K=h,B=t||new xRtc.AuthManager,z=[],C=[],G=[],Q=[],m=null,N=null,E=null,J=k,H=null,F=null,M=!1,I=[],L=g,O=!1;(function(){var b=a.HandshakeController.events;J.on(b.receiveIce,q(y)).on(b.receiveOffer,q(A)).on(b.receiveAnswer,q(r)).on(b.receiveBye,q(v))}).call(this);a.Class.extend(this,a.EventDispatcher,{_logger:p,getId:function(){return L},
getRemoteUser:function(){return e},_open:function(d){O=!0;var w=this,g={};a.Class.extend(g,a.Connection.settings.offerOptions);d&&d.offer&&a.Class.extend(g,d.offer);w.trigger(a.Connection.events.connectionOpening,{connection:w,user:e});x.call(w,e,function(){H=new f.IceCandidateFilter(d&&d.connectionType||null,F);m.createOffer(q(function(d){if(m){b.detectedBrowser===b.supportedBrowsers.firefox&&(d.sdp=H.filterSDP(d.sdp));p.debug("onCreateOfferSuccess",d);m.setLocalDescription(d);b.detectedBrowser===
b.supportedBrowsers.firefox&&21>=b.detectedBrowserVersion&&(d.sdp=-1==d.sdp.indexOf("a=crypto")?d.sdp.replace(/c=IN/g,"a=crypto:1 AES_CM_128_HMAC_SHA1_80 inline:FakeFakeFakeFakeFakeFakeFakeFakeFakeFake\r\nc=IN"):d.sdp);var f={offer:JSON.stringify(d),connectionData:c,connectionType:H.getType(),iceServers:F};p.debug("sendOffer",e.id,d);J.sendOffer(e.id,L,f);w.trigger(a.Connection.events.offerSent,{connection:this,user:e,offerData:f})}}),q(function(b){b=new a.CommonError("startSession","Cannot create WebRTC offer",
b);p.error("onCreateOfferError",b);w.trigger(a.Connection.events.createOfferError,{connection:w,error:b})}),g)})},close:function(a){J&&e&&J.sendBye(e.id,L,a);l.call(this)},addStream:function(b){O&&u("addStream");z.push(b);b={connection:this,stream:b,user:{id:K.name,name:K.name}};p.debug("addLocalStream",b);this.trigger(a.Connection.events.localStreamAdded,b)},createDataChannel:function(a,b){O&&u("createDataChannel");Q.push({name:a,config:b})},getData:function(){return c},getState:function(){var a=
0<z.length;return{notinitialized:a?"ready":"not-ready","new":a?"ready":"not-ready",opening:"connecting",active:"connected",closing:"disconnecting",closed:a?"ready":"not-ready",stable:"connected","have-local-offer":"ready","have-remote-offer":"connecting"}[m&&(m.signalingState||m.readyState)||"notinitialized"]},getLocalStreams:function(){return z.map(function(a){return a})},getRemoteStreams:function(){return C.map(function(a){return a})},getDataChannels:function(){return G.map(function(a){return a})}})});
a.Connection.extend({events:{connectionOpening:"connectionopening",connectionEstablishing:"connectionestablishing",connectionEstablished:"connectionestablished",connectionClosed:"connectionclosed",localStreamAdded:"localstreamadded",remoteStreamAdded:"remotestreamadded",dataChannelCreated:"datachannelcreated",dataChannelCreationError:"datachannelcreationerror",stateChanged:"statechanged",createOfferError:"createoffererror",offerSent:"offersent",offerReceived:"offerreceived",createAnswerError:"createanswererror",
answerSent:"answersent",answerReceived:"answerreceived",iceSent:"icesent",iceAdded:"iceadded"},connectionTypes:{"default":"default",direct:"direct",server:"server"},settings:{offerOptions:{optional:[],mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}},answerOptions:{optional:[],mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}},peerConnectionOptions:{optional:[{RtpDataChannels:!a.webrtc.supports.sctp},{DtlsSrtpKeyAgreement:!0}]}}});b.RTCPeerConnection.prototype&&!b.RTCPeerConnection.prototype.getLocalStreams&&
a.Class.extend(b.RTCPeerConnection.prototype,{getLocalStreams:function(){return this.localStreams},getRemoteStreams:function(){return this.remoteStreams}});b.MediaStream.prototype.getVideoTracks||(b.detectedBrowser===b.supportedBrowsers.firefox?a.Class.extend(b.MediaStream.prototype,{getVideoTracks:function(){return[]},getAudioTracks:function(){return[]}}):a.Class.extend(b.MediaStream.prototype,{getVideoTracks:function(){return this.videoTracks},getAudioTracks:function(){return this.audioTracks}}))})(window);(function(d){"undefined"===typeof d.xRtc&&(d.xRtc={});var a=d.xRtc;a.Class(a,"HandshakeController",function(){var d=new a.Logger(this.className);a.Class.extend(this,a.EventDispatcher,{_logger:d,sendIce:function(b,d,f){this.trigger(a.HandshakeController.events.sendIce,b,d,f)},sendOffer:function(b,d,f){this.trigger(a.HandshakeController.events.sendOffer,b,d,f)},sendAnswer:function(b,d,f){this.trigger(a.HandshakeController.events.sendAnswer,b,d,f)},sendBye:function(b,d,f){this.trigger(a.HandshakeController.events.sendBye,
b,d,f)}})});a.HandshakeController.extend({events:{sendIce:"sendice",sendOffer:"sendoffer",sendAnswer:"sendanswer",sendBye:"sendbye",receiveIce:"receiveice",receiveOffer:"receiveoffer",receiveAnswer:"receiveanswer",receiveBye:"receivebye"}})})(window);(function(d){"undefined"===typeof d.xRtc&&(d.xRtc={});var a=d.xRtc;a.Class(a,"ServerConnector",function(f){function b(b,c){var d={eventName:b.eventName};"undefined"!==typeof b.data&&(d.data=b.data);"undefined"!==typeof b.targetUserId&&(d.targetUserId=b.targetUserId.toString());var e=JSON.stringify(d);if(y)n.debug("send",d,e),y.send(e);else if(c)n.debug("send","The call was ignored because no server connection.",d,e);else throw d=new a.CommonError("send","Trying to call method without established connection",
"WebSocket is not connected!"),n.error("send",d),d;}function g(b,c){try{if(b=JSON.parse(b),n.debug("getWebSocketURL",b),b&&b.e&&""!=b.e){var d=new a.CommonError("getWebSocketURL","Error occured while getting the URL of WebSockets",b.e);n.error("getWebSocketURL",d);this.trigger(l.serverError,{error:d})}else{var e=b.d.value;n.info("getWebSocketURL",e);"function"===typeof c&&c(e)}}catch(f){this.ajax(a.ServerConnector.settings.URL,"POST","",s(g,c))}}function h(a,b){y=new WebSocket(a+"/ws/"+encodeURIComponent(b));
y.onopen=s(e);y.onclose=s(k);y.onerror=s(t);y.onmessage=s(c)}function e(a){a={event:a};n.debug("open",a);r&&(v=D.call(this,r));this.trigger(l.connectionOpen,a)}function k(a){v&&(d.clearInterval(v),v=null);a={event:a};n.debug("close",a);this.trigger(l.connectionClose,a);y=null}function t(b){b=new a.CommonError("onerror","WebSocket has got an error",b);n.error("error",b);this.trigger(l.connectionError,{error:b})}function c(a){var b={message:a};n.debug("message",b);this.trigger(l.message,b);if(u(a))if(a=
x(a),b=a.type,b==l.usersUpdated||b==l.userConnected||b==l.userDisconnected)if(b==l.usersUpdated){for(var b=[],c=0,d=a.message.users.length;c<d;c++)b.push({id:a.message.users[c],name:a.message.users[c]});this.trigger(l.usersUpdated,{users:b})}else b==l.userConnected?this.trigger(l.userConnected,{user:{id:a.message,name:a.message}}):b==l.userDisconnected&&this.trigger(l.userDisconnected,{user:{id:a.message,name:a.message}});else if(b==l.receiveOffer||b==l.receiveAnswer||b==l.receiveIce||b==l.receiveBye)b==
l.receiveOffer?this.trigger(l.receiveOffer,{senderId:a.userid,receiverId:a.message.targetUserId,connectionId:a.message.data.connectionId,offer:a.message.data.offer.offer,iceServers:a.message.data.offer.iceServers,connectionType:a.message.data.offer.connectionType,connectionData:a.message.data.offer.connectionData}):b==l.receiveAnswer?this.trigger(l.receiveAnswer,{senderId:a.userid,connectionId:a.message.data.connectionId,answer:a.message.data.answer.answer,acceptData:a.message.data.answer.acceptData}):
b==l.receiveIce?this.trigger(l.receiveIce,{senderId:a.userid,connectionId:a.message.data.connectionId,iceCandidate:a.message.data.iceCandidate}):b==l.receiveBye&&this.trigger(l.receiveBye,{senderId:a.userid,connectionId:a.message.data.connectionId,byeData:a.message.data.byeData})}function u(a){var b=!0;'"Token invalid"'===a.data&&(b=!1,this.trigger(l.tokenInvalid,{token:A}));return b}function x(b){var c;try{c=JSON.parse(b.data)}catch(d){c=null;var e=new a.CommonError("parseServerMessage","Message format error",
d);n.error("parseServerMessage",e,b);this.trigger(l.messageFormatError,{error:e})}return c}function D(a){return d.setInterval(function(){b.call(this,{})},a)}var s=a.Class.proxy(this),n=new a.Logger(this.className),y=null,A=null,r=f?f.pingInterval:5E3,v=null,l=a.ServerConnector.events;a.Class.extend(this,a.EventDispatcher,a.Ajax,{_logger:n,connect:function(b){A=b;b=s(h,b);this.ajax(a.ServerConnector.settings.URL,"POST","",s(g,b))},disconnect:function(){y?(y.close(),A=y=null,n.info("disconnect","Connection with WS has been broken")):
n.debug("disconnect","Connection with WS has not been established yet")},sendOffer:function(a,c,d){b({eventName:l.receiveOffer,targetUserId:a,data:{connectionId:c,offer:d||{}}})},sendAnswer:function(a,c,d){b({eventName:l.receiveAnswer,targetUserId:a,data:{connectionId:c,answer:d||{}}})},sendIce:function(a,c,d){b({eventName:l.receiveIce,targetUserId:a,data:{connectionId:c,iceCandidate:d}})},sendBye:function(a,c,d){b({eventName:l.receiveBye,targetUserId:a,data:{connectionId:c,byeData:d||{}}},!0)}})});
a.ServerConnector.extend({events:{connectionOpen:"connectionopen",connectionClose:"connectionclose",connectionError:"connectionerror",message:"message",messageFormatError:"messageformaterror",serverError:"servererror",tokenInvalid:"tokeninvalid",receiveOffer:"receiveoffer",receiveAnswer:"receiveanswer",receiveIce:"receiveice",receiveBye:"receivebye",usersUpdated:"peers",userConnected:"peer_connected",userDisconnected:"peer_removed"},settings:{URL:"https://api.xirsys.com/wsList"}})})(window);(function(d){"undefined"===typeof d.xRtc&&(d.xRtc={});var a=d.xRtc;a.Class(a,"Room",function(d,b,g){function h(){var b=this;l||(B.on(r.connectionOpen,n(function(b){this.trigger(a.Room.events.enter)})).on(r.connectionClose,n(function(b){this.trigger(a.Room.events.leave)})).on(r.tokenInvalid,n(function(b){this.trigger(a.Room.events.tokenInvalid,b)})).on(r.usersUpdated,n(function(b){v=b.users;v.sort(c);this.trigger(a.Room.events.usersUpdated,{users:this.getUsers()})})).on(r.userConnected,n(function(b){v.push(b.user);
v.sort(c);this.trigger(a.Room.events.userConnected,{user:b.user})})).on(r.userDisconnected,n(function(b){v.splice(s(v,b.user.id),1);v.sort(c);this.trigger(a.Room.events.userDisconnected,{user:b.user})})).on(r.receiveOffer,n(e)).on(r.receiveBye,n(k)).on(r.receiveAnswer,function(c){if(c.senderId&&c.connectionId){var d=u(c.senderId);if(d){var e=C[c.connectionId];e?e.userId===d.id&&(b.trigger(a.Room.events.connectionAccepted,{user:d,connection:x(c.connectionId),data:c.acceptData}),e.hc.trigger(A.receiveAnswer,
{connectionId:c.connectionId,answer:c.answer})):B.sendBye(c.senderId,c.connectionId,{type:G.decline,data:"Remote connection not found."})}}}).on(r.receiveIce,function(a){if(a.senderId&&a.connectionId){var b=C[a.connectionId];b&&b.userId===a.senderId&&b.hc.trigger(A.receiveIce,{iceCandidate:a.iceCandidate,connectionId:a.connectionId})}}),l=!0)}function e(b){function c(a){t.call(e,b.connectionId,p,u(b.senderId),b.connectionData,function(c){c.handshakeController.trigger(A.receiveOffer,{offer:b.offer,
iceServers:b.iceServers,connectionType:b.connectionType,connectionId:b.connectionId,connectionData:b.connectionData,acceptData:a})})}function d(a){B.sendBye(b.senderId,b.connectionId,{type:G.decline,data:a})}if(b.senderId&&b.connectionId){var e=this,f={user:u(b.senderId),connectionId:b.connectionId,data:b.connectionData};w.autoReply||(f.accept=n(c),f.decline=n(d));C[b.connectionId]={userId:b.senderId,hc:null};this.trigger(a.Room.events.incomingConnection,f);w.autoReply&&c.call(e)}}function k(b){if(b.senderId&&
b.connectionId){var c=u(b.senderId);if(c){var d=C[b.connectionId];if(d&&d.userId===c.id){if(b.byeData&&b.byeData.type===G.decline||!d.hc){var e=x(b.connectionId);e&&this.trigger(a.Room.events.connectionDeclined,{user:c,connection:e,data:b.byeData})}d.hc&&d.hc.trigger(A.receiveBye)}}}}function t(b,c,d,e,f){var g=new a.HandshakeController;c=new xRtc.Connection(b,c,d,g,K,e);C[b]?C[b].hc=g:C[b]={userId:d.id,hc:g};g.on(A.sendOffer,n(function(a,b,c){B.sendOffer(a,b,c)})).on(A.sendAnswer,n(function(a,b,
c){B.sendAnswer(a,b,c)})).on(A.sendIce,n(function(a,b,c){B.sendIce(a,b,c)})).on(A.sendBye,n(function(a,b,c){B.sendBye(a,b,c)}));c.on(a.Connection.events.connectionClosed,function(){z.splice(D(z,b),1);delete C[b]});z.push(c);this.trigger(a.Room.events.connectionCreated,{user:d,connection:c});"function"===typeof f&&f({connection:c,handshakeController:g})}function c(a,b){var c=0;a.name<b.name?c=-1:a.name>b.name&&(c=1);return c}function u(a){for(var b=null,c=0,d=v.length;c<d;c++)if(v[c].id===a){b=v[c];
break}return b}function x(a){for(var b=null,c=0,d=z.length;c<d;c++)if(z[c].getId()===a){b=z[c];break}return b}function D(a,b){for(var c=-1,d=0,e=a.length;d<e;d++)if(a[d].getId()===b){c=d;break}return c}function s(a,b){for(var c=-1,d=0,e=a.length;d<e;d++)a[d].id===b&&(c=d);return c}var n=a.Class.proxy(this),y=new a.Logger(this.className),A=a.HandshakeController.events,r=a.ServerConnector.events,v=[],l=!1,w={},q={},p=null,K=b||new xRtc.AuthManager,B=g||new a.ServerConnector,z=[],C={},G={decline:"decline"};
a.Class.extend(q,a.Room.settings.info);"string"===typeof d?q.name=d:a.Class.extend(q,d);a.Class.extend(this,a.EventDispatcher,{_logger:y,enter:function(b,c){var d="",e="";if(!b)throw new a.CommonError("enter","User credentials should be specified.");"string"===typeof b?d=b:(d=b.username,e=b.password);h.call(this);a.Class.extend(w,a.Room.settings.enterOptions);c&&a.Class.extend(w,c);p={domain:q.domain,application:q.application,room:q.name,name:d,password:e};K.getToken(p,function(a){q.user={id:null,
name:d};B.connect(a)})},leave:function(){B.on(a.ServerConnector.events.connectionClose,function(){l&&(B.off(r.connectionOpen).off(r.connectionClose).off(r.tokenInvalid).off(r.usersUpdated).off(r.userConnected).off(r.userDisconnected).off(r.receiveOffer).off(r.receiveBye).off(r.receiveAnswer).off(r.receiveIce),l=!1);w={};p=null;q.user=null;v=[];z=[];C={}});B.disconnect()},connect:function(b,c){if(!q.user)throw new a.CommonError("connect","Need to enter the room before you connect someone.");var d=
u(b);if(null==d)d=a.CommonError("connect","Target user not found."),this.trigger(a.Room.events.error,{userId:b,error:d});else{var e=c&&c.data?c.data:null,f=c&&c.id?c.id:a.utils.newGuid();t.call(this,f,p,d,e,function(a){a=a.connection;c&&"auto"===c.createDataChannel&&a.createDataChannel("autoDataChannel");a._open(c)})}},getInfo:function(){return q},getConnections:function(){return z.map(function(a){return a})},getUsers:function(){return v.map(function(a){return a})}})});a.Room.extend({events:{enter:"enter",
leave:"leave",incomingConnection:"incomingconnection",connectionCreated:"connectioncreated",connectionAccepted:"connectionaccepted",connectionDeclined:"connectiondeclined",usersUpdated:"usersupdated",userConnected:"userconnected",userDisconnected:"userdisconnected",tokenInvalid:"tokeninvalid",error:"error"},settings:{info:{domain:d.document.domain,application:"default",name:"default"},enterOptions:{autoReply:!0}}})})(window);(function(d){"undefined"===typeof d.xRtc&&(d.xRtc={});var a=d.xRtc,f=a.webrtc,b=new a.Logger("UserMedia"),g=function(b,d,g){f.getUserMedia(b,function(b){"function"===typeof d&&d(new a.Stream(b))},function(a){"function"===typeof g&&g(a)})};a.getUserMedia=function(d,e,k){if(d&&!d.video&&!d.audio){var t=new a.CommonError("getUserMedia","video or audio property of the options parameter should be specified. No sense to create media stream without video and audio components.");b.error("onCreateOfferError",
t)}var c=d||{video:!0,audio:!0};c.video&&c.video.mandatory&&"screen"===c.video.mandatory.mediaSource?g.call(this,{video:{mandatory:{chromeMediaSource:"screen"}}},function(a){c.audio?g.call(this,{audio:!0},function(b){function c(a,b){for(var d=0;d<b.length;d++)a.push(b[d])}var d=[];c(d,b.getAudioTracks());c(d,a.getVideoTracks());e(new f.MediaStream(d))},k):e(a)},k):g.call(this,c,e,k)}})(window);
