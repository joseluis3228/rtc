(function(d){function a(){this._pieces=[];this._parts=[]}function h(c){this.index=0;this.dataBuffer=c;this.dataView=new Uint8Array(this.dataBuffer);this.length=this.dataBuffer.byteLength}function b(){this.bufferBuilder=new a}function g(c){c=c.charCodeAt(0);return 2047>=c?"00":65535>=c?"000":2097151>=c?"0000":67108863>=c?"00000":"000000"}var f={},e;try{new Blob([]),e=!1}catch(k){e=!0}f.useBlobBuilder=e;if(e=!f.useBlobBuilder)try{e=0===(new Blob([new Uint8Array([])])).size}catch(q){e=!0}f.useArrayBufferView=
e;d.binaryFeatures=f;d.BlobBuilder=window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder||window.BlobBuilder;a.prototype.append=function(c){"number"===typeof c?this._pieces.push(c):(this.flush(),this._parts.push(c))};a.prototype.flush=function(){if(0<this._pieces.length){var c=new Uint8Array(this._pieces);f.useArrayBufferView||(c=c.buffer);this._parts.push(c);this._pieces=[]}};a.prototype.getBuffer=function(){this.flush();if(f.useBlobBuilder){for(var c=new BlobBuilder,a=0,b=this._parts.length;a<
b;a++)c.append(this._parts[a]);return c.getBlob()}return new Blob(this._parts)};d.BinaryPack={unpack:function(c){return(new h(c)).unpack()},pack:function(c){var a=new b;a.pack(c);return a.getBuffer()}};h.prototype.unpack=function(){var c=this.unpack_uint8();if(128>c)return c;if(32>(c^224))return(c^224)-32;var a;if(15>=(a=c^160))return this.unpack_raw(a);if(15>=(a=c^176))return this.unpack_string(a);if(15>=(a=c^144))return this.unpack_array(a);if(15>=(a=c^128))return this.unpack_map(a);switch(c){case 192:return null;
case 194:return!1;case 195:return!0;case 202:return this.unpack_float();case 203:return this.unpack_double();case 204:return this.unpack_uint8();case 205:return this.unpack_uint16();case 206:return this.unpack_uint32();case 207:return this.unpack_uint64();case 208:return this.unpack_int8();case 209:return this.unpack_int16();case 210:return this.unpack_int32();case 211:return this.unpack_int64();case 216:return a=this.unpack_uint16(),this.unpack_string(a);case 217:return a=this.unpack_uint32(),this.unpack_string(a);
case 218:return a=this.unpack_uint16(),this.unpack_raw(a);case 219:return a=this.unpack_uint32(),this.unpack_raw(a);case 220:return a=this.unpack_uint16(),this.unpack_array(a);case 221:return a=this.unpack_uint32(),this.unpack_array(a);case 222:return a=this.unpack_uint16(),this.unpack_map(a);case 223:return a=this.unpack_uint32(),this.unpack_map(a)}};h.prototype.unpack_uint8=function(){var c=this.dataView[this.index]&255;this.index++;return c};h.prototype.unpack_uint16=function(){var c=this.read(2),
c=256*(c[0]&255)+(c[1]&255);this.index+=2;return c};h.prototype.unpack_uint32=function(){var c=this.read(4),c=256*(256*(256*c[0]+c[1])+c[2])+c[3];this.index+=4;return c};h.prototype.unpack_uint64=function(){var c=this.read(8),c=256*(256*(256*(256*(256*(256*(256*c[0]+c[1])+c[2])+c[3])+c[4])+c[5])+c[6])+c[7];this.index+=8;return c};h.prototype.unpack_int8=function(){var c=this.unpack_uint8();return 128>c?c:c-256};h.prototype.unpack_int16=function(){var c=this.unpack_uint16();return 32768>c?c:c-65536};
h.prototype.unpack_int32=function(){var c=this.unpack_uint32();return c<Math.pow(2,31)?c:c-Math.pow(2,32)};h.prototype.unpack_int64=function(){var c=this.unpack_uint64();return c<Math.pow(2,63)?c:c-Math.pow(2,64)};h.prototype.unpack_raw=function(c){if(this.length<this.index+c)throw Error("BinaryPackFailure: index is out of range "+this.index+" "+c+" "+this.length);var a=this.dataBuffer.slice(this.index,this.index+c);this.index+=c;return a};h.prototype.unpack_string=function(c){for(var a=this.read(c),
b=0,e="",k;b<c;)k=a[b],128>k?(e+=String.fromCharCode(k),b++):32>(k^192)?(k=(k^192)<<6|a[b+1]&63,e+=String.fromCharCode(k),b+=2):(k=(k&15)<<12|(a[b+1]&63)<<6|a[b+2]&63,e+=String.fromCharCode(k),b+=3);this.index+=c;return e};h.prototype.unpack_array=function(c){for(var a=Array(c),b=0;b<c;b++)a[b]=this.unpack();return a};h.prototype.unpack_map=function(c){for(var a={},b=0;b<c;b++){var e=this.unpack(),k=this.unpack();a[e]=k}return a};h.prototype.unpack_float=function(){var c=this.unpack_uint32();return(0==
c>>31?1:-1)*(c&8388607|8388608)*Math.pow(2,(c>>23&255)-127-23)};h.prototype.unpack_double=function(){var c=this.unpack_uint32(),a=this.unpack_uint32(),b=c>>31,e=(c>>20&2047)-1023,c=(c&1048575|1048576)*Math.pow(2,e-20)+a*Math.pow(2,e-52);return(0==b?1:-1)*c};h.prototype.read=function(c){var a=this.index;if(a+c<=this.length)return this.dataView.subarray(a,a+c);throw Error("BinaryPackFailure: read index out of range");};b.prototype.getBuffer=function(){return this.bufferBuilder.getBuffer()};b.prototype.pack=
function(c){var a=typeof c;if("string"==a)this.pack_string(c);else if("number"==a)Math.floor(c)===c?this.pack_integer(c):this.pack_double(c);else if("boolean"==a)!0===c?this.bufferBuilder.append(195):!1===c&&this.bufferBuilder.append(194);else if("undefined"==a)this.bufferBuilder.append(192);else if("object"==a)if(null===c)this.bufferBuilder.append(192);else if(a=c.constructor,a==Array)this.pack_array(c);else if(a==Blob||a==File)this.pack_bin(c);else if(a==ArrayBuffer)f.useArrayBufferView?this.pack_bin(new Uint8Array(c)):
this.pack_bin(c);else if("BYTES_PER_ELEMENT"in c)f.useArrayBufferView?this.pack_bin(new Uint8Array(c.buffer)):this.pack_bin(c.buffer);else if(a==Object)this.pack_object(c);else if(a==Date)this.pack_string(c.toString());else if("function"==typeof c.toBinaryPack)this.bufferBuilder.append(c.toBinaryPack());else throw Error('Type "'+a.toString()+'" not yet supported');else throw Error('Type "'+a+'" not yet supported');this.bufferBuilder.flush()};b.prototype.pack_bin=function(c){var a=c.length||c.byteLength||
c.size;if(15>=a)this.pack_uint8(160+a);else if(65535>=a)this.bufferBuilder.append(218),this.pack_uint16(a);else if(4294967295>=a)this.bufferBuilder.append(219),this.pack_uint32(a);else throw Error("Invalid length");this.bufferBuilder.append(c)};b.prototype.pack_string=function(a){var b;b=600<a.length?(new Blob([a])).size:a.replace(/[^\u0000-\u007F]/g,g).length;if(15>=b)this.pack_uint8(176+b);else if(65535>=b)this.bufferBuilder.append(216),this.pack_uint16(b);else if(4294967295>=b)this.bufferBuilder.append(217),
this.pack_uint32(b);else throw Error("Invalid length");this.bufferBuilder.append(a)};b.prototype.pack_array=function(a){var b=a.length;if(15>=b)this.pack_uint8(144+b);else if(65535>=b)this.bufferBuilder.append(220),this.pack_uint16(b);else if(4294967295>=b)this.bufferBuilder.append(221),this.pack_uint32(b);else throw Error("Invalid length");for(var e=0;e<b;e++)this.pack(a[e])};b.prototype.pack_integer=function(a){if(-32<=a&&127>=a)this.bufferBuilder.append(a&255);else if(0<=a&&255>=a)this.bufferBuilder.append(204),
this.pack_uint8(a);else if(-128<=a&&127>=a)this.bufferBuilder.append(208),this.pack_int8(a);else if(0<=a&&65535>=a)this.bufferBuilder.append(205),this.pack_uint16(a);else if(-32768<=a&&32767>=a)this.bufferBuilder.append(209),this.pack_int16(a);else if(0<=a&&4294967295>=a)this.bufferBuilder.append(206),this.pack_uint32(a);else if(-2147483648<=a&&2147483647>=a)this.bufferBuilder.append(210),this.pack_int32(a);else if(-9223372036854775E3<=a&&9223372036854775E3>=a)this.bufferBuilder.append(211),this.pack_int64(a);
else if(0<=a&&1.8446744073709552E19>=a)this.bufferBuilder.append(207),this.pack_uint64(a);else throw Error("Invalid integer");};b.prototype.pack_double=function(a){var b=0;0>a&&(b=1,a=-a);var e=Math.floor(Math.log(a)/Math.LN2);a=a/Math.pow(2,e)-1;a=Math.floor(a*Math.pow(2,52));var k=Math.pow(2,32),b=b<<31|e+1023<<20|a/k&1048575,e=a%k;this.bufferBuilder.append(203);this.pack_int32(b);this.pack_int32(e)};b.prototype.pack_object=function(a){var b=Object.keys(a).length;if(15>=b)this.pack_uint8(128+b);
else if(65535>=b)this.bufferBuilder.append(222),this.pack_uint16(b);else if(4294967295>=b)this.bufferBuilder.append(223),this.pack_uint32(b);else throw Error("Invalid length");for(var e in a)a.hasOwnProperty(e)&&(this.pack(e),this.pack(a[e]))};b.prototype.pack_uint8=function(a){this.bufferBuilder.append(a)};b.prototype.pack_uint16=function(a){this.bufferBuilder.append(a>>8);this.bufferBuilder.append(a&255)};b.prototype.pack_uint32=function(a){a&=4294967295;this.bufferBuilder.append((a&4278190080)>>>
24);this.bufferBuilder.append((a&16711680)>>>16);this.bufferBuilder.append((a&65280)>>>8);this.bufferBuilder.append(a&255)};b.prototype.pack_uint64=function(a){var b=a/Math.pow(2,32);a%=Math.pow(2,32);this.bufferBuilder.append((b&4278190080)>>>24);this.bufferBuilder.append((b&16711680)>>>16);this.bufferBuilder.append((b&65280)>>>8);this.bufferBuilder.append(b&255);this.bufferBuilder.append((a&4278190080)>>>24);this.bufferBuilder.append((a&16711680)>>>16);this.bufferBuilder.append((a&65280)>>>8);this.bufferBuilder.append(a&
255)};b.prototype.pack_int8=function(a){this.bufferBuilder.append(a&255)};b.prototype.pack_int16=function(a){this.bufferBuilder.append((a&65280)>>8);this.bufferBuilder.append(a&255)};b.prototype.pack_int32=function(a){this.bufferBuilder.append(a>>>24&255);this.bufferBuilder.append((a&16711680)>>>16);this.bufferBuilder.append((a&65280)>>>8);this.bufferBuilder.append(a&255)};b.prototype.pack_int64=function(a){var b=Math.floor(a/Math.pow(2,32));a%=Math.pow(2,32);this.bufferBuilder.append((b&4278190080)>>>
24);this.bufferBuilder.append((b&16711680)>>>16);this.bufferBuilder.append((b&65280)>>>8);this.bufferBuilder.append(b&255);this.bufferBuilder.append((a&4278190080)>>>24);this.bufferBuilder.append((a&16711680)>>>16);this.bufferBuilder.append((a&65280)>>>8);this.bufferBuilder.append(a&255)}})(this);(function(d){"undefined"===typeof d.xRtc&&(d.xRtc={});var a=d.xRtc;a.Ajax={ajax:function(h,b,d,f){var e,k;k=a.Class.proxy(this);try{e=new XMLHttpRequest}catch(q){try{e=new ActiveXObject("Msxml2.XMLHTTP")}catch(c){try{e=new ActiveXObject("Microsoft.XMLHTTP")}catch(r){this._logger&&(k=new a.CommonError("ajax","XMLHttpRequest is not supported"),this._logger.error("ajax",k));return}}}this._logger&&this._logger.debug("ajax",h,d);b=b.toUpperCase();try{var w=!1;"GET"===b?(e.open(b,h+"?"+d,!0),d=""):(e.open(b,
h,!0),e.setRequestHeader("method",b+" "+h+" HTTP/1.1"),e.setRequestHeader("content-type","application/x-www-form-urlencoded"));e.onreadystatechange=k(function(){4!=e.readyState||w||(w=!0,this._logger&&this._logger.debug("ajax",e),"function"===typeof f&&f(e.responseText))});e.send(d)}catch(x){throw k=new a.CommonError("ajax","XMLHttpRequest exception",x),k.data={url:h,method:b,params:d},this._logger&&this._logger.error("ajax",k),k;}}}})(window);(function(d){"undefined"===typeof d.xRtc&&(d.xRtc={});d.xRtc.EventDispatcher={on:function(a,d){this._logger&&this._logger.info("on",arguments);this._events=this._events||{};this._events[a]=this._events[a]||[];this._events[a].push(d);return this},off:function(a){this._logger&&this._logger.info("off",arguments);this._events=this._events||{};this._events[a]=this._events[a]||[];delete this._events[a];return this},trigger:function(a){this._logger&&this._logger.info("trigger",arguments);this._events=this._events||
{};var d=this._events[a];if(!d)return this._logger.warning("trigger","Trying to call event which is not listening. Event name is '"+a+"'"),this;for(var b=Array.prototype.slice.call(arguments,1),g=0,f=d.length;g<f;g++)d[g].apply(null,b);return this}}})(window);(function(d){"undefined"===typeof d.xRtc&&(d.xRtc={});var a=d.xRtc;a.webrtc={getUserMedia:(navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia||navigator.getUserMedia).bind(navigator),RTCPeerConnection:d.mozRTCPeerConnection||d.webkitRTCPeerConnection||d.RTCPeerConnection,RTCIceCandidate:d.mozRTCIceCandidate||d.RTCIceCandidate,RTCSessionDescription:d.mozRTCSessionDescription||d.RTCSessionDescription,URL:d.webkitURL||d.msURL||d.oURL||d.URL,MediaStream:d.mozMediaStream||
d.webkitMediaStream||d.MediaStream,supportedBrowsers:{chrome:"chrome",firefox:"firefox",opera:"opera"}};a.webrtc.detectedBrowser=navigator.mozGetUserMedia?a.webrtc.supportedBrowsers.firefox:d.navigator.userAgent.match(/Opera|OPR\//)?a.webrtc.supportedBrowsers.opera:a.webrtc.supportedBrowsers.chrome;a.webrtc.detectedBrowserVersion=a.webrtc.detectedBrowser===a.webrtc.supportedBrowsers.firefox?parseInt(d.navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1]):a.webrtc.detectedBrowser===a.webrtc.supportedBrowsers.opera?
parseInt(d.navigator.userAgent.match(/(Opera|OPR)\/([0-9]+)\./)[2]):parseInt(d.navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./)[2]);a.webrtc.supports=function(){if("undefined"===typeof a.webrtc.RTCPeerConnection)return{};var d=!1,b=!1,g=!1,f;try{f=new a.webrtc.RTCPeerConnection(null,{optional:[{RtpDataChannels:!0}]});d=!0;try{f.createDataChannel("_XRTCTEST",{reliable:!1});var b=!0,e=new a.webrtc.RTCPeerConnection(null,{});try{g=e.createDataChannel("_XRTCRELIABLETEST",{reliable:!0}).reliable}catch(k){}e.close()}catch(q){}}catch(c){}f&&
f.close();return{media:d,data:b,sctp:g,screen:a.webrtc.detectedBrowser===a.webrtc.supportedBrowsers.chrome&&25<a.webrtc.detectedBrowserVersion}}();a.binarySerializer={pack:BinaryPack.pack,unpack:BinaryPack.unpack};xRtc.utils={newGuid:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0;return("x"==a?b:b&3|8).toString(16)})},clone:function(a){if(null==a||"object"!=typeof a)return a;if(a instanceof Date){var b=new Date;b.setTime(a.getTime());return b}if(a instanceof
Array){for(var b=[],d=0,f=a.length;d<f;d++)b[d]=xRtc.utils.clone(a[d]);return b}if(a instanceof Object){b={};for(d in a)a.hasOwnProperty(d)&&(b[d]=xRtc.utils.clone(a[d]));return b}throw Error("Unable to copy obj! Its type isn't supported.");}}})(window);(function(d){"undefined"===typeof d.xRtc&&(d.xRtc={});d.xRtc.Class=function(a,h,b){a[h]=b;var g=a[h];g.fn=g.prototype;g.fn.className=h;g.extend=function(a){var b=a.extended;d.xRtc.Class.extend(g,a);b&&b(g)}};d.xRtc.Class.extend=function(a){for(var d=Array.prototype.slice.call(arguments,1),b=0,g=d.length;b<g;b++){var f=d[b],e;for(e in f)a[e]=f[e]}};d.xRtc.Class.property=function(a,d,b,g){"function"===typeof b&&a.__defineGetter__(d,b);"function"===typeof g&&a.__defineSetter__(d,g)};d.xRtc.Class.proxy=
function(a){return function(d){var b=[];1<arguments.length&&(b=Array.prototype.slice.call(arguments,1));return function(){for(var g=Array.prototype.slice.call(arguments),f=0;f<b.length;f++)g.push(b[f]);d.apply(a,g)}}}})(window);(function(d){"undefined"===typeof d.xRtc&&(d.xRtc={});d=d.xRtc;d.Class(d,"CommonError",function(a,d,b){this.method=a;this.message=d;this.error=b})})(window);(function(d){"undefined"===typeof d.xRtc&&(d.xRtc={});var a=d.xRtc;a.Class(a,"Logger",function(d){function b(){for(var a=[],d,e=0,k=arguments.length;e<k;e++)if(d=arguments[e],"object"===typeof d&&d instanceof Object&&"undefined"!==typeof d.length){d=b.apply(null,Array.prototype.slice.call(d));for(var q=0,c=d.length;q<c;q++)a.push(d[q])}else a.push(d);return a}a.Class.extend(this,{info:function(g){if(!0===a.Logger.level||"object"===typeof a.Logger.level&&a.Logger.level.info)"string"===typeof g?console.info("Info:\t\t",
d+"."+g,b(Array.prototype.slice.call(arguments,1))):console.info("Info:\t\t",b(Array.prototype.slice.call(arguments)))},debug:function(g){if(!0===a.Logger.level||"object"===typeof a.Logger.level&&a.Logger.level.debug)"string"===typeof g?console.debug("Debug:\t\t",d+"."+g,b(Array.prototype.slice.call(arguments,1))):console.debug("Debug:\t\t",b(Array.prototype.slice.call(arguments)))},test:function(g){if(!0===a.Logger.level||"object"===typeof a.Logger.level&&a.Logger.level.test)"string"===typeof g?
console.debug("Test:\t\t",d+"."+g,b(Array.prototype.slice.call(arguments,1))):console.debug("Test:\t\t",b(Array.prototype.slice.call(arguments)))},warning:function(g){if(!0===a.Logger.level||"object"===typeof a.Logger.level&&a.Logger.level.warning)"string"===typeof g?console.warn("Warning:\t",d+"."+g,b(Array.prototype.slice.call(arguments,1))):console.warn("Warning:\t",b(Array.prototype.slice.call(arguments)))},error:function(g){if(!0===a.Logger.level||"object"===typeof a.Logger.level&&a.Logger.level.error)"string"===
typeof g?console.error("Error:\t\t",d+"."+g,b(Array.prototype.slice.call(arguments,1))):console.error("Error:\t\t",b(Array.prototype.slice.call(arguments)))}})});a.Logger.extend({level:!1,enable:function(a){this.level="undefined"===typeof a?!0:a},disable:function(){this.level=!1}})})(window);(function(d){"undefined"===typeof d.xRtc&&(d.xRtc={});var a=d.xRtc;a.Class(a,"AuthManager",function(){function d(a){return["domain="+a.domain,"application="+a.application,"room="+a.room,"username="+a.name,"password="+a.password]}function b(b,d,c){var f=this;try{e.debug("getToken",b);if(""===b){var g=new a.CommonError("getToken","Server returned an empty response.");e.error("getToken",g);f.trigger(a.AuthManager.events.serverError,g)}try{b=JSON.parse(b),e.debug("getToken",b)}catch(h){throw e.error("getToken",
b),h;}if(b&&b.e&&""!=b.e){var s=new a.CommonError("getToken",b.e);e.error("getToken",s);f.trigger(a.AuthManager.events.serverError,s)}else{var n=b.d.token;if(n)e.info("getToken",n),"function"===typeof c&&c(n);else{var y=new a.CommonError("getToken","Token not found.");e.error("getToken",y);f.trigger(a.AuthManager.events.serverError,y)}}}catch(A){e.error("getToken. The request will be repeated after "+a.AuthManager.settings.unsuccessfulRequestRepeatTimeout/1E3+" sec.",A),setTimeout(function(){f.getToken(d,
c)},a.AuthManager.settings.unsuccessfulRequestRepeatTimeout)}}function g(b,d,c){var f=this;try{if(b=JSON.parse(b),e.debug("getIceServers",b),b&&b.e&&""!=b.e){var g=new a.CommonError("getIceServers",b.e);e.error("getIceServers",g);f.trigger(a.AuthManager.events.serverError,g)}else{var h=b.d.iceServers?b.d.iceServers.map(function(a){var b={};a.url&&(b.url=a.url);a.credential&&(b.credential=a.credential);a.username&&(b.username=a.username);return b}):[];e.info("getIceServers",h);"function"===typeof c&&
c(h)}}catch(s){e.error("getIceServers. The request will be repeated after "+a.AuthManager.settings.unsuccessfulRequestRepeatTimeout/1E3+" sec.",s),setTimeout(function(){f.getIceServers(d,c)},a.AuthManager.settings.unsuccessfulRequestRepeatTimeout)}}var f=a.Class.proxy(this),e=new a.Logger(this.className);a.Class.extend(this,a.Ajax,a.EventDispatcher,{_logger:e,getToken:function(e,g){var c=a.AuthManager.settings.tokenHandler,r=d.call(this,e).join("&");this.ajax(c,"POST",r,f(b,e,g))},getIceServers:function(b,
e){var c=a.AuthManager.settings.iceHandler,r=d.call(this,b).join("&");this.ajax(c,"POST",r,f(g,b,e))}})});a.AuthManager.extend({events:{serverError:"servererror"},settings:{unsuccessfulRequestRepeatTimeout:5E3,tokenHandler:"https://api.xirsys.com/getToken",iceHandler:"https://api.xirsys.com/getIceServers"}})})(window);(function(d,a){var h=a.webrtc;a.Class(a,"Stream",function(b){function g(){if(h.detectedBrowser===h.supportedBrowsers.firefox&&22>h.detectedBrowserVersion)throw new a.CommonError("setVideoEnabled","Media track muting is not supported if your Firefox browser version less then 22.");}var f=a.Class.proxy(this),e=new a.Logger(this.className),k=a.Stream.events,q=null;a.Class.property(this,"videoEnabled",function(){var a=b.getVideoTracks();return this.videoAvailable&&a[0].enabled},function(a){g();for(var d=
b.getVideoTracks(),e=0,k=d.length;e<k;e++)d[e].enabled=a});a.Class.property(this,"audioEnabled",function(){var a=b.getAudioTracks();return this.audioAvailable&&a[0].enabled},function(a){g();for(var d=b.getAudioTracks(),e=0,k=d.length;e<k;e++)d[e].enabled=a});a.Class.property(this,"videoAvailable",function(){return 0<b.getVideoTracks().length});a.Class.property(this,"audioAvailable",function(){return 0<b.getAudioTracks().length});b.onended=f(function(a){a={id:a.srcElement.id};e.debug("ended",a);this.trigger(k.ended,
a)});a.Class.extend(this,a.EventDispatcher,{_logger:e,getStream:function(){return b},stop:function(){b.stop&&b.stop()},getId:function(){q||(q=b.id?b.id:a.utils.newGuid());return q},getURL:function(){return h.URL.createObjectURL(b)},assignTo:function(a){this.videoAvailable||this.audioAvailable||0<b.currentTime?(h.detectedBrowser===h.supportedBrowsers.firefox?a.mozSrcObject=b:a.src=this.getURL(),a.play()):d.setTimeout(f(this.assignTo,a),100)}})});a.Stream.extend({events:{ended:"ended"}})})(window,xRtc);(function(d){function a(a){this._sender=a}function h(a,b){var c=new d.FileReader;c.onload=function(a){b(a.target.result)};c.readAsArrayBuffer(a)}function b(a,b){this._sender=a;this.chunkSize=b}function g(a){this._sender=a}function f(a,b){this._sender=a;this._attemptsMaxCount=b;this._buffer=[];this._sendImmediately=!0}"undefined"===typeof d.xRtc&&(d.xRtc={});var e=d.xRtc;e.Class(e,"DataChannel",function(k,q){function c(a){var b=this,c=e.binarySerializer.unpack(a);if(1===c.total)b.trigger(x.progress,
{messageId:c.messageId,percent:100}),b.trigger(x.receivedMessage,{data:e.binarySerializer.unpack(c.data)});else{n[c.messageId]||(n[c.messageId]={data:[],count:0,total:c.total});var f=n[c.messageId];f.data[c.index]=c.data;f.count+=1;0!==f.count%s&&f.total!==f.count||b.trigger(x.progress,{messageId:c.messageId,percent:100*f.count/f.total,cancel:function(){throw"Not implemented yet.";}});f.total===f.count&&h(new d.Blob(f.data),function(a){b.trigger(x.receivedMessage,{data:e.binarySerializer.unpack(a)});
delete f[c.messageId]})}}var r=e.Class.proxy(this),w=new e.Logger(this.className),x=e.DataChannel.events,s=10,n={};k.onopen=r(function(a){a={event:a};w.debug("open",a);this.trigger(x.open,a)});k.onmessage=r(function(a){var b=this;w.debug("message",a.data);var e=a.data.constructor;e===d.ArrayBuffer?c.call(b,a.data):e===d.Blob&&h(a.data,function(a){c.call(b,a)})});k.onclose=r(function(a){a={event:a};w.debug("close",a);this.trigger(x.close,a)});k.onerror=r(function(a){a=new e.CommonError("onerror","DataChannel error.",
a);w.error("error",a);this.trigger(x.error,a)});k.ondatachannel=r(function(a){a={event:a};w.debug("datachannel",a);this.trigger(x.dataChannel,a)});e.Class.extend(this,e.EventDispatcher,{_logger:w,getId:function(){return q.getId()+this.getName()},getRemoteUser:function(){return q.getRemoteUser()},getConnection:function(){return q},getName:function(){return k.label},getState:function(){return k.readyState.toLowerCase()},send:function(c,d,q,h){var r=this,t=r.getState();t!==e.DataChannel.states.open&&
(t=new e.CommonError("send",'DataChannel should be opened before sending some data. Current channel state is "'+t+'"'),w.error("error",t),r.trigger(x.error,t));w.info("send",c);(new a(new b(new a(new g(new f(k,100))),16300))).send(c,function(){var a={data:c};"function"===typeof d&&d(a);r.trigger(x.sentMessage,a)},function(a){a=new e.CommonError("send","DataChannel error.",a);w.error("error",a);"function"===typeof q&&q(a);r.trigger(x.error,a)},function(a){0!==a.count%s&&a.count!==a.total||r.trigger(x.progress,
{messageId:a.messageId,percent:100*a.count/a.total,cancel:function(){throw"Not implemented yet.";}})},h&&h.messageId?{messageId:h.messageId}:null)}})});e.DataChannel.extend({events:{open:"open",progress:"progress",sentMessage:"sentMessage",receivedMessage:"receivedMessage",close:"close",error:"error",dataChannel:"datachannel"},states:{connecting:"connecting",open:"open",closing:"closing",closed:"closed"}});a.prototype.send=function(a,b,c,d,f){this._sender.send(e.binarySerializer.pack(a),b,c,d,f)};
b.prototype.send=function(a,b,c,d,e){this._sendChunks(this._splitToChunks(a,e),b,c,d)};b.prototype._splitToChunks=function(a,b){for(var c=b&&b.messageId?b.messageId:xRtc.utils.newGuid(),d=[],e=a.size,f=0,g=0,h=Math.ceil(e/this.chunkSize);f<e;){var y=Math.min(e,f+this.chunkSize),f={messageId:c,index:g,data:a.slice(f,y),total:h};d.push(f);f=y;g+=1}return d};b.prototype._sendChunks=function(a,b,c,d){var e=this;if(0===a.length)"function"===typeof b&&b();else{var f=a.shift();this._sender.send(f,function(){"function"===
typeof d&&d({messageId:f.messageId,count:f.index+1,total:f.total});e._sendChunks(a,b,c,d)},c)}};g.prototype.send=function(a,b,c){var d=this;h(a,function(a){d._sender.send(a,b,c)})};f.prototype.send=function(a,b,c){this._buffer.push(a);this._sendBuffer(this._buffer,b,c,0)};f.prototype._sendBuffer=function(a,b,c,e){var f=this,g=function(a){e===f._attemptsMaxCount&&"function"===typeof c&&c(a)};f._sendImmediately&&!f._trySendBuffer(a,b,g,e)&&e<f._attemptsMaxCount&&(f._sendImmediately=!1,d.setTimeout(function(){f._sendImmediately=
!0;f._sendBuffer(a,b,c,++e)},100))};f.prototype._trySendBuffer=function(a,b,c){return 0===a.length?!0:this._trySend(a[0],b,c)?(a.shift(),this._trySendBuffer(a,b,c)):!1};f.prototype._trySend=function(a,b,c){try{this._sender.send(a)}catch(d){return c(new e.CommonError("send","Message sending error.",d)),!1}"function"===typeof b&&b();return!0}})(window);(function(d){"undefined"===typeof d.xRtc&&(d.xRtc={});var a=d.xRtc,h={},b=a.webrtc;a.Class(h,"IceCandidateFilter",function(b,d){var e=b||a.Connection.connectionTypes["default"],h=/(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})/g;a.Class.extend(this,{getType:function(){return e},filterCandidate:function(b){var g=null;if(e===a.Connection.connectionTypes["default"])g=b;else if(e===a.Connection.connectionTypes.direct&&(q.isLocal(b)||q.isStun(b)))g=b;else if(e===a.Connection.connectionTypes.server)if(q.isTurn(b))g=
b;else if(q.isStun(b)){var g=null,w;w=null;if(d)for(var x=0;x<d.length;x++){var s=d[x];0===s.url.indexOf("turn:")&&(w=-1!==s.url.indexOf("@")?s.url.split("@")[1]:s.url.split("turn:")[1])}w&&(g=b,g.candidate=b.candidate.replace(h,w),g.candidate=b.candidate.replace("typ srflx","typ relay"))}return g},filterSDP:function(b){var d=b;e===a.Connection.connectionTypes.server?d=b.replace(/a=candidate:.*((typ host)|(typ srflx)).*\r\n/g,""):e===a.Connection.connectionTypes.direct&&(d=b.replace(/a=candidate:.*typ relay.*\r\n/g,
""));return d}});var q={isLocal:function(a){return/typ host/.test(a.candidate)},isStun:function(a){return/typ srflx/.test(a.candidate)},isTurn:function(a){return/typ relay/.test(a.candidate)}}});a.Class(a,"Connection",function(g,f,e,k,q,c){function r(b){throw new a.CommonError(b,"The method can be called on '"+a.Room.events.connectionCreated+"' event of the xRtc.Room. Use xRtc.Room.events.connectionCreated for access the event name.");}function w(c,f){function g(a){function c(a,b){var d=a;a[a.length-
1]===b&&(d=a.substring(0,a.length-1));return d}for(var d=[],e=function(a){var d;if(b.detectedBrowser==b.supportedBrowsers.chrome){var e=a.url;d=a.username;a=a.credential;var f=null,m=e.split(":");0===m[0].indexOf("stun")?f={url:c(e,"/")}:0===m[0].indexOf("turn")&&(28>b.detectedBrowserVersion?(e=e.split("turn:"),f={url:"turn:"+d+"@"+e[1],credential:a}):f={url:c(e,"/"),credential:a,username:d})}else e=a.url,d=a.username,a=a.credential,f=null,m=e.split(":"),0===m[0].indexOf("stun")?f={url:c(e,"/")}:
0!==m[0].indexOf("turn")||-1===e.indexOf("transport=udp")&&-1!==e.indexOf("?transport")||(e=e.split("?"),f={url:c(e[0],"/"),credential:a,username:d});return d=f},f=0,m=a.length;f<m;f++){var t=e(a[f]);t&&d.push(t)}return d}function h(c){var f=this;c=g(c);m=new b.RTCPeerConnection(c&&0<c.length?{iceServers:c}:null,a.Connection.settings.peerConnectionOptions);p.info("initPeerConnection","PeerConnection created.");m.onicecandidate=u(function(a){a.candidate&&(p.debug("peerConnection.onIceCandidate",a.candidate),
a=JSON.parse(JSON.stringify(a.candidate)),a=H.filterCandidate(a),null!==a&&(I.push(a),N&&s.call(this)))});m.onstatechange=m.onsignalingstatechange=u(function(b){p.debug("onConnectionStateChange",b);this.trigger(a.Connection.events.stateChanged,{connection:this,state:this.getState()})});if(b.detectedBrowser===b.supportedBrowsers.firefox&&24>b.detectedBrowserVersion){var R=this.getState();O=d.setInterval(function(){var b=f.getState();b!=R&&(p.debug("setInterval -> xrtc.Connection.events.stateChanged",
b),R=b,f.trigger(a.Connection.events.stateChanged,{connection:f,state:R}))},500)}m.onicechange=m.oniceconnectionstatechange=u(function(b){b=t.call(f);p.debug("onIceStateChange",(new Date).getTime(),b);E&&(p.debug("onIceStateChange",(new Date).getTime(),"checkDisconnectedIceStateTimeout are clearing. ID = '"+E+"'"),d.clearTimeout(E),E=null,p.debug("onIceStateChange",(new Date).getTime(),"checkDisconnectedIceStateTimeout was cleared. ID = '"+E+"'"));"connected"===b?f.trigger(a.Connection.events.connectionEstablished,
{user:e,connection:f}):"disconnected"===b&&(p.debug("onIceStateChange",(new Date).getTime(),"checkDisconnectedIceStateTimeout(10sec.) was started."),E=d.setTimeout(function(){p.debug("onIceStateChange",(new Date).getTime(),"ice state equals 'disconnected' so closePeerConnection was called. Timeout is 10sec and it is expired.");l.call(f);d.clearInterval(E);E=null},1E4),p.debug("onIceStateChange",(new Date).getTime(),"checkDisconnectedIceStateTimeout ID ='"+E+"'"))});m.ondatachannel=function(b){b=new a.DataChannel(b.channel,
f);G.push(b);f.trigger(a.Connection.events.dataChannelCreated,{connection:f,channel:b})};m.onaddstream=u(function(b){b=new a.Stream(b.stream);D.push(b);b={user:e,connection:this,stream:b};p.debug("addRemoteStream",b);this.trigger(a.Connection.events.remoteStreamAdded,b)});m.onclosedconnection=function(a){p.debug("peerConnection.onclosedconnection",a);l.call(f)};L()}function L(){if("function"===typeof f)try{f()}catch(a){p.error("initPeerConnection.callback",a)}}e=c;m?L():n.call(this,u(h))}function x(b){try{var c=
b.name,d=b.config,e=d?d.reliable:null,f;!0===e||!1===e?f=m.createDataChannel(c,{reliable:e?!0:!1}):a.webrtc.supports.sctp?(f=m.createDataChannel(b.name,{reliable:!0}),f.binaryType="arraybuffer"):f=m.createDataChannel(b.name,{reliable:!1});var t=new a.DataChannel(f,this);G.push(t);this.trigger(a.Connection.events.dataChannelCreated,{connection:this,channel:t})}catch(g){c=new a.CommonError("createDataChannel","Can't create DataChannel.",g),p.error("createDataChannel",c),this.trigger(a.Connection.events.dataChannelCreationError,
{connection:this,channelConfig:b,error:c})}}function s(){p.debug("sendIceCandidates",'Sending "'+I.length+'" ice candidates.');for(var b=0,c=I.length;b<c;b++){var d=I[b];J.sendIce(e.id,M,JSON.stringify(d));this.trigger(a.Connection.events.iceSent,{connection:this,iceCandidate:d})}I=[]}function n(a){"function"===typeof a&&(F?a(F):C.getIceServers(K,function(b){F=b;a(F)}))}function y(c){p.debug("Ice candidate was received.",c);c=new b.RTCIceCandidate(JSON.parse(c.iceCandidate));m.addIceCandidate(c);
this.trigger(a.Connection.events.iceAdded,{connection:this,iceCandidate:c})}function A(c){p.debug("Offer was received.",c);this.trigger(a.Connection.events.offerReceived,{user:e,connection:this,offerData:c});this.trigger(a.Connection.events.connectionOpening,{user:e,connection:this});F=c.iceServers;w.call(this,e,u(function(){for(var d=0,f=B.length;d<f;d++)m.addStream(B[d].getStream());m.setRemoteDescription(new b.RTCSessionDescription(JSON.parse(c.offer)));H=new h.IceCandidateFilter(c.connectionType,
F);m.createAnswer(u(function(d){if(!P&&m){b.detectedBrowser===b.supportedBrowsers.firefox&&(d.sdp=H.filterSDP(d.sdp));p.debug("onCreateAnswerSuccess",d);m.setLocalDescription(d);var f={answer:JSON.stringify(d),acceptData:c.acceptData};p.debug("sendAnswer",c,d);J.sendAnswer(e.id,M,f);this.trigger(a.Connection.events.answerSent,{user:e,connection:this,answerData:f});this.trigger(a.Connection.events.connectionEstablishing,{user:e,connection:this});N=!0;s.call(this)}}),u(function(b){b=new a.CommonError("sendAnswer",
"Cannot create WebRTC answer",b);p.error("sendAnswer",b);this.trigger(a.Connection.events.createAnswerError,{connection:this,error:b})}),a.Connection.settings.answerOptions)}))}function v(c){p.debug("Answer was received.",c);this.trigger(a.Connection.events.answerReceived,{user:e,connection:this,answerData:{answer:c}});this.trigger(a.Connection.events.connectionEstablishing,{user:e,connection:this});N=!0;s.call(this);m.setRemoteDescription(new b.RTCSessionDescription(JSON.parse(c.answer)))}function z(){p.debug("Bye was received");
l.call(this)}function l(){b.detectedBrowser===b.supportedBrowsers.firefox&&O&&(d.clearInterval(O),O=null);if(!P){P=!0;var c=e;m&&(m.onicecandidate=null,m.close(),m=null,I=[],F=null,Q=N=!1,e=null);this.trigger(a.Connection.events.connectionClosed,{user:c,connection:this})}}function t(){return m&&(m.iceConnectionState||m.iceState)||"notinitialized"}var u=a.Class.proxy(this),p=new a.Logger(this.className),K=f,C=q||new xRtc.AuthManager,B=[],D=[],G=[],L=[],m=null,O=null,E=null,J=k,H=null,F=null,N=!1,I=
[],M=g,Q=!1,P=!1;(function(){var b=a.HandshakeController.events;J.on(b.receiveIce,u(y)).on(b.receiveOffer,u(A)).on(b.receiveAnswer,u(v)).on(b.receiveBye,u(z))}).call(this);a.Class.extend(this,a.EventDispatcher,{_logger:p,getId:function(){return M},getRemoteUser:function(){return e},_open:function(d){Q=!0;var f=this,t={};a.Class.extend(t,a.Connection.settings.offerOptions);d&&d.offer&&a.Class.extend(t,d.offer);f.trigger(a.Connection.events.connectionOpening,{user:e,connection:f});w.call(f,e,u(function(){for(var g=
0,k=B.length;g<k;g++)m.addStream(B[g].getStream());g=0;for(k=L.length;g<k;g++)x.call(this,L[g]);H=new h.IceCandidateFilter(d&&d.connectionType||null,F);m.createOffer(u(function(d){if(!P&&m){b.detectedBrowser===b.supportedBrowsers.firefox&&(d.sdp=H.filterSDP(d.sdp));p.debug("onCreateOfferSuccess",d);m.setLocalDescription(d);b.detectedBrowser===b.supportedBrowsers.firefox&&21>=b.detectedBrowserVersion&&(d.sdp=-1==d.sdp.indexOf("a=crypto")?d.sdp.replace(/c=IN/g,"a=crypto:1 AES_CM_128_HMAC_SHA1_80 inline:FakeFakeFakeFakeFakeFakeFakeFakeFakeFake\r\nc=IN"):
d.sdp);var t={offer:JSON.stringify(d),connectionData:c,connectionType:H.getType(),iceServers:F};p.debug("sendOffer",e.id,d);J.sendOffer(e.id,M,t);f.trigger(a.Connection.events.offerSent,{user:e,connection:this,offerData:t})}}),u(function(b){b=new a.CommonError("startSession","Cannot create WebRTC offer",b);p.error("onCreateOfferError",b);f.trigger(a.Connection.events.createOfferError,{connection:f,error:b})}),t)}))},close:function(a){J&&e&&J.sendBye(e.id,M,a);l.call(this)},addStream:function(b){Q&&
r("addStream");B.push(b);b={user:{id:K.name,name:K.name},connection:this,stream:b};p.debug("addLocalStream",b);this.trigger(a.Connection.events.localStreamAdded,b)},createDataChannel:function(b,c){if(!b||b.constructor!==d.String)throw new a.CommonError("DataChannel name is incorrect type or not defined.");Q&&r("createDataChannel");L.push({name:b,config:c})},getData:function(){return c},getState:function(){var a=0<B.length;return{notinitialized:a?"ready":"not-ready","new":a?"ready":"not-ready",opening:"connecting",
active:"connected",closing:"disconnecting",closed:a?"ready":"not-ready",stable:"connected","have-local-offer":"ready","have-remote-offer":"connecting"}[m&&(m.signalingState||m.readyState)||"notinitialized"]},getLocalStreams:function(){return B.map(function(a){return a})},getRemoteStreams:function(){return D.map(function(a){return a})},getDataChannels:function(){return G.map(function(a){return a})}})});a.Connection.extend({events:{connectionOpening:"connectionopening",connectionEstablishing:"connectionestablishing",
connectionEstablished:"connectionestablished",connectionClosed:"connectionclosed",localStreamAdded:"localstreamadded",remoteStreamAdded:"remotestreamadded",dataChannelCreated:"datachannelcreated",dataChannelCreationError:"datachannelcreationerror",stateChanged:"statechanged",createOfferError:"createoffererror",offerSent:"offersent",offerReceived:"offerreceived",createAnswerError:"createanswererror",answerSent:"answersent",answerReceived:"answerreceived",iceSent:"icesent",iceAdded:"iceadded"},connectionTypes:{"default":"default",
direct:"direct",server:"server"},settings:{offerOptions:{optional:[],mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}},answerOptions:{optional:[],mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}},peerConnectionOptions:{optional:[{RtpDataChannels:!a.webrtc.supports.sctp},{DtlsSrtpKeyAgreement:!0}]}}});b.RTCPeerConnection.prototype&&!b.RTCPeerConnection.prototype.getLocalStreams&&a.Class.extend(b.RTCPeerConnection.prototype,{getLocalStreams:function(){return this.localStreams},getRemoteStreams:function(){return this.remoteStreams}});
b.MediaStream.prototype.getVideoTracks||(b.detectedBrowser===b.supportedBrowsers.firefox?a.Class.extend(b.MediaStream.prototype,{getVideoTracks:function(){return[]},getAudioTracks:function(){return[]}}):a.Class.extend(b.MediaStream.prototype,{getVideoTracks:function(){return this.videoTracks},getAudioTracks:function(){return this.audioTracks}}))})(window);(function(d){"undefined"===typeof d.xRtc&&(d.xRtc={});var a=d.xRtc;a.Class(a,"HandshakeController",function(){var d=new a.Logger(this.className);a.Class.extend(this,a.EventDispatcher,{_logger:d,sendIce:function(b,d,f){this.trigger(a.HandshakeController.events.sendIce,b,d,f)},sendOffer:function(b,d,f){this.trigger(a.HandshakeController.events.sendOffer,b,d,f)},sendAnswer:function(b,d,f){this.trigger(a.HandshakeController.events.sendAnswer,b,d,f)},sendBye:function(b,d,f){this.trigger(a.HandshakeController.events.sendBye,
b,d,f)}})});a.HandshakeController.extend({events:{sendIce:"sendice",sendOffer:"sendoffer",sendAnswer:"sendanswer",sendBye:"sendbye",receiveIce:"receiveice",receiveOffer:"receiveoffer",receiveAnswer:"receiveanswer",receiveBye:"receivebye"}})})(window);(function(d){"undefined"===typeof d.xRtc&&(d.xRtc={});var a=d.xRtc;a.Class(a,"ServerConnector",function(h){function b(b,d){var c={eventName:b.eventName};"undefined"!==typeof b.data&&(c.data=b.data);"undefined"!==typeof b.targetUserId&&(c.targetUserId=b.targetUserId.toString());var e=JSON.stringify(c);y&&1===y.readyState?(n.debug("send",c,e),y.send(e)):d?n.debug("send","The call was ignored because no server connection.",c,e):(c=new a.CommonError("send","Trying to call method without established connection",
"WebSocket is not connected!"),n.error("send",c))}function g(b,c){try{if(b=JSON.parse(b),n.debug("getWebSocketURL",b),b&&b.e&&""!=b.e){var d=new a.CommonError("getWebSocketURL","Error occured while getting the URL of WebSockets",b.e);n.error("getWebSocketURL",d);this.trigger(l.serverError,{error:d})}else{var e=b.d.value;n.info("getWebSocketURL",e);"function"===typeof c&&c(e)}}catch(f){this.ajax(a.ServerConnector.settings.URL,"POST","",s(g,c))}}function f(a,b){y=new WebSocket(a+"/ws/"+encodeURIComponent(b));
y.onopen=s(e);y.onclose=s(k);y.onerror=s(q);y.onmessage=s(c)}function e(a){a={event:a};n.debug("open",a);v&&(z=x.call(this,v));this.trigger(l.connectionOpen,a)}function k(a){z&&(d.clearInterval(z),z=null);a={event:a};n.debug("close",a);this.trigger(l.connectionClose,a);y=null}function q(b){b=new a.CommonError("onerror","WebSocket has got an error",b);n.error("error",b);this.trigger(l.connectionError,{error:b})}function c(a){var b={message:a};n.debug("message",b);this.trigger(l.message,b);if(r(a))if(a=
w(a),b=a.type,b==l.usersUpdated||b==l.userConnected||b==l.userDisconnected)if(b==l.usersUpdated){for(var b=[],c=0,d=a.message.users.length;c<d;c++)b.push({id:a.message.users[c],name:a.message.users[c]});this.trigger(l.usersUpdated,{users:b})}else b==l.userConnected?this.trigger(l.userConnected,{user:{id:a.message,name:a.message}}):b==l.userDisconnected&&this.trigger(l.userDisconnected,{user:{id:a.message,name:a.message}});else if(b==l.receiveOffer||b==l.receiveAnswer||b==l.receiveIce||b==l.receiveBye)b==
l.receiveOffer?this.trigger(l.receiveOffer,{senderId:a.userid,receiverId:a.message.targetUserId,connectionId:a.message.data.connectionId,offer:a.message.data.offer.offer,iceServers:a.message.data.offer.iceServers,connectionType:a.message.data.offer.connectionType,connectionData:a.message.data.offer.connectionData}):b==l.receiveAnswer?this.trigger(l.receiveAnswer,{senderId:a.userid,connectionId:a.message.data.connectionId,answer:a.message.data.answer.answer,acceptData:a.message.data.answer.acceptData}):
b==l.receiveIce?this.trigger(l.receiveIce,{senderId:a.userid,connectionId:a.message.data.connectionId,iceCandidate:a.message.data.iceCandidate}):b==l.receiveBye&&this.trigger(l.receiveBye,{senderId:a.userid,connectionId:a.message.data.connectionId,byeData:a.message.data.byeData})}function r(a){var b=!0;'"Token invalid"'===a.data&&(b=!1,this.trigger(l.tokenInvalid,{token:A}));return b}function w(b){var c;try{c=JSON.parse(b.data)}catch(d){c=null;var e=new a.CommonError("parseServerMessage","Message format error",
d);n.error("parseServerMessage",e,b);this.trigger(l.messageFormatError,{error:e})}return c}function x(a){return d.setInterval(function(){b.call(this,{})},a)}var s=a.Class.proxy(this),n=new a.Logger(this.className),y=null,A=null,v=h?h.pingInterval:5E3,z=null,l=a.ServerConnector.events;a.Class.extend(this,a.EventDispatcher,a.Ajax,{_logger:n,connect:function(b){A=b;b=s(f,b);this.ajax(a.ServerConnector.settings.URL,"POST","",s(g,b))},disconnect:function(){y?(y.close(),A=y=null,n.info("disconnect","Connection with WS has been broken")):
n.debug("disconnect","Connection with WS has not been established yet")},sendOffer:function(a,c,d){b({eventName:l.receiveOffer,targetUserId:a,data:{connectionId:c,offer:d||{}}})},sendAnswer:function(a,c,d){b({eventName:l.receiveAnswer,targetUserId:a,data:{connectionId:c,answer:d||{}}})},sendIce:function(a,c,d){b({eventName:l.receiveIce,targetUserId:a,data:{connectionId:c,iceCandidate:d}})},sendBye:function(a,c,d){b({eventName:l.receiveBye,targetUserId:a,data:{connectionId:c,byeData:d||{}}},!0)}})});
a.ServerConnector.extend({events:{connectionOpen:"connectionopen",connectionClose:"connectionclose",connectionError:"connectionerror",message:"message",messageFormatError:"messageformaterror",serverError:"servererror",tokenInvalid:"tokeninvalid",receiveOffer:"receiveoffer",receiveAnswer:"receiveanswer",receiveIce:"receiveice",receiveBye:"receivebye",usersUpdated:"peers",userConnected:"peer_connected",userDisconnected:"peer_removed"},settings:{URL:"https://api.xirsys.com/wsList"}})})(window);(function(d){"undefined"===typeof d.xRtc&&(d.xRtc={});var a=d.xRtc;a.Class(a,"Room",function(d,b,g){function f(){var b=this;l||(C.on(v.connectionOpen,n(function(b){this.trigger(a.Room.events.enter)})).on(v.connectionClose,n(function(b){this.trigger(a.Room.events.leave)})).on(v.tokenInvalid,n(function(b){this.trigger(a.Room.events.tokenInvalid,b)})).on(v.usersUpdated,n(function(b){z=b.users;z.sort(c);this.trigger(a.Room.events.usersUpdated,{users:this.getUsers()})})).on(v.userConnected,n(function(b){z.push(b.user);
z.sort(c);this.trigger(a.Room.events.userConnected,{user:b.user})})).on(v.userDisconnected,n(function(b){z.splice(s(z,b.user.id),1);z.sort(c);this.trigger(a.Room.events.userDisconnected,{user:b.user})})).on(v.receiveOffer,n(e)).on(v.receiveBye,n(k)).on(v.receiveAnswer,function(c){if(c.senderId&&c.connectionId){var d=r(c.senderId);if(d){var e=D[c.connectionId];e?e.userId===d.id&&(b.trigger(a.Room.events.connectionAccepted,{user:d,connection:w(c.connectionId),data:c.acceptData}),e.hc.trigger(A.receiveAnswer,
{connectionId:c.connectionId,answer:c.answer})):C.sendBye(c.senderId,c.connectionId,{type:G.decline,data:"Remote connection not found."})}}}).on(v.receiveIce,function(a){if(a.senderId&&a.connectionId){var b=D[a.connectionId];b&&b.userId===a.senderId&&b.hc.trigger(A.receiveIce,{iceCandidate:a.iceCandidate,connectionId:a.connectionId})}}),l=!0)}function e(b){function c(a){q.call(e,b.connectionId,p,r(b.senderId),b.connectionData,function(c){c.handshakeController.trigger(A.receiveOffer,{offer:b.offer,
iceServers:b.iceServers,connectionType:b.connectionType,connectionId:b.connectionId,connectionData:b.connectionData,acceptData:a})})}function d(a){C.sendBye(b.senderId,b.connectionId,{type:G.decline,data:a})}if(b.senderId&&b.connectionId){var e=this,f={user:r(b.senderId),connectionId:b.connectionId,data:b.connectionData};t.autoReply||(f.accept=n(c),f.decline=n(d));D[b.connectionId]={userId:b.senderId,hc:null};this.trigger(a.Room.events.incomingConnection,f);t.autoReply&&c.call(e)}}function k(b){if(b.senderId&&
b.connectionId){var c=r(b.senderId);if(c){var d=D[b.connectionId];d&&d.userId===c.id&&((b.byeData&&b.byeData.type===G.decline||!d.hc)&&this.trigger(a.Room.events.connectionDeclined,{user:c,connectionId:b.connectionId,data:b.byeData}),d.hc&&d.hc.trigger(A.receiveBye))}}}function q(b,c,d,e,f){var g=new a.HandshakeController;c=new xRtc.Connection(b,c,d,g,K,e);D[b]?D[b].hc=g:D[b]={userId:d.id,hc:g};g.on(A.sendOffer,n(function(a,b,c){C.sendOffer(a,b,c)})).on(A.sendAnswer,n(function(a,b,c){C.sendAnswer(a,
b,c)})).on(A.sendIce,n(function(a,b,c){C.sendIce(a,b,c)})).on(A.sendBye,n(function(a,b,c){C.sendBye(a,b,c)}));c.on(a.Connection.events.connectionClosed,function(){B.splice(x(B,b),1);delete D[b]});B.push(c);this.trigger(a.Room.events.connectionCreated,{user:d,connection:c});"function"===typeof f&&f({connection:c,handshakeController:g})}function c(a,b){var c=0;a.name<b.name?c=-1:a.name>b.name&&(c=1);return c}function r(a){for(var b=null,c=0,d=z.length;c<d;c++)if(z[c].id===a){b=z[c];break}return b}function w(a){for(var b=
null,c=0,d=B.length;c<d;c++)if(B[c].getId()===a){b=B[c];break}return b}function x(a,b){for(var c=-1,d=0,e=a.length;d<e;d++)if(a[d].getId()===b){c=d;break}return c}function s(a,b){for(var c=-1,d=0,e=a.length;d<e;d++)a[d].id===b&&(c=d);return c}var n=a.Class.proxy(this),y=new a.Logger(this.className),A=a.HandshakeController.events,v=a.ServerConnector.events,z=[],l=!1,t={},u={},p=null,K=b||new xRtc.AuthManager,C=g||new a.ServerConnector,B=[],D={},G={decline:"decline"};a.Class.extend(u,a.Room.settings.info);
"string"===typeof d?u.name=d:a.Class.extend(u,d);a.Class.extend(this,a.EventDispatcher,{_logger:y,enter:function(b,c){var d="",e="";if(!b)throw new a.CommonError("enter","User credentials should be specified.");"string"===typeof b?d=b:(d=b.username,e=b.password);f.call(this);a.Class.extend(t,a.Room.settings.enterOptions);c&&a.Class.extend(t,c);p={domain:u.domain,application:u.application,room:u.name,name:d,password:e};K.getToken(p,function(a){u.user={id:null,name:d};C.connect(a)})},leave:function(){C.on(a.ServerConnector.events.connectionClose,
function(){l&&(C.off(v.connectionOpen).off(v.connectionClose).off(v.tokenInvalid).off(v.usersUpdated).off(v.userConnected).off(v.userDisconnected).off(v.receiveOffer).off(v.receiveBye).off(v.receiveAnswer).off(v.receiveIce),l=!1);t={};p=null;u.user=null;z=[];B=[];D={}});C.disconnect()},connect:function(b,c){if(!u.user)throw new a.CommonError("connect","Need to enter the room before you connect someone.");var d=r(b);if(null==d)d=a.CommonError("connect","Target user not found."),this.trigger(a.Room.events.error,
{userId:b,error:d});else{var e=c&&c.data?c.data:null,f=c&&c.id?c.id:a.utils.newGuid();q.call(this,f,p,d,e,function(a){a=a.connection;c&&"auto"===c.createDataChannel&&a.createDataChannel("autoDataChannel");a._open(c)})}},getInfo:function(){return u},getConnections:function(){return B.map(function(a){return a})},getUsers:function(){return z.map(function(a){return a})}})});a.Room.extend({events:{enter:"enter",leave:"leave",incomingConnection:"incomingconnection",connectionCreated:"connectioncreated",
connectionAccepted:"connectionaccepted",connectionDeclined:"connectiondeclined",usersUpdated:"usersupdated",userConnected:"userconnected",userDisconnected:"userdisconnected",tokenInvalid:"tokeninvalid",error:"error"},settings:{info:{domain:d.document.domain,application:"default",name:"default"},enterOptions:{autoReply:!0}}})})(window);(function(d){"undefined"===typeof d.xRtc&&(d.xRtc={});var a=d.xRtc,h=a.webrtc,b=new a.Logger("UserMedia"),g=function(d,e,g){h.getUserMedia(d,function(b){"function"===typeof e&&e(new a.Stream(b))},function(d){"function"===typeof g&&(d=new a.CommonError("getUserMedia","Can't get media stream. "+(d.message&&""!==d.message?d.message:d.name)+". Need to unlock camera/mic access if it was blocked before. For unblocking see special icon in the right corner of the address input of the browser."),b.error("onCreateOfferError",
d),g(d))})};a.getUserMedia=function(d,e,k){if(d&&!d.video&&!d.audio){var q=new a.CommonError("getUserMedia","video or audio property of the options parameter should be specified. No sense to create media stream without video and audio components.");b.error("onCreateOfferError",q)}d=d?a.utils.clone(d):{video:!0,audio:!0};if(d.video&&d.video.mandatory&&"screen"===d.video.mandatory.mediaSource){var c=d.audio;d.audio=!1;delete d.video.mandatory.mediaSource;d.video.mandatory.chromeMediaSource="screen";
g.call(this,d,function(a){c?g.call(this,{audio:!0},function(b){function c(a,b){for(var d=0;d<b.length;d++)a.push(b[d])}var d=[];c(d,b.getAudioTracks());c(d,a.getVideoTracks());e(new h.MediaStream(d))},k):e(a)},k)}else g.call(this,d,e,k)}})(window);
