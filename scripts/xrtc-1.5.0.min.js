(function(d){function a(){this._pieces=[];this._parts=[]}function k(c){this.index=0;this.dataBuffer=c;this.dataView=new Uint8Array(this.dataBuffer);this.length=this.dataBuffer.byteLength}function b(){this.bufferBuilder=new a}function h(c){c=c.charCodeAt(0);return 2047>=c?"00":65535>=c?"000":2097151>=c?"0000":67108863>=c?"00000":"000000"}var f={},e;try{new Blob([]),e=!1}catch(g){e=!0}f.useBlobBuilder=e;if(e=!f.useBlobBuilder)try{e=0===(new Blob([new Uint8Array([])])).size}catch(r){e=!0}f.useArrayBufferView=
e;d.binaryFeatures=f;d.BlobBuilder=window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder||window.BlobBuilder;a.prototype.append=function(c){"number"===typeof c?this._pieces.push(c):(this.flush(),this._parts.push(c))};a.prototype.flush=function(){if(0<this._pieces.length){var c=new Uint8Array(this._pieces);f.useArrayBufferView||(c=c.buffer);this._parts.push(c);this._pieces=[]}};a.prototype.getBuffer=function(){this.flush();if(f.useBlobBuilder){for(var c=new BlobBuilder,a=0,b=this._parts.length;a<
b;a++)c.append(this._parts[a]);return c.getBlob()}return new Blob(this._parts)};d.BinaryPack={unpack:function(c){return(new k(c)).unpack()},pack:function(c){var a=new b;a.pack(c);return a.getBuffer()}};k.prototype.unpack=function(){var c=this.unpack_uint8();if(128>c)return c;if(32>(c^224))return(c^224)-32;var a;if(15>=(a=c^160))return this.unpack_raw(a);if(15>=(a=c^176))return this.unpack_string(a);if(15>=(a=c^144))return this.unpack_array(a);if(15>=(a=c^128))return this.unpack_map(a);switch(c){case 192:return null;
case 194:return!1;case 195:return!0;case 202:return this.unpack_float();case 203:return this.unpack_double();case 204:return this.unpack_uint8();case 205:return this.unpack_uint16();case 206:return this.unpack_uint32();case 207:return this.unpack_uint64();case 208:return this.unpack_int8();case 209:return this.unpack_int16();case 210:return this.unpack_int32();case 211:return this.unpack_int64();case 216:return a=this.unpack_uint16(),this.unpack_string(a);case 217:return a=this.unpack_uint32(),this.unpack_string(a);
case 218:return a=this.unpack_uint16(),this.unpack_raw(a);case 219:return a=this.unpack_uint32(),this.unpack_raw(a);case 220:return a=this.unpack_uint16(),this.unpack_array(a);case 221:return a=this.unpack_uint32(),this.unpack_array(a);case 222:return a=this.unpack_uint16(),this.unpack_map(a);case 223:return a=this.unpack_uint32(),this.unpack_map(a)}};k.prototype.unpack_uint8=function(){var c=this.dataView[this.index]&255;this.index++;return c};k.prototype.unpack_uint16=function(){var c=this.read(2),
c=256*(c[0]&255)+(c[1]&255);this.index+=2;return c};k.prototype.unpack_uint32=function(){var c=this.read(4),c=256*(256*(256*c[0]+c[1])+c[2])+c[3];this.index+=4;return c};k.prototype.unpack_uint64=function(){var c=this.read(8),c=256*(256*(256*(256*(256*(256*(256*c[0]+c[1])+c[2])+c[3])+c[4])+c[5])+c[6])+c[7];this.index+=8;return c};k.prototype.unpack_int8=function(){var c=this.unpack_uint8();return 128>c?c:c-256};k.prototype.unpack_int16=function(){var c=this.unpack_uint16();return 32768>c?c:c-65536};
k.prototype.unpack_int32=function(){var c=this.unpack_uint32();return c<Math.pow(2,31)?c:c-Math.pow(2,32)};k.prototype.unpack_int64=function(){var c=this.unpack_uint64();return c<Math.pow(2,63)?c:c-Math.pow(2,64)};k.prototype.unpack_raw=function(c){if(this.length<this.index+c)throw Error("BinaryPackFailure: index is out of range "+this.index+" "+c+" "+this.length);var a=this.dataBuffer.slice(this.index,this.index+c);this.index+=c;return a};k.prototype.unpack_string=function(c){for(var a=this.read(c),
b=0,e="",g;b<c;)g=a[b],128>g?(e+=String.fromCharCode(g),b++):32>(g^192)?(g=(g^192)<<6|a[b+1]&63,e+=String.fromCharCode(g),b+=2):(g=(g&15)<<12|(a[b+1]&63)<<6|a[b+2]&63,e+=String.fromCharCode(g),b+=3);this.index+=c;return e};k.prototype.unpack_array=function(c){for(var a=Array(c),b=0;b<c;b++)a[b]=this.unpack();return a};k.prototype.unpack_map=function(c){for(var a={},b=0;b<c;b++){var g=this.unpack(),e=this.unpack();a[g]=e}return a};k.prototype.unpack_float=function(){var c=this.unpack_uint32();return(0==
c>>31?1:-1)*(c&8388607|8388608)*Math.pow(2,(c>>23&255)-127-23)};k.prototype.unpack_double=function(){var c=this.unpack_uint32(),a=this.unpack_uint32(),b=c>>31,g=(c>>20&2047)-1023,c=(c&1048575|1048576)*Math.pow(2,g-20)+a*Math.pow(2,g-52);return(0==b?1:-1)*c};k.prototype.read=function(c){var a=this.index;if(a+c<=this.length)return this.dataView.subarray(a,a+c);throw Error("BinaryPackFailure: read index out of range");};b.prototype.getBuffer=function(){return this.bufferBuilder.getBuffer()};b.prototype.pack=
function(c){var a=typeof c;if("string"==a)this.pack_string(c);else if("number"==a)Math.floor(c)===c?this.pack_integer(c):this.pack_double(c);else if("boolean"==a)!0===c?this.bufferBuilder.append(195):!1===c&&this.bufferBuilder.append(194);else if("undefined"==a)this.bufferBuilder.append(192);else if("object"==a)if(null===c)this.bufferBuilder.append(192);else if(a=c.constructor,a==Array)this.pack_array(c);else if(a==Blob||a==File)this.pack_bin(c);else if(a==ArrayBuffer)f.useArrayBufferView?this.pack_bin(new Uint8Array(c)):
this.pack_bin(c);else if("BYTES_PER_ELEMENT"in c)f.useArrayBufferView?this.pack_bin(new Uint8Array(c.buffer)):this.pack_bin(c.buffer);else if(a==Object)this.pack_object(c);else if(a==Date)this.pack_string(c.toString());else if("function"==typeof c.toBinaryPack)this.bufferBuilder.append(c.toBinaryPack());else throw Error('Type "'+a.toString()+'" not yet supported');else throw Error('Type "'+a+'" not yet supported');this.bufferBuilder.flush()};b.prototype.pack_bin=function(c){var a=c.length||c.byteLength||
c.size;if(15>=a)this.pack_uint8(160+a);else if(65535>=a)this.bufferBuilder.append(218),this.pack_uint16(a);else if(4294967295>=a)this.bufferBuilder.append(219),this.pack_uint32(a);else throw Error("Invalid length");this.bufferBuilder.append(c)};b.prototype.pack_string=function(c){var a;a=600<c.length?(new Blob([c])).size:c.replace(/[^\u0000-\u007F]/g,h).length;if(15>=a)this.pack_uint8(176+a);else if(65535>=a)this.bufferBuilder.append(216),this.pack_uint16(a);else if(4294967295>=a)this.bufferBuilder.append(217),
this.pack_uint32(a);else throw Error("Invalid length");this.bufferBuilder.append(c)};b.prototype.pack_array=function(a){var b=a.length;if(15>=b)this.pack_uint8(144+b);else if(65535>=b)this.bufferBuilder.append(220),this.pack_uint16(b);else if(4294967295>=b)this.bufferBuilder.append(221),this.pack_uint32(b);else throw Error("Invalid length");for(var g=0;g<b;g++)this.pack(a[g])};b.prototype.pack_integer=function(a){if(-32<=a&&127>=a)this.bufferBuilder.append(a&255);else if(0<=a&&255>=a)this.bufferBuilder.append(204),
this.pack_uint8(a);else if(-128<=a&&127>=a)this.bufferBuilder.append(208),this.pack_int8(a);else if(0<=a&&65535>=a)this.bufferBuilder.append(205),this.pack_uint16(a);else if(-32768<=a&&32767>=a)this.bufferBuilder.append(209),this.pack_int16(a);else if(0<=a&&4294967295>=a)this.bufferBuilder.append(206),this.pack_uint32(a);else if(-2147483648<=a&&2147483647>=a)this.bufferBuilder.append(210),this.pack_int32(a);else if(-9223372036854775E3<=a&&9223372036854775E3>=a)this.bufferBuilder.append(211),this.pack_int64(a);
else if(0<=a&&1.8446744073709552E19>=a)this.bufferBuilder.append(207),this.pack_uint64(a);else throw Error("Invalid integer");};b.prototype.pack_double=function(a){var b=0;0>a&&(b=1,a=-a);var g=Math.floor(Math.log(a)/Math.LN2);a=a/Math.pow(2,g)-1;a=Math.floor(a*Math.pow(2,52));var e=Math.pow(2,32),b=b<<31|g+1023<<20|a/e&1048575,g=a%e;this.bufferBuilder.append(203);this.pack_int32(b);this.pack_int32(g)};b.prototype.pack_object=function(a){var b=Object.keys(a).length;if(15>=b)this.pack_uint8(128+b);
else if(65535>=b)this.bufferBuilder.append(222),this.pack_uint16(b);else if(4294967295>=b)this.bufferBuilder.append(223),this.pack_uint32(b);else throw Error("Invalid length");for(var g in a)a.hasOwnProperty(g)&&(this.pack(g),this.pack(a[g]))};b.prototype.pack_uint8=function(a){this.bufferBuilder.append(a)};b.prototype.pack_uint16=function(a){this.bufferBuilder.append(a>>8);this.bufferBuilder.append(a&255)};b.prototype.pack_uint32=function(a){a&=4294967295;this.bufferBuilder.append((a&4278190080)>>>
24);this.bufferBuilder.append((a&16711680)>>>16);this.bufferBuilder.append((a&65280)>>>8);this.bufferBuilder.append(a&255)};b.prototype.pack_uint64=function(a){var b=a/Math.pow(2,32);a%=Math.pow(2,32);this.bufferBuilder.append((b&4278190080)>>>24);this.bufferBuilder.append((b&16711680)>>>16);this.bufferBuilder.append((b&65280)>>>8);this.bufferBuilder.append(b&255);this.bufferBuilder.append((a&4278190080)>>>24);this.bufferBuilder.append((a&16711680)>>>16);this.bufferBuilder.append((a&65280)>>>8);this.bufferBuilder.append(a&
255)};b.prototype.pack_int8=function(a){this.bufferBuilder.append(a&255)};b.prototype.pack_int16=function(a){this.bufferBuilder.append((a&65280)>>8);this.bufferBuilder.append(a&255)};b.prototype.pack_int32=function(a){this.bufferBuilder.append(a>>>24&255);this.bufferBuilder.append((a&16711680)>>>16);this.bufferBuilder.append((a&65280)>>>8);this.bufferBuilder.append(a&255)};b.prototype.pack_int64=function(a){var b=Math.floor(a/Math.pow(2,32));a%=Math.pow(2,32);this.bufferBuilder.append((b&4278190080)>>>
24);this.bufferBuilder.append((b&16711680)>>>16);this.bufferBuilder.append((b&65280)>>>8);this.bufferBuilder.append(b&255);this.bufferBuilder.append((a&4278190080)>>>24);this.bufferBuilder.append((a&16711680)>>>16);this.bufferBuilder.append((a&65280)>>>8);this.bufferBuilder.append(a&255)}})(this);(function(d){"undefined"===typeof d.xRtc&&(d.xRtc={});var a=d.xRtc;a.Ajax={ajax:function(k,b,d,f){var e,g;g=a.Class.proxy(this);try{e=new XMLHttpRequest}catch(r){try{e=new ActiveXObject("Msxml2.XMLHTTP")}catch(c){try{e=new ActiveXObject("Microsoft.XMLHTTP")}catch(x){this._logger&&(g=new a.CommonError("ajax","XMLHttpRequest is not supported"),this._logger.error("ajax",g));return}}}this._logger&&this._logger.debug("ajax",k,d);b=b.toUpperCase();try{var s=!1;"GET"===b?(e.open(b,k+"?"+d,!0),d=""):(e.open(b,
k,!0),e.setRequestHeader("method",b+" "+k+" HTTP/1.1"),e.setRequestHeader("content-type","application/x-www-form-urlencoded"));e.onreadystatechange=g(function(){4!=e.readyState||s||(s=!0,this._logger&&this._logger.debug("ajax",e),"function"===typeof f&&f(e.responseText))});e.send(d)}catch(v){throw g=new a.CommonError("ajax","XMLHttpRequest exception",v),g.data={url:k,method:b,params:d},this._logger&&this._logger.error("ajax",g),g;}}}})(window);(function(d){"undefined"===typeof d.xRtc&&(d.xRtc={});d.xRtc.EventDispatcher={on:function(a,d){this._logger&&this._logger.info("on",arguments);this._events=this._events||{};this._events[a]=this._events[a]||[];this._events[a].push(d);return this},off:function(a){this._logger&&this._logger.info("off",arguments);this._events=this._events||{};this._events[a]=this._events[a]||[];delete this._events[a];return this},trigger:function(a){this._logger&&this._logger.info("trigger",arguments);this._events=this._events||
{};var d=this._events[a];if(!d)return this._logger.warning("trigger","Trying to call event which is not listening. Event name is '"+a+"'"),this;for(var b=Array.prototype.slice.call(arguments,1),h=0,f=d.length;h<f;h++)d[h].apply(null,b);return this}}})(window);(function(d){"undefined"===typeof d.xRtc&&(d.xRtc={});var a=d.xRtc;a.webrtc={getUserMedia:(navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia||navigator.getUserMedia).bind(navigator),RTCPeerConnection:d.mozRTCPeerConnection||d.webkitRTCPeerConnection||d.RTCPeerConnection,RTCIceCandidate:d.mozRTCIceCandidate||d.RTCIceCandidate,RTCSessionDescription:d.mozRTCSessionDescription||d.RTCSessionDescription,URL:d.webkitURL||d.msURL||d.oURL||d.URL,MediaStream:d.mozMediaStream||
d.webkitMediaStream||d.MediaStream,supportedBrowsers:{chrome:"chrome",firefox:"firefox"}};a.webrtc.detectedBrowser=navigator.mozGetUserMedia?a.webrtc.supportedBrowsers.firefox:a.webrtc.supportedBrowsers.chrome;a.webrtc.detectedBrowserVersion=a.webrtc.detectedBrowser===a.webrtc.supportedBrowsers.firefox?parseInt(d.navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1]):parseInt(d.navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./)[2]);a.webrtc.supports=function(){if("undefined"===typeof a.webrtc.RTCPeerConnection)return{};
var d=!1,b=!1,h=!1,f;try{f=new a.webrtc.RTCPeerConnection(null,{optional:[{RtpDataChannels:!0}]});d=!0;try{f.createDataChannel("_XRTCTEST",{reliable:!1});var b=!0,e=new a.webrtc.RTCPeerConnection(null,{});try{h=e.createDataChannel("_XRTCRELIABLETEST",{reliable:!0}).reliable}catch(g){}e.close()}catch(r){}}catch(c){}f&&f.close();return{media:d,data:b,sctp:h}}();a.blobSerializer={pack:BinaryPack.pack,unpack:BinaryPack.unpack};xRtc.utils={newGuid:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,
function(a){var b=16*Math.random()|0;return("x"==a?b:b&3|8).toString(16)})},clone:function(a){if(null==a||"object"!=typeof a)return a;if(a instanceof Date){var b=new Date;b.setTime(a.getTime());return b}if(a instanceof Array){for(var b=[],d=0,f=a.length;d<f;d++)b[d]=xRtc.utils.clone(a[d]);return b}if(a instanceof Object){b={};for(d in a)a.hasOwnProperty(d)&&(b[d]=xRtc.utils.clone(a[d]));return b}throw Error("Unable to copy obj! Its type isn't supported.");}}})(window);(function(d){"undefined"===typeof d.xRtc&&(d.xRtc={});d.xRtc.Class=function(a,k,b){a[k]=b;var h=a[k];h.fn=h.prototype;h.fn.className=k;h.extend=function(a){var b=a.extended;d.xRtc.Class.extend(h,a);b&&b(h)}};d.xRtc.Class.extend=function(a){for(var d=Array.prototype.slice.call(arguments,1),b=0,h=d.length;b<h;b++){var f=d[b],e;for(e in f)a[e]=f[e]}};d.xRtc.Class.property=function(a,d,b,h){"function"===typeof b&&a.__defineGetter__(d,b);"function"===typeof h&&a.__defineSetter__(d,h)};d.xRtc.Class.proxy=
function(a){return function(d){var b=[];1<arguments.length&&(b=Array.prototype.slice.call(arguments,1));return function(){for(var h=Array.prototype.slice.call(arguments),f=0;f<b.length;f++)h.push(b[f]);d.apply(a,h)}}}})(window);(function(d){"undefined"===typeof d.xRtc&&(d.xRtc={});d=d.xRtc;d.Class(d,"CommonError",function(a,d,b){this.method=a;this.message=d;this.error=b})})(window);(function(d){"undefined"===typeof d.xRtc&&(d.xRtc={});var a=d.xRtc;a.Class(a,"Logger",function(d){function b(){for(var a=[],d,e=0,g=arguments.length;e<g;e++)if(d=arguments[e],"object"===typeof d&&d instanceof Object&&"undefined"!==typeof d.length){d=b.apply(null,Array.prototype.slice.call(d));for(var r=0,c=d.length;r<c;r++)a.push(d[r])}else a.push(d);return a}a.Class.extend(this,{info:function(h){if(!0===a.Logger.level||"object"===typeof a.Logger.level&&a.Logger.level.info)"string"===typeof h?console.info("Info:\t\t",
d+"."+h,b(Array.prototype.slice.call(arguments,1))):console.info("Info:\t\t",b(Array.prototype.slice.call(arguments)))},debug:function(h){if(!0===a.Logger.level||"object"===typeof a.Logger.level&&a.Logger.level.debug)"string"===typeof h?console.debug("Debug:\t\t",d+"."+h,b(Array.prototype.slice.call(arguments,1))):console.debug("Debug:\t\t",b(Array.prototype.slice.call(arguments)))},test:function(h){if(!0===a.Logger.level||"object"===typeof a.Logger.level&&a.Logger.level.test)"string"===typeof h?
console.debug("Test:\t\t",d+"."+h,b(Array.prototype.slice.call(arguments,1))):console.debug("Test:\t\t",b(Array.prototype.slice.call(arguments)))},warning:function(h){if(!0===a.Logger.level||"object"===typeof a.Logger.level&&a.Logger.level.warning)"string"===typeof h?console.warn("Warning:\t",d+"."+h,b(Array.prototype.slice.call(arguments,1))):console.warn("Warning:\t",b(Array.prototype.slice.call(arguments)))},error:function(h){if(!0===a.Logger.level||"object"===typeof a.Logger.level&&a.Logger.level.error)"string"===
typeof h?console.error("Error:\t\t",d+"."+h,b(Array.prototype.slice.call(arguments,1))):console.error("Error:\t\t",b(Array.prototype.slice.call(arguments)))}})});a.Logger.extend({level:!1,enable:function(a){this.level="undefined"===typeof a?!0:a},disable:function(){this.level=!1}})})(window);(function(d){"undefined"===typeof d.xRtc&&(d.xRtc={});var a=d.xRtc;a.Class(a,"AuthManager",function(){function d(a){return["domain="+a.domain,"application="+a.application,"room="+a.room,"username="+a.name,"password="+a.password]}function b(b,d,c){var f=this;try{e.debug("getToken",b);""===b&&(e.error("getToken","Server returned an empty response."),f.trigger(a.AuthManager.events.serverError,"Server returned an empty response."));try{b=JSON.parse(b),e.debug("getToken",b)}catch(h){throw e.error("getToken",
b),h;}if(b&&b.e&&""!=b.e){var k=new a.CommonError("getToken",b.e);e.error("getToken",k);f.trigger(a.AuthManager.events.serverError,k)}else{var q=b.d.token;q?(e.info("getToken",q),"function"===typeof c&&c(q)):(e.error("getToken",b.d),f.trigger(a.AuthManager.events.serverError,b.d))}}catch(n){e.error("getToken. The request will be repeated after "+a.AuthManager.settings.unsuccessfulRequestRepeatTimeout/1E3+" sec.",n),setTimeout(function(){f.getToken(d,c)},a.AuthManager.settings.unsuccessfulRequestRepeatTimeout)}}
function h(b,d,c){var f=this;try{if(b=JSON.parse(b),e.debug("getIceServers",b),b&&b.e&&""!=b.e){var h=new a.CommonError("getIceServers",b.e);e.error("getIceServers",h);f.trigger(a.AuthManager.events.serverError,h)}else{var k=b.d.iceServers?b.d.iceServers.map(function(a){var c={};a.url&&(c.url=a.url);a.credential&&(c.credential=a.credential);a.username&&(c.username=a.username);return c}):[];e.info("getIceServers",k);"function"===typeof c&&c(k)}}catch(q){e.error("getIceServers. The request will be repeated after "+
a.AuthManager.settings.unsuccessfulRequestRepeatTimeout/1E3+" sec.",q),setTimeout(function(){f.getIceServers(d,c)},a.AuthManager.settings.unsuccessfulRequestRepeatTimeout)}}var f=a.Class.proxy(this),e=new a.Logger(this.className);a.Class.extend(this,a.Ajax,a.EventDispatcher,{_logger:e,getToken:function(e,r){var c=a.AuthManager.settings.tokenHandler,h=d.call(this,e).join("&");this.ajax(c,"POST",h,f(b,e,r))},getIceServers:function(b,e){var c=a.AuthManager.settings.iceHandler,x=d.call(this,b).join("&");
this.ajax(c,"POST",x,f(h,b,e))}})});a.AuthManager.extend({events:{serverError:"servererror"},settings:{unsuccessfulRequestRepeatTimeout:5E3,tokenHandler:"https://api.xirsys.com/getToken",iceHandler:"https://api.xirsys.com/getIceServers"}})})(window);(function(d,a){var k=a.webrtc;a.Class(a,"Stream",function(b){function h(){if(k.detectedBrowser===k.supportedBrowsers.firefox&&22>k.detectedBrowserVersion)throw new a.CommonError("setVideoEnabled","Media track muting is not supported if your Firefox browser version less then 22.");}var f=a.Class.proxy(this),e=new a.Logger(this.className),g=a.Stream.events,r=null;a.Class.property(this,"videoEnabled",function(){var a=b.getVideoTracks();return this.videoAvailable&&a[0].enabled},function(a){h();for(var d=
b.getVideoTracks(),e=0,g=d.length;e<g;e++)d[e].enabled=a});a.Class.property(this,"audioEnabled",function(){var a=b.getAudioTracks();return this.audioAvailable&&a[0].enabled},function(a){h();for(var d=b.getAudioTracks(),e=0,g=d.length;e<g;e++)d[e].enabled=a});a.Class.property(this,"videoAvailable",function(){return 0<b.getVideoTracks().length});a.Class.property(this,"audioAvailable",function(){return 0<b.getAudioTracks().length});b.onended=f(function(a){a={id:a.srcElement.id};e.debug("ended",a);this.trigger(g.ended,
a)});a.Class.extend(this,a.EventDispatcher,{_logger:e,getStream:function(){return b},stop:function(){b.stop()},getId:function(){r||(r=b.id?b.id:a.utils.newGuid());return r},getURL:function(){return k.URL.createObjectURL(b)},assignTo:function(a){this.videoAvailable||this.audioAvailable||0<b.currentTime?(k.detectedBrowser===k.supportedBrowsers.firefox?a.mozSrcObject=b:a.src=this.getURL(),a.play()):d.setTimeout(f(this.assignTo,a),100)}})});a.Stream.extend({events:{ended:"ended"}})})(window,xRtc);(function(d){function a(a){this._sender=a}function k(a,b){var c=new d.FileReader;c.onload=function(a){b(a.target.result)};c.readAsArrayBuffer(a)}function b(a,b){this._sender=a;this.chunkSize=b}function h(a){this._sender=a}function f(a,b){this._sender=a;this._attemptsMaxCount=b;this._buffer=[];this._sendImmediately=!0}"undefined"===typeof d.xRtc&&(d.xRtc={});var e=d.xRtc;e.Class(e,"DataChannel",function(g,r){function c(a){var b=this,c=e.blobSerializer.unpack(a);if(1===c.total)b.trigger(v.progress,
{messageId:c.messageId,percent:100}),b.trigger(v.receivedMessage,{data:e.blobSerializer.unpack(c.data)});else{w[c.messageId]||(w[c.messageId]={data:[],count:0,total:c.total});var g=w[c.messageId];g.data[c.index]=c.data;g.count+=1;0!==g.count%q&&g.total!==g.count||b.trigger(v.progress,{messageId:c.messageId,percent:100*g.count/g.total,cancel:function(){throw"Not implemented yet.";}});g.total===g.count&&k(new d.Blob(g.data),function(a){b.trigger(v.receivedMessage,{data:e.blobSerializer.unpack(a)});
delete g[c.messageId]})}}var x=e.Class.proxy(this),s=new e.Logger(this.className),v=e.DataChannel.events,q=10,n=new a(new b(new a(new h(new f(g,100))),16300)),w={};g.onopen=x(function(a){a={event:a};s.debug("open",a);this.trigger(v.open,a)});g.onmessage=x(function(a){var b=this;s.debug("message",a.data);var e=a.data.constructor;e===d.ArrayBuffer?c.call(b,a.data):e===d.Blob&&k(a.data,function(a){c.call(b,a)})});g.onclose=x(function(a){a={event:a};s.debug("close",a);this.trigger(v.close,a)});g.onerror=
x(function(a){a=new e.CommonError("onerror","DataChannel error.",a);s.error("error",a);this.trigger(v.error,a)});g.ondatachannel=x(function(a){a={event:a};s.debug("datachannel",a);this.trigger(v.dataChannel,a)});e.Class.extend(this,e.EventDispatcher,{_logger:s,getId:function(){return r.getId()+this.getName()},getRemoteUser:function(){return r.getRemoteUser()},getConnection:function(){return r},getName:function(){return g.label},getState:function(){return g.readyState.toLowerCase()},send:function(a,
b,c,d){var g=this,f=g.getState();f!==e.DataChannel.states.open&&(f=new e.CommonError("send",'DataChannel should be opened before sending some data. Current channel state is "'+f+'"'),s.error("error",f),g.trigger(v.error,f));s.info("send",a);n.send(a,function(){var c={data:a};"function"===typeof b&&b(c);g.trigger(v.sentMessage,c)},function(a){a=new e.CommonError("send","DataChannel error.",a);s.error("error",a);"function"===typeof c&&c(a);g.trigger(v.error,a)},function(a){0!==a.count%q&&a.count!==
a.total||g.trigger(v.progress,{messageId:a.messageId,percent:100*a.count/a.total,cancel:function(){throw"Not implemented yet.";}})},d&&d.messageId?{messageId:d.messageId}:null)}})});e.DataChannel.extend({events:{open:"open",progress:"progress",sentMessage:"sentMessage",receivedMessage:"receivedMessage",close:"close",error:"error",dataChannel:"datachannel"},states:{connecting:"connecting",open:"open",closing:"closing",closed:"closed"}});a.prototype.send=function(a,b,c,d,f){this._sender.send(e.blobSerializer.pack(a),
b,c,d,f)};b.prototype.send=function(a,b,c,d,e){this._sendChunks(this._splitToChunks(a,e),b,c,d)};b.prototype._splitToChunks=function(a,b){for(var c=b&&b.messageId?b.messageId:xRtc.utils.newGuid(),d=[],e=a.size,f=0,h=0,k=Math.ceil(e/this.chunkSize);f<e;){var w=Math.min(e,f+this.chunkSize),f={messageId:c,index:h,data:a.slice(f,w),total:k};d.push(f);f=w;h+=1}return d};b.prototype._sendChunks=function(a,b,c,d){var e=this;if(0===a.length)"function"===typeof b&&b();else{var f=a.shift();this._sender.send(f,
function(){"function"===typeof d&&d({messageId:f.messageId,count:f.index+1,total:f.total});e._sendChunks(a,b,c,d)},c)}};h.prototype.send=function(a,b,c){var d=this;k(a,function(a){d._sender.send(a,b,c)})};f.prototype.send=function(a,b,c){this._buffer.push(a);this._sendBuffer(this._buffer,b,c,0)};f.prototype._sendBuffer=function(a,b,c,e){var f=this,h=function(a){e===f._attemptsMaxCount&&"function"===typeof c&&c(a)};f._sendImmediately&&!f._trySendBuffer(a,b,h,e)&&e<f._attemptsMaxCount&&(f._sendImmediately=
!1,d.setTimeout(function(){f._sendImmediately=!0;f._sendBuffer(a,b,c,++e)},100))};f.prototype._trySendBuffer=function(a,b,c){return 0===a.length?!0:this._trySend(a[0],b,c)?(a.shift(),this._trySendBuffer(a,b,c)):!1};f.prototype._trySend=function(a,b,c){try{this._sender.send(a)}catch(d){return c(new e.CommonError("send","Message sending error.",d)),!1}"function"===typeof b&&b();return!0}})(window);(function(d){"undefined"===typeof d.xRtc&&(d.xRtc={});var a=d.xRtc,k={},b=a.webrtc;a.Class(k,"IceCandidateFilter",function(b,d){var e=b||a.Connection.connectionTypes["default"],g=/(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})/g;a.Class.extend(this,{getType:function(){return e},filterCandidate:function(b){var h=null;if(e===a.Connection.connectionTypes["default"])h=b;else if(e===a.Connection.connectionTypes.direct&&(k.isLocal(b)||k.isStun(b)))h=b;else if(e===a.Connection.connectionTypes.server)if(k.isTurn(b))h=
b;else if(k.isStun(b)){var h=null,s;s=null;if(d)for(var v=0;v<d.length;v++){var q=d[v];0===q.url.indexOf("turn:")&&(s=-1!==q.url.indexOf("@")?q.url.split("@")[1]:q.url.split("turn:")[1])}s&&(h=b,h.candidate=b.candidate.replace(g,s),h.candidate=b.candidate.replace("typ srflx","typ relay"))}return h},filterSDP:function(b){var d=b;e===a.Connection.connectionTypes.server?d=b.replace(/a=candidate:.*((typ host)|(typ srflx)).*\r\n/g,""):e===a.Connection.connectionTypes.direct&&(d=b.replace(/a=candidate:.*typ relay.*\r\n/g,
""));return d}});var k={isLocal:function(a){return/typ host/.test(a.candidate)},isStun:function(a){return/typ srflx/.test(a.candidate)},isTurn:function(a){return/typ relay/.test(a.candidate)}}});a.Class(a,"Connection",function(h,f,e,g,r,c){function x(b){throw new a.CommonError(b,"The method can be called on '"+a.Room.events.connectionCreated+"' event of the xRtc.Room. Use xRtc.Room.events.connectionCreated for access the event name.");}function s(c,f){function g(){if("function"===typeof f)try{f()}catch(a){}}
function h(a){function c(a,b){var d=a;a[a.length-1]===b&&(d=a.substring(0,a.length-1));return d}for(var d=[],e=function(a){var d;if(b.detectedBrowser==b.supportedBrowsers.chrome){var e=a.url;d=a.username;a=a.credential;var f=null,m=e.split(":");0===m[0].indexOf("stun")?f={url:c(e,"/")}:0===m[0].indexOf("turn")&&(28>b.detectedBrowserVersion?(e=e.split("turn:"),f={url:"turn:"+d+"@"+e[1],credential:a}):f={url:c(e,"/"),credential:a,username:d})}else e=a.url,d=a.username,a=a.credential,f=null,m=e.split(":"),
0===m[0].indexOf("stun")?f={url:c(e,"/")}:0!==m[0].indexOf("turn")||-1===e.indexOf("transport=udp")&&-1!==e.indexOf("?transport")||(e=e.split("?"),f={url:c(e[0],"/"),credential:a,username:d});return d=f},f=0,m=a.length;f<m;f++){var g=e(a[f]);g&&d.push(g)}return d}function k(c){var f=this;c=h(c);m=new b.RTCPeerConnection(c&&0<c.length?{iceServers:c}:null,a.Connection.settings.peerConnectionOptions);p.info("initPeerConnection","PeerConnection created.");m.onicecandidate=u(function(a){a.candidate&&(p.debug("peerConnection.onIceCandidate",
a.candidate),a=JSON.parse(JSON.stringify(a.candidate)),a=H.filterCandidate(a),null!==a&&(I.push(a),M&&q.call(this)))});m.onstatechange=m.onsignalingstatechange=u(function(b){p.debug("onConnectionStateChange",b);this.trigger(a.Connection.events.stateChanged,{connection:this,state:this.getState()})});if(b.detectedBrowser===b.supportedBrowsers.firefox&&24>b.detectedBrowserVersion){var P=this.getState();N=d.setInterval(function(){var b=f.getState();b!=P&&(p.debug("setInterval -> xrtc.Connection.events.stateChanged",
b),P=b,f.trigger(a.Connection.events.stateChanged,{connection:f,state:P}))},500)}m.onicechange=m.oniceconnectionstatechange=u(function(b){b=F.call(f);p.debug("onIceStateChange",(new Date).getTime(),b);D&&(p.debug("onIceStateChange",(new Date).getTime(),"checkDisconnectedIceStateTimeout are clearing. ID = '"+D+"'"),d.clearTimeout(D),D=null,p.debug("onIceStateChange",(new Date).getTime(),"checkDisconnectedIceStateTimeout was cleared. ID = '"+D+"'"));"connected"===b?f.trigger(a.Connection.events.connectionEstablished,
{connection:f,user:e}):"disconnected"===b&&(p.debug("onIceStateChange",(new Date).getTime(),"checkDisconnectedIceStateTimeout(10sec.) was started."),D=d.setTimeout(function(){p.debug("onIceStateChange",(new Date).getTime(),"ice state equals 'disconnected' so closePeerConnection was called. Timeout is 10sec and it is expired.");l.call(f);d.clearInterval(D);D=null},1E4),p.debug("onIceStateChange",(new Date).getTime(),"checkDisconnectedIceStateTimeout ID ='"+D+"'"))});m.ondatachannel=function(b){b=new a.DataChannel(b.channel,
f);G.push(b);f.trigger(a.Connection.events.dataChannelCreated,{connection:f,channel:b})};m.onaddstream=u(function(b){b=new a.Stream(b.stream);C.push(b);b={user:e,connection:this,stream:b};p.debug("addRemoteStream",b);this.trigger(a.Connection.events.remoteStreamAdded,b)});m.onclosedconnection=function(a){p.debug("peerConnection.onclosedconnection",a);l.call(f)};c=0;for(var n=A.length;c<n;c++)m.addStream(A[c].getStream());c=0;for(n=Q.length;c<n;c++)v.call(this,Q[c]);g()}e=c;m?g():n.call(this,u(k))}
function v(b){try{var c=b.name,d=b.config,e=d?d.reliable:null,f;!0===e||!1===e?f=m.createDataChannel(c,{reliable:e?!0:!1}):a.webrtc.supports.sctp?(f=m.createDataChannel(b.name,{reliable:!0}),f.binaryType="arraybuffer"):f=m.createDataChannel(b.name,{reliable:!1});var g=new a.DataChannel(f,this);G.push(g);this.trigger(a.Connection.events.dataChannelCreated,{connection:this,channel:g})}catch(h){c=new a.CommonError("createDataChannel","Can't create DataChannel.",h),p.error("createDataChannel",c),this.trigger(a.Connection.events.dataChannelCreationError,
{connection:this,channelConfig:b,error:c})}}function q(){p.debug("sendIceCandidates",'Sending "'+I.length+'" ice candidates.');for(var b=0,c=I.length;b<c;b++){var d=I[b];J.sendIce(e.id,L,JSON.stringify(d));this.trigger(a.Connection.events.iceSent,{connection:this,iceCandidate:d})}I=[]}function n(a){"function"===typeof a&&(E?a(E):B.getIceServers(K,function(b){E=b;a(E)}))}function w(c){p.debug("Ice candidate was received.",c);c=new b.RTCIceCandidate(JSON.parse(c.iceCandidate));m.addIceCandidate(c);
this.trigger(a.Connection.events.iceAdded,{connection:this,iceCandidate:c})}function z(c){this.trigger(a.Connection.events.offerReceived,{connection:this,user:e,offerData:c});this.trigger(a.Connection.events.connectionOpening,{connection:this,user:e});p.debug("Offer was received.",c);E=c.iceServers;s.call(this,e,u(function(){p.debug("receiveOffer",c);H=new k.IceCandidateFilter(c.connectionType,E);var d=JSON.parse(c.offer),d=new b.RTCSessionDescription(d);m.setRemoteDescription(d);m.createAnswer(u(function(d){if(m){b.detectedBrowser===
b.supportedBrowsers.firefox&&(d.sdp=H.filterSDP(d.sdp));m.setLocalDescription(d);var f={answer:JSON.stringify(d),acceptData:c.acceptData};p.debug("sendAnswer",c,d);J.sendAnswer(e.id,L,f);this.trigger(a.Connection.events.answerSent,{connection:this,user:e,answerData:f});this.trigger(a.Connection.events.connectionEstablishing,{connection:this,user:e});M=!0;q.call(this)}}),u(function(b){b=new a.CommonError("sendAnswer","Cannot create WebRTC answer",b);p.error("sendAnswer",b);this.trigger(a.Connection.events.createAnswerError,
{connection:this,error:b})}),a.Connection.settings.answerOptions)}))}function t(c){p.debug("Answer was received.",c);M=!0;q.call(this);c=JSON.parse(c.answer);c=new b.RTCSessionDescription(c);m.setRemoteDescription(c);this.trigger(a.Connection.events.answerReceived,{connection:this,user:e,answerData:{answer:c}});this.trigger(a.Connection.events.connectionEstablishing,{connection:this,user:e})}function y(){l.call(this)}function l(){b.detectedBrowser===b.supportedBrowsers.firefox&&N&&(d.clearInterval(N),
N=null);if(m){m.onicecandidate=null;m.close();m=null;I=[];E=null;O=M=!1;var c={user:e,connection:this};e=null;this.trigger(a.Connection.events.connectionClosed,c)}}function F(){return m&&(m.iceConnectionState||m.iceState)||"notinitialized"}var u=a.Class.proxy(this),p=new a.Logger(this.className),K=f,B=r||new xRtc.AuthManager,A=[],C=[],G=[],Q=[],m=null,N=null,D=null,J=g,H=null,E=null,M=!1,I=[],L=h,O=!1;(function(){var b=a.HandshakeController.events;J.on(b.receiveIce,u(w)).on(b.receiveOffer,u(z)).on(b.receiveAnswer,
u(t)).on(b.receiveBye,u(y))}).call(this);a.Class.extend(this,a.EventDispatcher,{_logger:p,getId:function(){return L},getRemoteUser:function(){return e},_open:function(d){O=!0;var f=this,g={};a.Class.extend(g,a.Connection.settings.offerOptions);d&&d.offer&&a.Class.extend(g,d.offer);f.trigger(a.Connection.events.connectionOpening,{connection:f,user:e});s.call(f,e,function(){H=new k.IceCandidateFilter(d&&d.connectionType||null,E);m.createOffer(u(function(d){if(m){b.detectedBrowser===b.supportedBrowsers.firefox&&
(d.sdp=H.filterSDP(d.sdp));p.debug("onCreateOfferSuccess",d);m.setLocalDescription(d);b.detectedBrowser===b.supportedBrowsers.firefox&&21>=b.detectedBrowserVersion&&(d.sdp=-1==d.sdp.indexOf("a=crypto")?d.sdp.replace(/c=IN/g,"a=crypto:1 AES_CM_128_HMAC_SHA1_80 inline:FakeFakeFakeFakeFakeFakeFakeFakeFakeFake\r\nc=IN"):d.sdp);var g={offer:JSON.stringify(d),connectionData:c,connectionType:H.getType(),iceServers:E};p.debug("sendOffer",e.id,d);J.sendOffer(e.id,L,g);f.trigger(a.Connection.events.offerSent,
{connection:this,user:e,offerData:g})}}),u(function(b){b=new a.CommonError("startSession","Cannot create WebRTC offer",b);p.error("onCreateOfferError",b);f.trigger(a.Connection.events.createOfferError,{connection:f,error:b})}),g)})},close:function(a){J&&e&&J.sendBye(e.id,L,a);l.call(this)},addStream:function(b){O&&x("addStream");A.push(b);b={connection:this,stream:b,user:{id:K.name,name:K.name}};p.debug("addLocalStream",b);this.trigger(a.Connection.events.localStreamAdded,b)},createDataChannel:function(b,
c){if(!b||b.constructor!==d.String)throw new a.CommonError("DataChannel name is incorrect type or not defined.");O&&x("createDataChannel");Q.push({name:b,config:c})},getData:function(){return c},getState:function(){var a=0<A.length;return{notinitialized:a?"ready":"not-ready","new":a?"ready":"not-ready",opening:"connecting",active:"connected",closing:"disconnecting",closed:a?"ready":"not-ready",stable:"connected","have-local-offer":"ready","have-remote-offer":"connecting"}[m&&(m.signalingState||m.readyState)||
"notinitialized"]},getLocalStreams:function(){return A.map(function(a){return a})},getRemoteStreams:function(){return C.map(function(a){return a})},getDataChannels:function(){return G.map(function(a){return a})}})});a.Connection.extend({events:{connectionOpening:"connectionopening",connectionEstablishing:"connectionestablishing",connectionEstablished:"connectionestablished",connectionClosed:"connectionclosed",localStreamAdded:"localstreamadded",remoteStreamAdded:"remotestreamadded",dataChannelCreated:"datachannelcreated",
dataChannelCreationError:"datachannelcreationerror",stateChanged:"statechanged",createOfferError:"createoffererror",offerSent:"offersent",offerReceived:"offerreceived",createAnswerError:"createanswererror",answerSent:"answersent",answerReceived:"answerreceived",iceSent:"icesent",iceAdded:"iceadded"},connectionTypes:{"default":"default",direct:"direct",server:"server"},settings:{offerOptions:{optional:[],mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}},answerOptions:{optional:[],mandatory:{OfferToReceiveAudio:!0,
OfferToReceiveVideo:!0}},peerConnectionOptions:{optional:[{RtpDataChannels:!a.webrtc.supports.sctp},{DtlsSrtpKeyAgreement:!0}]}}});b.RTCPeerConnection.prototype&&!b.RTCPeerConnection.prototype.getLocalStreams&&a.Class.extend(b.RTCPeerConnection.prototype,{getLocalStreams:function(){return this.localStreams},getRemoteStreams:function(){return this.remoteStreams}});b.MediaStream.prototype.getVideoTracks||(b.detectedBrowser===b.supportedBrowsers.firefox?a.Class.extend(b.MediaStream.prototype,{getVideoTracks:function(){return[]},
getAudioTracks:function(){return[]}}):a.Class.extend(b.MediaStream.prototype,{getVideoTracks:function(){return this.videoTracks},getAudioTracks:function(){return this.audioTracks}}))})(window);(function(d){"undefined"===typeof d.xRtc&&(d.xRtc={});var a=d.xRtc;a.Class(a,"HandshakeController",function(){var d=new a.Logger(this.className);a.Class.extend(this,a.EventDispatcher,{_logger:d,sendIce:function(b,d,f){this.trigger(a.HandshakeController.events.sendIce,b,d,f)},sendOffer:function(b,d,f){this.trigger(a.HandshakeController.events.sendOffer,b,d,f)},sendAnswer:function(b,d,f){this.trigger(a.HandshakeController.events.sendAnswer,b,d,f)},sendBye:function(b,d,f){this.trigger(a.HandshakeController.events.sendBye,
b,d,f)}})});a.HandshakeController.extend({events:{sendIce:"sendice",sendOffer:"sendoffer",sendAnswer:"sendanswer",sendBye:"sendbye",receiveIce:"receiveice",receiveOffer:"receiveoffer",receiveAnswer:"receiveanswer",receiveBye:"receivebye"}})})(window);(function(d){"undefined"===typeof d.xRtc&&(d.xRtc={});var a=d.xRtc;a.Class(a,"ServerConnector",function(k){function b(b,c){var d={eventName:b.eventName};"undefined"!==typeof b.data&&(d.data=b.data);"undefined"!==typeof b.targetUserId&&(d.targetUserId=b.targetUserId.toString());var e=JSON.stringify(d);w&&1===w.readyState?(n.debug("send",d,e),w.send(e)):c?n.debug("send","The call was ignored because no server connection.",d,e):(d=new a.CommonError("send","Trying to call method without established connection",
"WebSocket is not connected!"),n.error("send",d))}function h(b,c){try{if(b=JSON.parse(b),n.debug("getWebSocketURL",b),b&&b.e&&""!=b.e){var d=new a.CommonError("getWebSocketURL","Error occured while getting the URL of WebSockets",b.e);n.error("getWebSocketURL",d);this.trigger(l.serverError,{error:d})}else{var e=b.d.value;n.info("getWebSocketURL",e);"function"===typeof c&&c(e)}}catch(f){this.ajax(a.ServerConnector.settings.URL,"POST","",q(h,c))}}function f(a,b){w=new WebSocket(a+"/ws/"+encodeURIComponent(b));
w.onopen=q(e);w.onclose=q(g);w.onerror=q(r);w.onmessage=q(c)}function e(a){a={event:a};n.debug("open",a);t&&(y=v.call(this,t));this.trigger(l.connectionOpen,a)}function g(a){y&&(d.clearInterval(y),y=null);a={event:a};n.debug("close",a);this.trigger(l.connectionClose,a);w=null}function r(b){b=new a.CommonError("onerror","WebSocket has got an error",b);n.error("error",b);this.trigger(l.connectionError,{error:b})}function c(a){var b={message:a};n.debug("message",b);this.trigger(l.message,b);if(x(a))if(a=
s(a),b=a.type,b==l.usersUpdated||b==l.userConnected||b==l.userDisconnected)if(b==l.usersUpdated){for(var b=[],c=0,d=a.message.users.length;c<d;c++)b.push({id:a.message.users[c],name:a.message.users[c]});this.trigger(l.usersUpdated,{users:b})}else b==l.userConnected?this.trigger(l.userConnected,{user:{id:a.message,name:a.message}}):b==l.userDisconnected&&this.trigger(l.userDisconnected,{user:{id:a.message,name:a.message}});else if(b==l.receiveOffer||b==l.receiveAnswer||b==l.receiveIce||b==l.receiveBye)b==
l.receiveOffer?this.trigger(l.receiveOffer,{senderId:a.userid,receiverId:a.message.targetUserId,connectionId:a.message.data.connectionId,offer:a.message.data.offer.offer,iceServers:a.message.data.offer.iceServers,connectionType:a.message.data.offer.connectionType,connectionData:a.message.data.offer.connectionData}):b==l.receiveAnswer?this.trigger(l.receiveAnswer,{senderId:a.userid,connectionId:a.message.data.connectionId,answer:a.message.data.answer.answer,acceptData:a.message.data.answer.acceptData}):
b==l.receiveIce?this.trigger(l.receiveIce,{senderId:a.userid,connectionId:a.message.data.connectionId,iceCandidate:a.message.data.iceCandidate}):b==l.receiveBye&&this.trigger(l.receiveBye,{senderId:a.userid,connectionId:a.message.data.connectionId,byeData:a.message.data.byeData})}function x(a){var b=!0;'"Token invalid"'===a.data&&(b=!1,this.trigger(l.tokenInvalid,{token:z}));return b}function s(b){var c;try{c=JSON.parse(b.data)}catch(d){c=null;var e=new a.CommonError("parseServerMessage","Message format error",
d);n.error("parseServerMessage",e,b);this.trigger(l.messageFormatError,{error:e})}return c}function v(a){return d.setInterval(function(){b.call(this,{})},a)}var q=a.Class.proxy(this),n=new a.Logger(this.className),w=null,z=null,t=k?k.pingInterval:5E3,y=null,l=a.ServerConnector.events;a.Class.extend(this,a.EventDispatcher,a.Ajax,{_logger:n,connect:function(b){z=b;b=q(f,b);this.ajax(a.ServerConnector.settings.URL,"POST","",q(h,b))},disconnect:function(){w?(w.close(),z=w=null,n.info("disconnect","Connection with WS has been broken")):
n.debug("disconnect","Connection with WS has not been established yet")},sendOffer:function(a,c,d){b({eventName:l.receiveOffer,targetUserId:a,data:{connectionId:c,offer:d||{}}})},sendAnswer:function(a,c,d){b({eventName:l.receiveAnswer,targetUserId:a,data:{connectionId:c,answer:d||{}}})},sendIce:function(a,c,d){b({eventName:l.receiveIce,targetUserId:a,data:{connectionId:c,iceCandidate:d}})},sendBye:function(a,c,d){b({eventName:l.receiveBye,targetUserId:a,data:{connectionId:c,byeData:d||{}}},!0)}})});
a.ServerConnector.extend({events:{connectionOpen:"connectionopen",connectionClose:"connectionclose",connectionError:"connectionerror",message:"message",messageFormatError:"messageformaterror",serverError:"servererror",tokenInvalid:"tokeninvalid",receiveOffer:"receiveoffer",receiveAnswer:"receiveanswer",receiveIce:"receiveice",receiveBye:"receivebye",usersUpdated:"peers",userConnected:"peer_connected",userDisconnected:"peer_removed"},settings:{URL:"https://api.xirsys.com/wsList"}})})(window);(function(d){"undefined"===typeof d.xRtc&&(d.xRtc={});var a=d.xRtc;a.Class(a,"Room",function(d,b,h){function f(){var b=this;l||(B.on(t.connectionOpen,n(function(b){this.trigger(a.Room.events.enter)})).on(t.connectionClose,n(function(b){this.trigger(a.Room.events.leave)})).on(t.tokenInvalid,n(function(b){this.trigger(a.Room.events.tokenInvalid,b)})).on(t.usersUpdated,n(function(b){y=b.users;y.sort(c);this.trigger(a.Room.events.usersUpdated,{users:this.getUsers()})})).on(t.userConnected,n(function(b){y.push(b.user);
y.sort(c);this.trigger(a.Room.events.userConnected,{user:b.user})})).on(t.userDisconnected,n(function(b){y.splice(q(y,b.user.id),1);y.sort(c);this.trigger(a.Room.events.userDisconnected,{user:b.user})})).on(t.receiveOffer,n(e)).on(t.receiveBye,n(g)).on(t.receiveAnswer,function(c){if(c.senderId&&c.connectionId){var d=x(c.senderId);if(d){var e=C[c.connectionId];e?e.userId===d.id&&(b.trigger(a.Room.events.connectionAccepted,{user:d,connection:s(c.connectionId),data:c.acceptData}),e.hc.trigger(z.receiveAnswer,
{connectionId:c.connectionId,answer:c.answer})):B.sendBye(c.senderId,c.connectionId,{type:G.decline,data:"Remote connection not found."})}}}).on(t.receiveIce,function(a){if(a.senderId&&a.connectionId){var b=C[a.connectionId];b&&b.userId===a.senderId&&b.hc.trigger(z.receiveIce,{iceCandidate:a.iceCandidate,connectionId:a.connectionId})}}),l=!0)}function e(b){function c(a){r.call(e,b.connectionId,p,x(b.senderId),b.connectionData,function(c){c.handshakeController.trigger(z.receiveOffer,{offer:b.offer,
iceServers:b.iceServers,connectionType:b.connectionType,connectionId:b.connectionId,connectionData:b.connectionData,acceptData:a})})}function d(a){B.sendBye(b.senderId,b.connectionId,{type:G.decline,data:a})}if(b.senderId&&b.connectionId){var e=this,f={user:x(b.senderId),connectionId:b.connectionId,data:b.connectionData};F.autoReply||(f.accept=n(c),f.decline=n(d));C[b.connectionId]={userId:b.senderId,hc:null};this.trigger(a.Room.events.incomingConnection,f);F.autoReply&&c.call(e)}}function g(b){if(b.senderId&&
b.connectionId){var c=x(b.senderId);if(c){var d=C[b.connectionId];if(d&&d.userId===c.id){if(b.byeData&&b.byeData.type===G.decline||!d.hc){var e=s(b.connectionId);e&&this.trigger(a.Room.events.connectionDeclined,{user:c,connection:e,data:b.byeData})}d.hc&&d.hc.trigger(z.receiveBye)}}}}function r(b,c,d,e,f){var g=new a.HandshakeController;c=new xRtc.Connection(b,c,d,g,K,e);C[b]?C[b].hc=g:C[b]={userId:d.id,hc:g};g.on(z.sendOffer,n(function(a,b,c){B.sendOffer(a,b,c)})).on(z.sendAnswer,n(function(a,b,
c){B.sendAnswer(a,b,c)})).on(z.sendIce,n(function(a,b,c){B.sendIce(a,b,c)})).on(z.sendBye,n(function(a,b,c){B.sendBye(a,b,c)}));c.on(a.Connection.events.connectionClosed,function(){A.splice(v(A,b),1);delete C[b]});A.push(c);this.trigger(a.Room.events.connectionCreated,{user:d,connection:c});"function"===typeof f&&f({connection:c,handshakeController:g})}function c(a,b){var c=0;a.name<b.name?c=-1:a.name>b.name&&(c=1);return c}function x(a){for(var b=null,c=0,d=y.length;c<d;c++)if(y[c].id===a){b=y[c];
break}return b}function s(a){for(var b=null,c=0,d=A.length;c<d;c++)if(A[c].getId()===a){b=A[c];break}return b}function v(a,b){for(var c=-1,d=0,e=a.length;d<e;d++)if(a[d].getId()===b){c=d;break}return c}function q(a,b){for(var c=-1,d=0,e=a.length;d<e;d++)a[d].id===b&&(c=d);return c}var n=a.Class.proxy(this),w=new a.Logger(this.className),z=a.HandshakeController.events,t=a.ServerConnector.events,y=[],l=!1,F={},u={},p=null,K=b||new xRtc.AuthManager,B=h||new a.ServerConnector,A=[],C={},G={decline:"decline"};
a.Class.extend(u,a.Room.settings.info);"string"===typeof d?u.name=d:a.Class.extend(u,d);a.Class.extend(this,a.EventDispatcher,{_logger:w,enter:function(b,c){var d="",e="";if(!b)throw new a.CommonError("enter","User credentials should be specified.");"string"===typeof b?d=b:(d=b.username,e=b.password);f.call(this);a.Class.extend(F,a.Room.settings.enterOptions);c&&a.Class.extend(F,c);p={domain:u.domain,application:u.application,room:u.name,name:d,password:e};K.getToken(p,function(a){u.user={id:null,
name:d};B.connect(a)})},leave:function(){B.on(a.ServerConnector.events.connectionClose,function(){l&&(B.off(t.connectionOpen).off(t.connectionClose).off(t.tokenInvalid).off(t.usersUpdated).off(t.userConnected).off(t.userDisconnected).off(t.receiveOffer).off(t.receiveBye).off(t.receiveAnswer).off(t.receiveIce),l=!1);F={};p=null;u.user=null;y=[];A=[];C={}});B.disconnect()},connect:function(b,c){if(!u.user)throw new a.CommonError("connect","Need to enter the room before you connect someone.");var d=
x(b);if(null==d)d=a.CommonError("connect","Target user not found."),this.trigger(a.Room.events.error,{userId:b,error:d});else{var e=c&&c.data?c.data:null,f=c&&c.id?c.id:a.utils.newGuid();r.call(this,f,p,d,e,function(a){a=a.connection;c&&"auto"===c.createDataChannel&&a.createDataChannel("autoDataChannel");a._open(c)})}},getInfo:function(){return u},getConnections:function(){return A.map(function(a){return a})},getUsers:function(){return y.map(function(a){return a})}})});a.Room.extend({events:{enter:"enter",
leave:"leave",incomingConnection:"incomingconnection",connectionCreated:"connectioncreated",connectionAccepted:"connectionaccepted",connectionDeclined:"connectiondeclined",usersUpdated:"usersupdated",userConnected:"userconnected",userDisconnected:"userdisconnected",tokenInvalid:"tokeninvalid",error:"error"},settings:{info:{domain:d.document.domain,application:"default",name:"default"},enterOptions:{autoReply:!0}}})})(window);(function(d){"undefined"===typeof d.xRtc&&(d.xRtc={});var a=d.xRtc,k=a.webrtc,b=new a.Logger("UserMedia"),h=function(d,e,g){k.getUserMedia(d,function(b){"function"===typeof e&&e(new a.Stream(b))},function(d){"function"===typeof g&&(d=new a.CommonError("getUserMedia","Can't get media stream. "+(d.message&&""!==d.message?d.message:d.name)+". Need to unlock camera/mic access if it was blocked before. For unblocking see special icon in the right corner of the address input of the browser."),b.error("onCreateOfferError",
d),g(d))})};a.getUserMedia=function(d,e,g){if(d&&!d.video&&!d.audio){var r=new a.CommonError("getUserMedia","video or audio property of the options parameter should be specified. No sense to create media stream without video and audio components.");b.error("onCreateOfferError",r)}d=d?a.utils.clone(d):{video:!0,audio:!0};if(d.video&&d.video.mandatory&&"screen"===d.video.mandatory.mediaSource){var c=d.audio;d.audio=!1;delete d.video.mandatory.mediaSource;d.video.mandatory.chromeMediaSource="screen";
h.call(this,d,function(a){c?h.call(this,{audio:!0},function(b){function c(a,b){for(var d=0;d<b.length;d++)a.push(b[d])}var d=[];c(d,b.getAudioTracks());c(d,a.getVideoTracks());e(new k.MediaStream(d))},g):e(a)},g)}else h.call(this,d,e,g)}})(window);
