(function(d){function a(){this._pieces=[];this._parts=[]}function h(c){this.index=0;this.dataBuffer=c;this.dataView=new Uint8Array(this.dataBuffer);this.length=this.dataBuffer.byteLength}function b(){this.bufferBuilder=new a}function f(c){c=c.charCodeAt(0);return 2047>=c?"00":65535>=c?"000":2097151>=c?"0000":67108863>=c?"00000":"000000"}var g={},e;try{new Blob([]),e=!1}catch(k){e=!0}g.useBlobBuilder=e;if(e=!g.useBlobBuilder)try{e=0===(new Blob([new Uint8Array([])])).size}catch(q){e=!0}g.useArrayBufferView=
e;d.binaryFeatures=g;d.BlobBuilder=window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder||window.BlobBuilder;a.prototype.append=function(c){"number"===typeof c?this._pieces.push(c):(this.flush(),this._parts.push(c))};a.prototype.flush=function(){if(0<this._pieces.length){var c=new Uint8Array(this._pieces);g.useArrayBufferView||(c=c.buffer);this._parts.push(c);this._pieces=[]}};a.prototype.getBuffer=function(){this.flush();if(g.useBlobBuilder){for(var c=new BlobBuilder,a=0,b=this._parts.length;a<
b;a++)c.append(this._parts[a]);return c.getBlob()}return new Blob(this._parts)};d.BinaryPack={unpack:function(c){return(new h(c)).unpack()},pack:function(c){var a=new b;a.pack(c);return a.getBuffer()}};h.prototype.unpack=function(){var c=this.unpack_uint8();if(128>c)return c;if(32>(c^224))return(c^224)-32;var a;if(15>=(a=c^160))return this.unpack_raw(a);if(15>=(a=c^176))return this.unpack_string(a);if(15>=(a=c^144))return this.unpack_array(a);if(15>=(a=c^128))return this.unpack_map(a);switch(c){case 192:return null;
case 194:return!1;case 195:return!0;case 202:return this.unpack_float();case 203:return this.unpack_double();case 204:return this.unpack_uint8();case 205:return this.unpack_uint16();case 206:return this.unpack_uint32();case 207:return this.unpack_uint64();case 208:return this.unpack_int8();case 209:return this.unpack_int16();case 210:return this.unpack_int32();case 211:return this.unpack_int64();case 216:return a=this.unpack_uint16(),this.unpack_string(a);case 217:return a=this.unpack_uint32(),this.unpack_string(a);
case 218:return a=this.unpack_uint16(),this.unpack_raw(a);case 219:return a=this.unpack_uint32(),this.unpack_raw(a);case 220:return a=this.unpack_uint16(),this.unpack_array(a);case 221:return a=this.unpack_uint32(),this.unpack_array(a);case 222:return a=this.unpack_uint16(),this.unpack_map(a);case 223:return a=this.unpack_uint32(),this.unpack_map(a)}};h.prototype.unpack_uint8=function(){var c=this.dataView[this.index]&255;this.index++;return c};h.prototype.unpack_uint16=function(){var c=this.read(2),
c=256*(c[0]&255)+(c[1]&255);this.index+=2;return c};h.prototype.unpack_uint32=function(){var c=this.read(4),c=256*(256*(256*c[0]+c[1])+c[2])+c[3];this.index+=4;return c};h.prototype.unpack_uint64=function(){var c=this.read(8),c=256*(256*(256*(256*(256*(256*(256*c[0]+c[1])+c[2])+c[3])+c[4])+c[5])+c[6])+c[7];this.index+=8;return c};h.prototype.unpack_int8=function(){var c=this.unpack_uint8();return 128>c?c:c-256};h.prototype.unpack_int16=function(){var c=this.unpack_uint16();return 32768>c?c:c-65536};
h.prototype.unpack_int32=function(){var c=this.unpack_uint32();return c<Math.pow(2,31)?c:c-Math.pow(2,32)};h.prototype.unpack_int64=function(){var c=this.unpack_uint64();return c<Math.pow(2,63)?c:c-Math.pow(2,64)};h.prototype.unpack_raw=function(c){if(this.length<this.index+c)throw Error("BinaryPackFailure: index is out of range "+this.index+" "+c+" "+this.length);var a=this.dataBuffer.slice(this.index,this.index+c);this.index+=c;return a};h.prototype.unpack_string=function(c){for(var a=this.read(c),
b=0,k="",e;b<c;)e=a[b],128>e?(k+=String.fromCharCode(e),b++):32>(e^192)?(e=(e^192)<<6|a[b+1]&63,k+=String.fromCharCode(e),b+=2):(e=(e&15)<<12|(a[b+1]&63)<<6|a[b+2]&63,k+=String.fromCharCode(e),b+=3);this.index+=c;return k};h.prototype.unpack_array=function(c){for(var a=Array(c),b=0;b<c;b++)a[b]=this.unpack();return a};h.prototype.unpack_map=function(c){for(var a={},b=0;b<c;b++){var e=this.unpack(),k=this.unpack();a[e]=k}return a};h.prototype.unpack_float=function(){var c=this.unpack_uint32();return(0==
c>>31?1:-1)*(c&8388607|8388608)*Math.pow(2,(c>>23&255)-127-23)};h.prototype.unpack_double=function(){var c=this.unpack_uint32(),a=this.unpack_uint32(),b=c>>31,e=(c>>20&2047)-1023,c=(c&1048575|1048576)*Math.pow(2,e-20)+a*Math.pow(2,e-52);return(0==b?1:-1)*c};h.prototype.read=function(c){var a=this.index;if(a+c<=this.length)return this.dataView.subarray(a,a+c);throw Error("BinaryPackFailure: read index out of range");};b.prototype.getBuffer=function(){return this.bufferBuilder.getBuffer()};b.prototype.pack=
function(c){var a=typeof c;if("string"==a)this.pack_string(c);else if("number"==a)Math.floor(c)===c?this.pack_integer(c):this.pack_double(c);else if("boolean"==a)!0===c?this.bufferBuilder.append(195):!1===c&&this.bufferBuilder.append(194);else if("undefined"==a)this.bufferBuilder.append(192);else if("object"==a)if(null===c)this.bufferBuilder.append(192);else if(a=c.constructor,a==Array)this.pack_array(c);else if(a==Blob||a==File)this.pack_bin(c);else if(a==ArrayBuffer)g.useArrayBufferView?this.pack_bin(new Uint8Array(c)):
this.pack_bin(c);else if("BYTES_PER_ELEMENT"in c)g.useArrayBufferView?this.pack_bin(new Uint8Array(c.buffer)):this.pack_bin(c.buffer);else if(a==Object)this.pack_object(c);else if(a==Date)this.pack_string(c.toString());else if("function"==typeof c.toBinaryPack)this.bufferBuilder.append(c.toBinaryPack());else throw Error('Type "'+a.toString()+'" not yet supported');else throw Error('Type "'+a+'" not yet supported');this.bufferBuilder.flush()};b.prototype.pack_bin=function(c){var a=c.length||c.byteLength||
c.size;if(15>=a)this.pack_uint8(160+a);else if(65535>=a)this.bufferBuilder.append(218),this.pack_uint16(a);else if(4294967295>=a)this.bufferBuilder.append(219),this.pack_uint32(a);else throw Error("Invalid length");this.bufferBuilder.append(c)};b.prototype.pack_string=function(c){var a;a=600<c.length?(new Blob([c])).size:c.replace(/[^\u0000-\u007F]/g,f).length;if(15>=a)this.pack_uint8(176+a);else if(65535>=a)this.bufferBuilder.append(216),this.pack_uint16(a);else if(4294967295>=a)this.bufferBuilder.append(217),
this.pack_uint32(a);else throw Error("Invalid length");this.bufferBuilder.append(c)};b.prototype.pack_array=function(a){var b=a.length;if(15>=b)this.pack_uint8(144+b);else if(65535>=b)this.bufferBuilder.append(220),this.pack_uint16(b);else if(4294967295>=b)this.bufferBuilder.append(221),this.pack_uint32(b);else throw Error("Invalid length");for(var e=0;e<b;e++)this.pack(a[e])};b.prototype.pack_integer=function(a){if(-32<=a&&127>=a)this.bufferBuilder.append(a&255);else if(0<=a&&255>=a)this.bufferBuilder.append(204),
this.pack_uint8(a);else if(-128<=a&&127>=a)this.bufferBuilder.append(208),this.pack_int8(a);else if(0<=a&&65535>=a)this.bufferBuilder.append(205),this.pack_uint16(a);else if(-32768<=a&&32767>=a)this.bufferBuilder.append(209),this.pack_int16(a);else if(0<=a&&4294967295>=a)this.bufferBuilder.append(206),this.pack_uint32(a);else if(-2147483648<=a&&2147483647>=a)this.bufferBuilder.append(210),this.pack_int32(a);else if(-9223372036854775E3<=a&&9223372036854775E3>=a)this.bufferBuilder.append(211),this.pack_int64(a);
else if(0<=a&&1.8446744073709552E19>=a)this.bufferBuilder.append(207),this.pack_uint64(a);else throw Error("Invalid integer");};b.prototype.pack_double=function(a){var b=0;0>a&&(b=1,a=-a);var e=Math.floor(Math.log(a)/Math.LN2);a=a/Math.pow(2,e)-1;a=Math.floor(a*Math.pow(2,52));var k=Math.pow(2,32),b=b<<31|e+1023<<20|a/k&1048575,e=a%k;this.bufferBuilder.append(203);this.pack_int32(b);this.pack_int32(e)};b.prototype.pack_object=function(a){var b=Object.keys(a).length;if(15>=b)this.pack_uint8(128+b);
else if(65535>=b)this.bufferBuilder.append(222),this.pack_uint16(b);else if(4294967295>=b)this.bufferBuilder.append(223),this.pack_uint32(b);else throw Error("Invalid length");for(var e in a)a.hasOwnProperty(e)&&(this.pack(e),this.pack(a[e]))};b.prototype.pack_uint8=function(a){this.bufferBuilder.append(a)};b.prototype.pack_uint16=function(a){this.bufferBuilder.append(a>>8);this.bufferBuilder.append(a&255)};b.prototype.pack_uint32=function(a){a&=4294967295;this.bufferBuilder.append((a&4278190080)>>>
24);this.bufferBuilder.append((a&16711680)>>>16);this.bufferBuilder.append((a&65280)>>>8);this.bufferBuilder.append(a&255)};b.prototype.pack_uint64=function(a){var b=a/Math.pow(2,32);a%=Math.pow(2,32);this.bufferBuilder.append((b&4278190080)>>>24);this.bufferBuilder.append((b&16711680)>>>16);this.bufferBuilder.append((b&65280)>>>8);this.bufferBuilder.append(b&255);this.bufferBuilder.append((a&4278190080)>>>24);this.bufferBuilder.append((a&16711680)>>>16);this.bufferBuilder.append((a&65280)>>>8);this.bufferBuilder.append(a&
255)};b.prototype.pack_int8=function(a){this.bufferBuilder.append(a&255)};b.prototype.pack_int16=function(a){this.bufferBuilder.append((a&65280)>>8);this.bufferBuilder.append(a&255)};b.prototype.pack_int32=function(a){this.bufferBuilder.append(a>>>24&255);this.bufferBuilder.append((a&16711680)>>>16);this.bufferBuilder.append((a&65280)>>>8);this.bufferBuilder.append(a&255)};b.prototype.pack_int64=function(a){var b=Math.floor(a/Math.pow(2,32));a%=Math.pow(2,32);this.bufferBuilder.append((b&4278190080)>>>
24);this.bufferBuilder.append((b&16711680)>>>16);this.bufferBuilder.append((b&65280)>>>8);this.bufferBuilder.append(b&255);this.bufferBuilder.append((a&4278190080)>>>24);this.bufferBuilder.append((a&16711680)>>>16);this.bufferBuilder.append((a&65280)>>>8);this.bufferBuilder.append(a&255)}})(this);(function(d){"undefined"===typeof d.xRtc&&(d.xRtc={});var a=d.xRtc;a.Ajax={ajax:function(d,b,f,g){var e,k;k=a.Class.proxy(this);try{e=new XMLHttpRequest}catch(q){try{e=new ActiveXObject("Msxml2.XMLHTTP")}catch(c){try{e=new ActiveXObject("Microsoft.XMLHTTP")}catch(v){this._logger&&(k=new a.CommonError("ajax","XMLHttpRequest is not supported"),this._logger.error("ajax",k));return}}}this._logger&&this._logger.debug("ajax",d,f);b=b.toUpperCase();try{var u=!1;"GET"===b?(e.open(b,d+"?"+f,!0),f=""):(e.open(b,
d,!0),e.setRequestHeader("method",b+" "+d+" HTTP/1.1"),e.setRequestHeader("content-type","application/x-www-form-urlencoded"));e.onreadystatechange=k(function(){4!=e.readyState||u||(u=!0,this._logger&&this._logger.debug("ajax",e),"function"===typeof g&&g(e.responseText))});e.send(f)}catch(w){throw k=new a.CommonError("ajax","XMLHttpRequest exception",w),k.data={url:d,method:b,params:f},this._logger&&this._logger.error("ajax",k),k;}}}})(window);(function(d){"undefined"===typeof d.xRtc&&(d.xRtc={});d.xRtc.EventDispatcher={on:function(a,d){this._logger&&this._logger.info("on",arguments);this._events=this._events||{};this._events[a]=this._events[a]||[];this._events[a].push(d);return this},off:function(a){this._logger&&this._logger.info("off",arguments);this._events=this._events||{};this._events[a]=this._events[a]||[];delete this._events[a];return this},trigger:function(a){this._logger&&this._logger.info("trigger",arguments);this._events=this._events||
{};var d=this._events[a];if(!d)return this._logger.warning("trigger","Trying to call event which is not listening. Event name is '"+a+"'"),this;for(var b=Array.prototype.slice.call(arguments,1),f=0,g=d.length;f<g;f++)d[f].apply(null,b);return this}}})(window);(function(d){"undefined"===typeof d.xRtc&&(d.xRtc={});var a=d.xRtc;a.webrtc={getUserMedia:(navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia||navigator.getUserMedia).bind(navigator),RTCPeerConnection:d.mozRTCPeerConnection||d.webkitRTCPeerConnection||d.RTCPeerConnection,RTCIceCandidate:d.mozRTCIceCandidate||d.RTCIceCandidate,RTCSessionDescription:d.mozRTCSessionDescription||d.RTCSessionDescription,URL:d.webkitURL||d.msURL||d.oURL||d.URL,MediaStream:d.mozMediaStream||
d.webkitMediaStream||d.MediaStream,supportedBrowsers:{chrome:"chrome",firefox:"firefox"}};a.webrtc.detectedBrowser=navigator.mozGetUserMedia?a.webrtc.supportedBrowsers.firefox:a.webrtc.supportedBrowsers.chrome;a.webrtc.detectedBrowserVersion=a.webrtc.detectedBrowser===a.webrtc.supportedBrowsers.firefox?parseInt(d.navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1]):parseInt(d.navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./)[2]);a.webrtc.supports=function(){if("undefined"===typeof a.webrtc.RTCPeerConnection)return{};
var d=!1,b=!1,f=!1,g;try{g=new a.webrtc.RTCPeerConnection(null,{optional:[{RtpDataChannels:!0}]});d=!0;try{g.createDataChannel("_XRTCTEST",{reliable:!1});var b=!0,e=new a.webrtc.RTCPeerConnection(null,{});try{f=e.createDataChannel("_XRTCRELIABLETEST",{reliable:!0}).reliable}catch(k){}e.close()}catch(q){}}catch(c){}g&&g.close();return{media:d,data:b,sctp:f}}();a.blobSerializer={pack:BinaryPack.pack,unpack:BinaryPack.unpack};xRtc.utils={newGuid:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,
function(a){var b=16*Math.random()|0;return("x"==a?b:b&3|8).toString(16)})}}})(window);(function(d){"undefined"===typeof d.xRtc&&(d.xRtc={});d.xRtc.Class=function(a,h,b){a[h]=b;var f=a[h];f.fn=f.prototype;f.fn.className=h;f.extend=function(a){var b=a.extended;d.xRtc.Class.extend(f,a);b&&b(f)}};d.xRtc.Class.extend=function(a){for(var d=Array.prototype.slice.call(arguments,1),b=0,f=d.length;b<f;b++){var g=d[b],e;for(e in g)a[e]=g[e]}};d.xRtc.Class.property=function(a,d,b,f){"function"===typeof b&&a.__defineGetter__(d,b);"function"===typeof f&&a.__defineSetter__(d,f)};d.xRtc.Class.proxy=
function(a){return function(d){var b=[];1<arguments.length&&(b=Array.prototype.slice.call(arguments,1));return function(){for(var f=Array.prototype.slice.call(arguments),g=0;g<b.length;g++)f.push(b[g]);d.apply(a,f)}}}})(window);(function(d){"undefined"===typeof d.xRtc&&(d.xRtc={});d=d.xRtc;d.Class(d,"CommonError",function(a,d,b){this.method=a;this.message=d;this.error=b})})(window);(function(d){"undefined"===typeof d.xRtc&&(d.xRtc={});var a=d.xRtc;a.Class(a,"Logger",function(d){function b(){for(var a=[],d,e=0,k=arguments.length;e<k;e++)if(d=arguments[e],"object"===typeof d&&d instanceof Object&&"undefined"!==typeof d.length){d=b.apply(null,Array.prototype.slice.call(d));for(var q=0,c=d.length;q<c;q++)a.push(d[q])}else a.push(d);return a}a.Class.extend(this,{info:function(f){if(!0===a.Logger.level||"object"===typeof a.Logger.level&&a.Logger.level.info)"string"===typeof f?console.info("Info:\t\t",
d+"."+f,b(Array.prototype.slice.call(arguments,1))):console.info("Info:\t\t",b(Array.prototype.slice.call(arguments)))},debug:function(f){if(!0===a.Logger.level||"object"===typeof a.Logger.level&&a.Logger.level.debug)"string"===typeof f?console.debug("Debug:\t\t",d+"."+f,b(Array.prototype.slice.call(arguments,1))):console.debug("Debug:\t\t",b(Array.prototype.slice.call(arguments)))},test:function(f){if(!0===a.Logger.level||"object"===typeof a.Logger.level&&a.Logger.level.test)"string"===typeof f?
console.debug("Test:\t\t",d+"."+f,b(Array.prototype.slice.call(arguments,1))):console.debug("Test:\t\t",b(Array.prototype.slice.call(arguments)))},warning:function(f){if(!0===a.Logger.level||"object"===typeof a.Logger.level&&a.Logger.level.warning)"string"===typeof f?console.warn("Warning:\t",d+"."+f,b(Array.prototype.slice.call(arguments,1))):console.warn("Warning:\t",b(Array.prototype.slice.call(arguments)))},error:function(f){if(!0===a.Logger.level||"object"===typeof a.Logger.level&&a.Logger.level.error)"string"===
typeof f?console.error("Error:\t\t",d+"."+f,b(Array.prototype.slice.call(arguments,1))):console.error("Error:\t\t",b(Array.prototype.slice.call(arguments)))}})});a.Logger.extend({level:!1,enable:function(a){this.level="undefined"===typeof a?!0:a},disable:function(){this.level=!1}})})(window);(function(d){"undefined"===typeof d.xRtc&&(d.xRtc={});var a=d.xRtc;a.Class(a,"AuthManager",function(){function d(a){return["domain="+a.domain,"application="+a.application,"room="+a.room,"username="+a.name,"password="+a.password]}function b(b,d,c){var f=this;try{e.debug("getToken",b);""===b&&(e.error("getToken","Server returned an empty response."),f.trigger(a.AuthManager.events.serverError,"Server returned an empty response."));try{b=JSON.parse(b),e.debug("getToken",b)}catch(g){throw e.error("getToken",
b),g;}if(b&&b.e&&""!=b.e){var h=new a.CommonError("getToken",b.e);e.error("getToken",h);f.trigger(a.AuthManager.events.serverError,h)}else{var r=b.d.token;r?(e.info("getToken",r),"function"===typeof c&&c(r)):(e.error("getToken",b.d),f.trigger(a.AuthManager.events.serverError,b.d))}}catch(n){e.error("getToken. The request will be repeated after "+a.AuthManager.settings.unsuccessfulRequestRepeatTimeout/1E3+" sec.",n),setTimeout(function(){f.getToken(d,c)},a.AuthManager.settings.unsuccessfulRequestRepeatTimeout)}}
function f(b,d,c){var f=this;try{if(b=JSON.parse(b),e.debug("getIceServers",b),b&&b.e&&""!=b.e){var g=new a.CommonError("getIceServers",b.e);e.error("getIceServers",g);f.trigger(a.AuthManager.events.serverError,g)}else{var h=b.d.iceServers?b.d.iceServers.map(function(a){var c={};a.url&&(c.url=a.url);a.credential&&(c.credential=a.credential);a.username&&(c.username=a.username);return c}):[];e.info("getIceServers",h);"function"===typeof c&&c(h)}}catch(r){e.error("getIceServers. The request will be repeated after "+
a.AuthManager.settings.unsuccessfulRequestRepeatTimeout/1E3+" sec.",r),setTimeout(function(){f.getIceServers(d,c)},a.AuthManager.settings.unsuccessfulRequestRepeatTimeout)}}var g=a.Class.proxy(this),e=new a.Logger(this.className);a.Class.extend(this,a.Ajax,a.EventDispatcher,{_logger:e,getToken:function(e,f){var c=a.AuthManager.settings.tokenHandler,v=d.call(this,e).join("&");this.ajax(c,"POST",v,g(b,e,f))},getIceServers:function(b,e){var c=a.AuthManager.settings.iceHandler,v=d.call(this,b).join("&");
this.ajax(c,"POST",v,g(f,b,e))}})});a.AuthManager.extend({events:{serverError:"servererror"},settings:{unsuccessfulRequestRepeatTimeout:5E3,tokenHandler:"https://api.xirsys.com/getToken",iceHandler:"https://api.xirsys.com/getIceServers"}})})(window);(function(d,a){var h=a.webrtc;a.Class(a,"Stream",function(b){function f(){if(h.detectedBrowser===h.supportedBrowsers.firefox&&22>h.detectedBrowserVersion)throw new a.CommonError("setVideoEnabled","Media track muting is not supported if your Firefox browser version less then 22.");}var g=a.Class.proxy(this),e=new a.Logger(this.className),k=a.Stream.events,q=null;a.Class.property(this,"videoEnabled",function(){var a=b.getVideoTracks();return this.videoAvailable&&a[0].enabled},function(a){f();for(var d=
b.getVideoTracks(),e=0,k=d.length;e<k;e++)d[e].enabled=a});a.Class.property(this,"audioEnabled",function(){var a=b.getAudioTracks();return this.audioAvailable&&a[0].enabled},function(a){f();for(var d=b.getAudioTracks(),e=0,k=d.length;e<k;e++)d[e].enabled=a});a.Class.property(this,"videoAvailable",function(){return 0<b.getVideoTracks().length});a.Class.property(this,"audioAvailable",function(){return 0<b.getAudioTracks().length});b.onended=g(function(a){a={id:a.srcElement.id};e.debug("ended",a);this.trigger(k.ended,
a)});a.Class.extend(this,a.EventDispatcher,{_logger:e,getStream:function(){return b},stop:function(){b.stop()},getId:function(){q||(q=b.id?b.id:a.utils.newGuid());return q},getURL:function(){return h.URL.createObjectURL(b)},assignTo:function(a){this.videoAvailable||this.audioAvailable||0<b.currentTime?(h.detectedBrowser===h.supportedBrowsers.firefox?a.mozSrcObject=b:a.src=this.getURL(),a.play()):d.setTimeout(g(this.assignTo,a),100)}})});a.Stream.extend({events:{ended:"ended"}})})(window,xRtc);(function(d){function a(a){this._sender=a}function h(a,b){var c=new d.FileReader;c.onload=function(a){b(a.target.result)};c.readAsArrayBuffer(a)}function b(a){this._sender=a}function f(a,b){this._sender=a;this.chunkSize=b}function g(a){this._sender=a;this._buffer=[];this._sendImmediately=!0}"undefined"===typeof d.xRtc&&(d.xRtc={});var e=d.xRtc;e.Class(e,"DataChannel",function(k,q){function c(a){var b=this,c=e.blobSerializer.unpack(a);if(1===c.total)b.trigger(w.receivedMessage,{data:e.blobSerializer.unpack(c.data)});
else{n[c.blobId]||(n[c.blobId]={data:[],count:0,total:c.total});var d=n[c.blobId];d.data[c.index]=c.data;d.count+=1;d.total===d.count&&h(new Blob(d.data),function(a){b.trigger(w.receivedMessage,{data:e.blobSerializer.unpack(a)});delete d[c.blobId]})}}var v=e.Class.proxy(this),u=new e.Logger(this.className),w=e.DataChannel.events,r=new a(new f(new a(new b(new g(k))),16300)),n={};k.onopen=v(function(a){a={event:a};u.debug("open",a);this.trigger(w.open,a)});k.onmessage=v(function(a){var b=this;u.debug("message",
a.data);var e=a.data.constructor;e===d.ArrayBuffer?c.call(b,a.data):e===d.Blob&&h(a.data,function(a){c.call(b,a)})});k.onclose=v(function(a){a={event:a};u.debug("close",a);this.trigger(w.close,a)});k.onerror=v(function(a){a=new e.CommonError("onerror","DataChannel error.",a);u.error("error",a);this.trigger(w.error,a)});k.ondatachannel=v(function(a){a={event:a};u.debug("datachannel",a);this.trigger(w.dataChannel,a)});e.Class.extend(this,e.EventDispatcher,{_logger:u,getId:function(){return q.getId()+
this.getName()},getRemoteUser:function(){return q.getRemoteUser()},getConnection:function(){return q},getName:function(){return k.label},getState:function(){return k.readyState.toLowerCase()},send:function(a){var c=this,b=c.getState();b!==e.DataChannel.states.open&&(b=new e.CommonError("send",'DataChannel should be opened before sending some data. Current channel state is "'+b+'"'),u.error("error",b),c.trigger(w.error,b));u.info("send",a);r.send(a,function(){c.trigger(w.sentMessage,{data:a})})}})});
e.DataChannel.extend({events:{open:"open",sentMessage:"sentMessage",receivedMessage:"receivedMessage",close:"close",error:"error",dataChannel:"datachannel"},states:{connecting:"connecting",open:"open",closing:"closing",closed:"closed"}});a.prototype.send=function(a,b){this._sender.send(e.blobSerializer.pack(a),b)};b.prototype.send=function(a,b){var c=this;h(a,function(a){c._sender.send(a,b)})};f.prototype.send=function(a,b){this._sendChunks(this._splitToChunks(a),b)};f.prototype._splitToChunks=function(a){for(var b=
xRtc.utils.newGuid(),c=[],d=a.size,e=0,f=0,g=Math.ceil(d/this.chunkSize);e<d;){var h=Math.min(d,e+this.chunkSize),e={blobId:b,index:f,data:a.slice(e,h),total:g};c.push(e);e=h;f+=1}return c};f.prototype._sendChunks=function(a,b){var c=this;0===a.length?"function"===typeof b&&b():this._sender.send(a.shift(),function(){c._sendChunks(a,b)})};g.prototype.send=function(a,b){this._buffer.push(a);this._sendBuffer(this._buffer,b)};g.prototype._sendBuffer=function(a,b){var c=this;c._sendImmediately&&!c._trySendBuffer(a,
b)&&(c._sendImmediately=!1,d.setTimeout(function(){c._sendImmediately=!0;c._sendBuffer(a,b)},100))};g.prototype._trySendBuffer=function(a,b){return 0===a.length?!0:this._trySend(a[0],b)?(a.shift(),this._trySendBuffer(a,b)):!1};g.prototype._trySend=function(a,b){try{return this._sender.send(a),"function"===typeof b&&b(),!0}catch(c){return!1}}})(window);(function(d){"undefined"===typeof d.xRtc&&(d.xRtc={});var a=d.xRtc,h={},b=a.webrtc;a.Class(h,"IceCandidateFilter",function(b,d){var e=b||a.Connection.connectionTypes["default"],h=/(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})/g;a.Class.extend(this,{getType:function(){return e},filterCandidate:function(b){var f=null;if(e===a.Connection.connectionTypes["default"])f=b;else if(e===a.Connection.connectionTypes.direct&&(q.isLocal(b)||q.isStun(b)))f=b;else if(e===a.Connection.connectionTypes.server)if(q.isTurn(b))f=
b;else if(q.isStun(b)){var f=null,u;u=null;if(d)for(var w=0;w<d.length;w++){var r=d[w];0===r.url.indexOf("turn:")&&(u=-1!==r.url.indexOf("@")?r.url.split("@")[1]:r.url.split("turn:")[1])}u&&(f=b,f.candidate=b.candidate.replace(h,u),f.candidate=b.candidate.replace("typ srflx","typ relay"))}return f},filterSDP:function(b){var d=b;e===a.Connection.connectionTypes.server?d=b.replace(/a=candidate:.*((typ host)|(typ srflx)).*\r\n/g,""):e===a.Connection.connectionTypes.direct&&(d=b.replace(/a=candidate:.*typ relay.*\r\n/g,
""));return d}});var q={isLocal:function(a){return/typ host/.test(a.candidate)},isStun:function(a){return/typ srflx/.test(a.candidate)},isTurn:function(a){return/typ relay/.test(a.candidate)}}});a.Class(a,"Connection",function(f,g,e,k,q,c){function v(b){var c=new a.CommonError(b,"The method can be called on '"+a.Room.events.connectionCreated+"' event of the xRtc.Room. Use xRtc.Room.events.connectionCreated for access the event name.");p.error(b,c)}function u(c,f){function g(){if("function"===typeof f)try{f()}catch(a){}}
function h(a){function c(a,b){var d=a;a[a.length-1]===b&&(d=a.substring(0,a.length-1));return d}for(var d=[],e=function(a){var d;if(b.detectedBrowser==b.supportedBrowsers.chrome){var e=a.url;d=a.username;a=a.credential;var l=null,f=e.split(":");0===f[0].indexOf("stun")?l={url:c(e,"/")}:0===f[0].indexOf("turn")&&(28>b.detectedBrowserVersion?(e=e.split("turn:"),l={url:"turn:"+d+"@"+e[1],credential:a}):l={url:c(e,"/"),credential:a,username:d})}else e=a.url,d=a.username,a=a.credential,l=null,f=e.split(":"),
0===f[0].indexOf("stun")?l={url:c(e,"/")}:0!==f[0].indexOf("turn")||-1===e.indexOf("transport=udp")&&-1!==e.indexOf("?transport")||(e=e.split("?"),l={url:c(e[0],"/"),credential:a,username:d});return d=l},l=0,f=a.length;l<f;l++){var y=e(a[l]);y&&d.push(y)}return d}function k(c){var f=this;c=h(c);l=new b.RTCPeerConnection(c&&0<c.length?{iceServers:c}:null,a.Connection.settings.peerConnectionOptions);p.info("initPeerConnection","PeerConnection created.");l.onicecandidate=t(function(a){a.candidate&&(p.debug("peerConnection.onIceCandidate",
a.candidate),a=JSON.parse(JSON.stringify(a.candidate)),a=H.filterCandidate(a),null!==a&&(I.push(a),M&&r.call(this)))});l.onstatechange=l.onsignalingstatechange=t(function(b){p.debug("onConnectionStateChange",b);this.trigger(a.Connection.events.stateChanged,{connection:this,state:this.getState()})});if(b.detectedBrowser===b.supportedBrowsers.firefox&&24>b.detectedBrowserVersion){var P=this.getState();N=d.setInterval(function(){var b=f.getState();b!=P&&(p.debug("setInterval -> xrtc.Connection.events.stateChanged",
b),P=b,f.trigger(a.Connection.events.stateChanged,{connection:f,state:P}))},500)}l.onicechange=l.oniceconnectionstatechange=t(function(b){b=y.call(f);p.debug("onIceStateChange",(new Date).getTime(),b);E&&(p.debug("onIceStateChange",(new Date).getTime(),"checkDisconnectedIceStateTimeout are clearing. ID = '"+E+"'"),d.clearTimeout(E),E=null,p.debug("onIceStateChange",(new Date).getTime(),"checkDisconnectedIceStateTimeout was cleared. ID = '"+E+"'"));"connected"===b?f.trigger(a.Connection.events.connectionEstablished,
{connection:f,user:e}):"disconnected"===b&&(p.debug("onIceStateChange",(new Date).getTime(),"checkDisconnectedIceStateTimeout(10sec.) was started."),E=d.setTimeout(function(){p.debug("onIceStateChange",(new Date).getTime(),"ice state equals 'disconnected' so closePeerConnection was called. Timeout is 10sec and it is expired.");m.call(f);d.clearInterval(E);E=null},1E4),p.debug("onIceStateChange",(new Date).getTime(),"checkDisconnectedIceStateTimeout ID ='"+E+"'"))});l.ondatachannel=function(b){b=new a.DataChannel(b.channel,
f);G.push(b);f.trigger(a.Connection.events.dataChannelCreated,{connection:f,channel:b})};l.onaddstream=t(function(b){b=new a.Stream(b.stream);D.push(b);b={user:e,connection:this,stream:b};p.debug("addRemoteStream",b);this.trigger(a.Connection.events.remoteStreamAdded,b)});l.onclosedconnection=function(a){p.debug("peerConnection.onclosedconnection",a);m.call(f)};c=0;for(var n=B.length;c<n;c++)l.addStream(B[c].getStream());c=0;for(n=Q.length;c<n;c++)w.call(this,Q[c]);g()}e=c;l?g():n.call(this,t(k))}
function w(b){try{var c;a.webrtc.supports.sctp?(c=l.createDataChannel(b.name,{reliable:!0}),c.binaryType="arraybuffer"):c=l.createDataChannel(b.name,{reliable:!1});var d=new a.DataChannel(c,this);G.push(d);this.trigger(a.Connection.events.dataChannelCreated,{connection:this,channel:d})}catch(e){c=new a.CommonError("createDataChannel","Can't create DataChannel.",e),p.error("createDataChannel",c),this.trigger(a.Connection.events.dataChannelCreationError,{connection:this,channelConfig:b,error:c})}}function r(){p.debug("sendIceCandidates",
'Sending "'+I.length+'" ice candidates.');for(var b=0,c=I.length;b<c;b++){var d=I[b];J.sendIce(e.id,L,JSON.stringify(d));this.trigger(a.Connection.events.iceSent,{connection:this,iceCandidate:d})}I=[]}function n(a){"function"===typeof a&&(F?a(F):C.getIceServers(K,function(b){F=b;a(F)}))}function z(c){p.debug("Ice candidate was received.",c);c=new b.RTCIceCandidate(JSON.parse(c.iceCandidate));l.addIceCandidate(c);this.trigger(a.Connection.events.iceAdded,{connection:this,iceCandidate:c})}function A(c){this.trigger(a.Connection.events.offerReceived,
{connection:this,user:e,offerData:c});this.trigger(a.Connection.events.connectionOpening,{connection:this,user:e});p.debug("Offer was received.",c);F=c.iceServers;u.call(this,e,t(function(){p.debug("receiveOffer",c);H=new h.IceCandidateFilter(c.connectionType,F);var d=JSON.parse(c.offer),d=new b.RTCSessionDescription(d);l.setRemoteDescription(d);l.createAnswer(t(function(d){b.detectedBrowser===b.supportedBrowsers.firefox&&(d.sdp=H.filterSDP(d.sdp));l.setLocalDescription(d);var f={answer:JSON.stringify(d),
acceptData:c.acceptData};p.debug("sendAnswer",c,d);J.sendAnswer(e.id,L,f);this.trigger(a.Connection.events.answerSent,{connection:this,user:e,answerData:f});this.trigger(a.Connection.events.connectionEstablishing,{connection:this,user:e});M=!0;r.call(this)}),t(function(b){b=new a.CommonError("sendAnswer","Cannot create WebRTC answer",b);p.error("sendAnswer",b);this.trigger(a.Connection.events.createAnswerError,{connection:this,error:b})}),a.Connection.settings.answerOptions)}))}function s(c){p.debug("Answer was received.",
c);M=!0;r.call(this);c=JSON.parse(c.answer);c=new b.RTCSessionDescription(c);l.setRemoteDescription(c);this.trigger(a.Connection.events.answerReceived,{connection:this,user:e,answerData:{answer:c}});this.trigger(a.Connection.events.connectionEstablishing,{connection:this,user:e})}function x(){m.call(this)}function m(){b.detectedBrowser===b.supportedBrowsers.firefox&&N&&(d.clearInterval(N),N=null);if(l){l.onicecandidate=null;l.close();l=null;I=[];F=null;O=M=!1;var c={user:e,connection:this};e=null;
this.trigger(a.Connection.events.connectionClosed,c)}}function y(){return l&&(l.iceConnectionState||l.iceState)||"notinitialized"}var t=a.Class.proxy(this),p=new a.Logger(this.className),K=g,C=q||new xRtc.AuthManager,B=[],D=[],G=[],Q=[],l=null,N=null,E=null,J=k,H=null,F=null,M=!1,I=[],L=f,O=!1;(function(){var b=a.HandshakeController.events;J.on(b.receiveIce,t(z)).on(b.receiveOffer,t(A)).on(b.receiveAnswer,t(s)).on(b.receiveBye,t(x))}).call(this);a.Class.extend(this,a.EventDispatcher,{_logger:p,getId:function(){return L},
getRemoteUser:function(){return e},_open:function(d){O=!0;var f=this,y={};a.Class.extend(y,a.Connection.settings.offerOptions);d&&d.offer&&a.Class.extend(y,d.offer);f.trigger(a.Connection.events.connectionOpening,{connection:f,user:e});u.call(f,e,function(){H=new h.IceCandidateFilter(d&&d.connectionType||null,F);l.createOffer(t(function(d){if(l){b.detectedBrowser===b.supportedBrowsers.firefox&&(d.sdp=H.filterSDP(d.sdp));p.debug("onCreateOfferSuccess",d);l.setLocalDescription(d);b.detectedBrowser===
b.supportedBrowsers.firefox&&21>=b.detectedBrowserVersion&&(d.sdp=-1==d.sdp.indexOf("a=crypto")?d.sdp.replace(/c=IN/g,"a=crypto:1 AES_CM_128_HMAC_SHA1_80 inline:FakeFakeFakeFakeFakeFakeFakeFakeFakeFake\r\nc=IN"):d.sdp);var y={offer:JSON.stringify(d),connectionData:c,connectionType:H.getType(),iceServers:F};p.debug("sendOffer",e.id,d);J.sendOffer(e.id,L,y);f.trigger(a.Connection.events.offerSent,{connection:this,user:e,offerData:y})}}),t(function(b){b=new a.CommonError("startSession","Cannot create WebRTC offer",
b);p.error("onCreateOfferError",b);f.trigger(a.Connection.events.createOfferError,{connection:f,error:b})}),y)})},close:function(a){J&&e&&J.sendBye(e.id,L,a);m.call(this)},addStream:function(b){O&&v("addStream");B.push(b);b={connection:this,stream:b,user:{id:K.name,name:K.name}};p.debug("addLocalStream",b);this.trigger(a.Connection.events.localStreamAdded,b)},createDataChannel:function(a,b){O&&v("createDataChannel");Q.push({name:a,config:b})},getData:function(){return c},getState:function(){var a=
0<B.length;return{notinitialized:a?"ready":"not-ready","new":a?"ready":"not-ready",opening:"connecting",active:"connected",closing:"disconnecting",closed:a?"ready":"not-ready",stable:"connected","have-local-offer":"ready","have-remote-offer":"connecting"}[l&&(l.signalingState||l.readyState)||"notinitialized"]},getLocalStreams:function(){return B.map(function(a){return a})},getRemoteStreams:function(){return D.map(function(a){return a})},getDataChannels:function(){return G.map(function(a){return a})}})});
a.Connection.extend({events:{connectionOpening:"connectionopening",connectionEstablishing:"connectionestablishing",connectionEstablished:"connectionestablished",connectionClosed:"connectionclosed",localStreamAdded:"localstreamadded",remoteStreamAdded:"remotestreamadded",dataChannelCreated:"datachannelcreated",dataChannelCreationError:"datachannelcreationerror",stateChanged:"statechanged",createOfferError:"createoffererror",offerSent:"offersent",offerReceived:"offerreceived",createAnswerError:"createanswererror",
answerSent:"answersent",answerReceived:"answerreceived",iceSent:"icesent",iceAdded:"iceadded"},connectionTypes:{"default":"default",direct:"direct",server:"server"},settings:{offerOptions:{optional:[],mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}},answerOptions:{optional:[],mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}},peerConnectionOptions:{optional:[{RtpDataChannels:!a.webrtc.supports.sctp},{DtlsSrtpKeyAgreement:!0}]}}});b.RTCPeerConnection.prototype&&!b.RTCPeerConnection.prototype.getLocalStreams&&
a.Class.extend(b.RTCPeerConnection.prototype,{getLocalStreams:function(){return this.localStreams},getRemoteStreams:function(){return this.remoteStreams}});b.MediaStream.prototype.getVideoTracks||(b.detectedBrowser===b.supportedBrowsers.firefox?a.Class.extend(b.MediaStream.prototype,{getVideoTracks:function(){return[]},getAudioTracks:function(){return[]}}):a.Class.extend(b.MediaStream.prototype,{getVideoTracks:function(){return this.videoTracks},getAudioTracks:function(){return this.audioTracks}}))})(window);(function(d){"undefined"===typeof d.xRtc&&(d.xRtc={});var a=d.xRtc;a.Class(a,"HandshakeController",function(){var d=new a.Logger(this.className);a.Class.extend(this,a.EventDispatcher,{_logger:d,sendIce:function(b,d,g){this.trigger(a.HandshakeController.events.sendIce,b,d,g)},sendOffer:function(b,d,g){this.trigger(a.HandshakeController.events.sendOffer,b,d,g)},sendAnswer:function(b,d,g){this.trigger(a.HandshakeController.events.sendAnswer,b,d,g)},sendBye:function(b,d,g){this.trigger(a.HandshakeController.events.sendBye,
b,d,g)}})});a.HandshakeController.extend({events:{sendIce:"sendice",sendOffer:"sendoffer",sendAnswer:"sendanswer",sendBye:"sendbye",receiveIce:"receiveice",receiveOffer:"receiveoffer",receiveAnswer:"receiveanswer",receiveBye:"receivebye"}})})(window);(function(d){"undefined"===typeof d.xRtc&&(d.xRtc={});var a=d.xRtc;a.Class(a,"ServerConnector",function(h){function b(b,c){var d={eventName:b.eventName};"undefined"!==typeof b.data&&(d.data=b.data);"undefined"!==typeof b.targetUserId&&(d.targetUserId=b.targetUserId.toString());var e=JSON.stringify(d);if(z)n.debug("send",d,e),z.send(e);else if(c)n.debug("send","The call was ignored because no server connection.",d,e);else throw d=new a.CommonError("send","Trying to call method without established connection",
"WebSocket is not connected!"),n.error("send",d),d;}function f(b,c){try{if(b=JSON.parse(b),n.debug("getWebSocketURL",b),b&&b.e&&""!=b.e){var d=new a.CommonError("getWebSocketURL","Error occured while getting the URL of WebSockets",b.e);n.error("getWebSocketURL",d);this.trigger(m.serverError,{error:d})}else{var e=b.d.value;n.info("getWebSocketURL",e);"function"===typeof c&&c(e)}}catch(g){this.ajax(a.ServerConnector.settings.URL,"POST","",r(f,c))}}function g(a,b){z=new WebSocket(a+"/ws/"+encodeURIComponent(b));
z.onopen=r(e);z.onclose=r(k);z.onerror=r(q);z.onmessage=r(c)}function e(a){a={event:a};n.debug("open",a);s&&(x=w.call(this,s));this.trigger(m.connectionOpen,a)}function k(a){x&&(d.clearInterval(x),x=null);a={event:a};n.debug("close",a);this.trigger(m.connectionClose,a);z=null}function q(b){b=new a.CommonError("onerror","WebSocket has got an error",b);n.error("error",b);this.trigger(m.connectionError,{error:b})}function c(a){var b={message:a};n.debug("message",b);this.trigger(m.message,b);if(v(a))if(a=
u(a),b=a.type,b==m.usersUpdated||b==m.userConnected||b==m.userDisconnected)if(b==m.usersUpdated){for(var b=[],c=0,d=a.message.users.length;c<d;c++)b.push({id:a.message.users[c],name:a.message.users[c]});this.trigger(m.usersUpdated,{users:b})}else b==m.userConnected?this.trigger(m.userConnected,{user:{id:a.message,name:a.message}}):b==m.userDisconnected&&this.trigger(m.userDisconnected,{user:{id:a.message,name:a.message}});else if(b==m.receiveOffer||b==m.receiveAnswer||b==m.receiveIce||b==m.receiveBye)b==
m.receiveOffer?this.trigger(m.receiveOffer,{senderId:a.userid,receiverId:a.message.targetUserId,connectionId:a.message.data.connectionId,offer:a.message.data.offer.offer,iceServers:a.message.data.offer.iceServers,connectionType:a.message.data.offer.connectionType,connectionData:a.message.data.offer.connectionData}):b==m.receiveAnswer?this.trigger(m.receiveAnswer,{senderId:a.userid,connectionId:a.message.data.connectionId,answer:a.message.data.answer.answer,acceptData:a.message.data.answer.acceptData}):
b==m.receiveIce?this.trigger(m.receiveIce,{senderId:a.userid,connectionId:a.message.data.connectionId,iceCandidate:a.message.data.iceCandidate}):b==m.receiveBye&&this.trigger(m.receiveBye,{senderId:a.userid,connectionId:a.message.data.connectionId,byeData:a.message.data.byeData})}function v(a){var b=!0;'"Token invalid"'===a.data&&(b=!1,this.trigger(m.tokenInvalid,{token:A}));return b}function u(b){var c;try{c=JSON.parse(b.data)}catch(d){c=null;var e=new a.CommonError("parseServerMessage","Message format error",
d);n.error("parseServerMessage",e,b);this.trigger(m.messageFormatError,{error:e})}return c}function w(a){return d.setInterval(function(){b.call(this,{})},a)}var r=a.Class.proxy(this),n=new a.Logger(this.className),z=null,A=null,s=h?h.pingInterval:5E3,x=null,m=a.ServerConnector.events;a.Class.extend(this,a.EventDispatcher,a.Ajax,{_logger:n,connect:function(b){A=b;b=r(g,b);this.ajax(a.ServerConnector.settings.URL,"POST","",r(f,b))},disconnect:function(){z?(z.close(),A=z=null,n.info("disconnect","Connection with WS has been broken")):
n.debug("disconnect","Connection with WS has not been established yet")},sendOffer:function(a,c,d){b({eventName:m.receiveOffer,targetUserId:a,data:{connectionId:c,offer:d||{}}})},sendAnswer:function(a,c,d){b({eventName:m.receiveAnswer,targetUserId:a,data:{connectionId:c,answer:d||{}}})},sendIce:function(a,c,d){b({eventName:m.receiveIce,targetUserId:a,data:{connectionId:c,iceCandidate:d}})},sendBye:function(a,c,d){b({eventName:m.receiveBye,targetUserId:a,data:{connectionId:c,byeData:d||{}}},!0)}})});
a.ServerConnector.extend({events:{connectionOpen:"connectionopen",connectionClose:"connectionclose",connectionError:"connectionerror",message:"message",messageFormatError:"messageformaterror",serverError:"servererror",tokenInvalid:"tokeninvalid",receiveOffer:"receiveoffer",receiveAnswer:"receiveanswer",receiveIce:"receiveice",receiveBye:"receivebye",usersUpdated:"peers",userConnected:"peer_connected",userDisconnected:"peer_removed"},settings:{URL:"https://api.xirsys.com/wsList"}})})(window);(function(d){"undefined"===typeof d.xRtc&&(d.xRtc={});var a=d.xRtc;a.Class(a,"Room",function(d,b,f){function g(){var b=this;m||(C.on(s.connectionOpen,n(function(b){this.trigger(a.Room.events.enter)})).on(s.connectionClose,n(function(b){this.trigger(a.Room.events.leave)})).on(s.tokenInvalid,n(function(b){this.trigger(a.Room.events.tokenInvalid,b)})).on(s.usersUpdated,n(function(b){x=b.users;x.sort(c);this.trigger(a.Room.events.usersUpdated,{users:this.getUsers()})})).on(s.userConnected,n(function(b){x.push(b.user);
x.sort(c);this.trigger(a.Room.events.userConnected,{user:b.user})})).on(s.userDisconnected,n(function(b){x.splice(r(x,b.user.id),1);x.sort(c);this.trigger(a.Room.events.userDisconnected,{user:b.user})})).on(s.receiveOffer,n(e)).on(s.receiveBye,n(k)).on(s.receiveAnswer,function(c){if(c.senderId&&c.connectionId){var d=v(c.senderId);if(d){var e=D[c.connectionId];e?e.userId===d.id&&(b.trigger(a.Room.events.connectionAccepted,{user:d,connection:u(c.connectionId),data:c.acceptData}),e.hc.trigger(A.receiveAnswer,
{connectionId:c.connectionId,answer:c.answer})):C.sendBye(c.senderId,c.connectionId,{type:G.decline,data:"Remote connection not found."})}}}).on(s.receiveIce,function(a){if(a.senderId&&a.connectionId){var b=D[a.connectionId];b&&b.userId===a.senderId&&b.hc.trigger(A.receiveIce,{iceCandidate:a.iceCandidate,connectionId:a.connectionId})}}),m=!0)}function e(b){function c(a){q.call(e,b.connectionId,p,v(b.senderId),b.connectionData,function(c){c.handshakeController.trigger(A.receiveOffer,{offer:b.offer,
iceServers:b.iceServers,connectionType:b.connectionType,connectionId:b.connectionId,connectionData:b.connectionData,acceptData:a})})}function d(a){C.sendBye(b.senderId,b.connectionId,{type:G.decline,data:a})}if(b.senderId&&b.connectionId){var e=this,f={user:v(b.senderId),connectionId:b.connectionId,data:b.connectionData};y.autoReply||(f.accept=n(c),f.decline=n(d));D[b.connectionId]={userId:b.senderId,hc:null};this.trigger(a.Room.events.incomingConnection,f);y.autoReply&&c.call(e)}}function k(b){if(b.senderId&&
b.connectionId){var c=v(b.senderId);if(c){var d=D[b.connectionId];if(d&&d.userId===c.id){if(b.byeData&&b.byeData.type===G.decline||!d.hc){var e=u(b.connectionId);e&&this.trigger(a.Room.events.connectionDeclined,{user:c,connection:e,data:b.byeData})}d.hc&&d.hc.trigger(A.receiveBye)}}}}function q(b,c,d,e,f){var g=new a.HandshakeController;c=new xRtc.Connection(b,c,d,g,K,e);D[b]?D[b].hc=g:D[b]={userId:d.id,hc:g};g.on(A.sendOffer,n(function(a,b,c){C.sendOffer(a,b,c)})).on(A.sendAnswer,n(function(a,b,
c){C.sendAnswer(a,b,c)})).on(A.sendIce,n(function(a,b,c){C.sendIce(a,b,c)})).on(A.sendBye,n(function(a,b,c){C.sendBye(a,b,c)}));c.on(a.Connection.events.connectionClosed,function(){B.splice(w(B,b),1);delete D[b]});B.push(c);this.trigger(a.Room.events.connectionCreated,{user:d,connection:c});"function"===typeof f&&f({connection:c,handshakeController:g})}function c(a,b){var c=0;a.name<b.name?c=-1:a.name>b.name&&(c=1);return c}function v(a){for(var b=null,c=0,d=x.length;c<d;c++)if(x[c].id===a){b=x[c];
break}return b}function u(a){for(var b=null,c=0,d=B.length;c<d;c++)if(B[c].getId()===a){b=B[c];break}return b}function w(a,b){for(var c=-1,d=0,e=a.length;d<e;d++)if(a[d].getId()===b){c=d;break}return c}function r(a,b){for(var c=-1,d=0,e=a.length;d<e;d++)a[d].id===b&&(c=d);return c}var n=a.Class.proxy(this),z=new a.Logger(this.className),A=a.HandshakeController.events,s=a.ServerConnector.events,x=[],m=!1,y={},t={},p=null,K=b||new xRtc.AuthManager,C=f||new a.ServerConnector,B=[],D={},G={decline:"decline"};
a.Class.extend(t,a.Room.settings.info);"string"===typeof d?t.name=d:a.Class.extend(t,d);a.Class.extend(this,a.EventDispatcher,{_logger:z,enter:function(b,c){var d="",e="";if(!b)throw new a.CommonError("enter","User credentials should be specified.");"string"===typeof b?d=b:(d=b.username,e=b.password);g.call(this);a.Class.extend(y,a.Room.settings.enterOptions);c&&a.Class.extend(y,c);p={domain:t.domain,application:t.application,room:t.name,name:d,password:e};K.getToken(p,function(a){t.user={id:null,
name:d};C.connect(a)})},leave:function(){C.on(a.ServerConnector.events.connectionClose,function(){m&&(C.off(s.connectionOpen).off(s.connectionClose).off(s.tokenInvalid).off(s.usersUpdated).off(s.userConnected).off(s.userDisconnected).off(s.receiveOffer).off(s.receiveBye).off(s.receiveAnswer).off(s.receiveIce),m=!1);y={};p=null;t.user=null;x=[];B=[];D={}});C.disconnect()},connect:function(b,c){if(!t.user)throw new a.CommonError("connect","Need to enter the room before you connect someone.");var d=
v(b);if(null==d)d=a.CommonError("connect","Target user not found."),this.trigger(a.Room.events.error,{userId:b,error:d});else{var e=c&&c.data?c.data:null,f=c&&c.id?c.id:a.utils.newGuid();q.call(this,f,p,d,e,function(a){a=a.connection;c&&"auto"===c.createDataChannel&&a.createDataChannel("autoDataChannel");a._open(c)})}},getInfo:function(){return t},getConnections:function(){return B.map(function(a){return a})},getUsers:function(){return x.map(function(a){return a})}})});a.Room.extend({events:{enter:"enter",
leave:"leave",incomingConnection:"incomingconnection",connectionCreated:"connectioncreated",connectionAccepted:"connectionaccepted",connectionDeclined:"connectiondeclined",usersUpdated:"usersupdated",userConnected:"userconnected",userDisconnected:"userdisconnected",tokenInvalid:"tokeninvalid",error:"error"},settings:{info:{domain:d.document.domain,application:"default",name:"default"},enterOptions:{autoReply:!0}}})})(window);(function(d){"undefined"===typeof d.xRtc&&(d.xRtc={});var a=d.xRtc,h=a.webrtc,b=new a.Logger("UserMedia"),f=function(b,d,f){h.getUserMedia(b,function(b){"function"===typeof d&&d(new a.Stream(b))},function(a){"function"===typeof f&&f(a)})};a.getUserMedia=function(d,e,k){if(d&&!d.video&&!d.audio){var q=new a.CommonError("getUserMedia","video or audio property of the options parameter should be specified. No sense to create media stream without video and audio components.");b.error("onCreateOfferError",
q)}var c=d||{video:!0,audio:!0};c.video&&c.video.mandatory&&"screen"===c.video.mandatory.mediaSource?f.call(this,{video:{mandatory:{chromeMediaSource:"screen"}}},function(a){c.audio?f.call(this,{audio:!0},function(b){function c(a,b){for(var d=0;d<b.length;d++)a.push(b[d])}var d=[];c(d,b.getAudioTracks());c(d,a.getVideoTracks());e(new h.MediaStream(d))},k):e(a)},k):f.call(this,c,e,k)}})(window);
