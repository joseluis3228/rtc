<!DOCTYPE html />

<html>
<head>
	<title>binarypack.js</title>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
	<link href="../../nocco.css" rel="stylesheet" media="all" type="text/css" />
	<script src="../../prettify.js" type="text/javascript"></script>
</head>
<body onload="prettyPrint()">
	<div id="container">
		<div id="background"></div>
			<div id="jump_to">
				Jump To &hellip;
				<div id="jump_wrapper">
					<div id="jump_page">
							<a class="source" href="../../xrtc/ajax.html">
								xrtc\ajax.js
							</a>
							<a class="source" href="../../xrtc/authmanager.html">
								xrtc\AuthManager.js
							</a>
							<a class="source" href="../../xrtc/class.html">
								xrtc\class.js
							</a>
							<a class="source" href="../../xrtc/common.html">
								xrtc\common.js
							</a>
							<a class="source" href="../../xrtc/commonerror.html">
								xrtc\commonError.js
							</a>
							<a class="source" href="../../xrtc/connection.html">
								xrtc\Connection.js
							</a>
							<a class="source" href="../../xrtc/datachannel.html">
								xrtc\DataChannel.js
							</a>
							<a class="source" href="../../xrtc/eventdispatcher.html">
								xrtc\eventDispatcher.js
							</a>
							<a class="source" href="../../xrtc/handshakecontroller.html">
								xrtc\handshakeController.js
							</a>
							<a class="source" href="../../xrtc/logger.html">
								xrtc\logger.js
							</a>
							<a class="source" href="../../xrtc/room.html">
								xrtc\room.js
							</a>
							<a class="source" href="../../xrtc/serverconnector.html">
								xrtc\ServerConnector.js
							</a>
							<a class="source" href="../../xrtc/stream.html">
								xrtc\stream.js
							</a>
							<a class="source" href="../../xrtc/usermedia.html">
								xrtc\userMedia.js
							</a>
							<a class="source" href="../../xrtc/dependencies/binarypack.html">
								xrtc\dependencies\binarypack.js
							</a>
					</div>
				</div>
			</div>
		<table cellpadding="0" cellspacing="0">
			<thead>
				<tr>
					<th class="docs">
						<h1>binarypack.js</h1>
					</th>
					<th class="code"></th>
				</tr>
			</thead>
			<tbody>
					<tr id="section_1">
						<td class="docs">
							<div class="pilwrap">
								<a class="pilcrow" href="#section_1">&#182;</a>
							</div>
							
						</td>
						<td class="code">
							<pre><code class='prettyprint'>/*! binarypack.js build:0.0.7, development. Copyright(c) 2012 Eric Zhang &lt;eric@ericzhang.com&gt; MIT Licensed */
(function(exports){
var binaryFeatures = {};
binaryFeatures.useBlobBuilder = (function(){
  try {
    new Blob([]);
    return false;
  } catch (e) {
    return true;
  }
})();

binaryFeatures.useArrayBufferView = !binaryFeatures.useBlobBuilder &amp;&amp; (function(){
  try {
    return (new Blob([new Uint8Array([])])).size === 0;
  } catch (e) {
    return true;
  }
})();

exports.binaryFeatures = binaryFeatures;
exports.BlobBuilder = window.WebKitBlobBuilder || window.MozBlobBuilder || window.MSBlobBuilder || window.BlobBuilder;

function BufferBuilder(){
  this._pieces = [];
  this._parts = [];
}

BufferBuilder.prototype.append = function(data) {
  if(typeof data === &#39;number&#39;) {
    this._pieces.push(data);
  } else {
    this.flush();
    this._parts.push(data);
  }
};

BufferBuilder.prototype.flush = function() {
  if (this._pieces.length &gt; 0) {
    var buf = new Uint8Array(this._pieces);
    if(!binaryFeatures.useArrayBufferView) {
      buf = buf.buffer;
    }
    this._parts.push(buf);
    this._pieces = [];
  }
};

BufferBuilder.prototype.getBuffer = function() {
  this.flush();
  if(binaryFeatures.useBlobBuilder) {
    var builder = new BlobBuilder();
    for(var i = 0, ii = this._parts.length; i &lt; ii; i++) {
      builder.append(this._parts[i]);
    }
    return builder.getBlob();
  } else {
    return new Blob(this._parts);
  }
};
exports.BinaryPack = {
  unpack: function(data){
    var unpacker = new Unpacker(data);
    return unpacker.unpack();
  },
  pack: function(data){
    var packer = new Packer();
    packer.pack(data);
    var buffer = packer.getBuffer();
    return buffer;
  }
};

function Unpacker (data){
</code></pre>
						</td>
					</tr>
					<tr id="section_2">
						<td class="docs">
							<div class="pilwrap">
								<a class="pilcrow" href="#section_2">&#182;</a>
							</div>
							<p>Data is ArrayBuffer</p>

						</td>
						<td class="code">
							<pre><code class='prettyprint'>  this.index = 0;
  this.dataBuffer = data;
  this.dataView = new Uint8Array(this.dataBuffer);
  this.length = this.dataBuffer.byteLength;
}


Unpacker.prototype.unpack = function(){
  var type = this.unpack_uint8();
  if (type &lt; 0x80){
    var positive_fixnum = type;
    return positive_fixnum;
  } else if ((type ^ 0xe0) &lt; 0x20){
    var negative_fixnum = (type ^ 0xe0) - 0x20;
    return negative_fixnum;
  }
  var size;
  if ((size = type ^ 0xa0) &lt;= 0x0f){
    return this.unpack_raw(size);
  } else if ((size = type ^ 0xb0) &lt;= 0x0f){
    return this.unpack_string(size);
  } else if ((size = type ^ 0x90) &lt;= 0x0f){
    return this.unpack_array(size);
  } else if ((size = type ^ 0x80) &lt;= 0x0f){
    return this.unpack_map(size);
  }
  switch(type){
    case 0xc0:
      return null;
    case 0xc1:
      return undefined;
    case 0xc2:
      return false;
    case 0xc3:
      return true;
    case 0xca:
      return this.unpack_float();
    case 0xcb:
      return this.unpack_double();
    case 0xcc:
      return this.unpack_uint8();
    case 0xcd:
      return this.unpack_uint16();
    case 0xce:
      return this.unpack_uint32();
    case 0xcf:
      return this.unpack_uint64();
    case 0xd0:
      return this.unpack_int8();
    case 0xd1:
      return this.unpack_int16();
    case 0xd2:
      return this.unpack_int32();
    case 0xd3:
      return this.unpack_int64();
    case 0xd4:
      return undefined;
    case 0xd5:
      return undefined;
    case 0xd6:
      return undefined;
    case 0xd7:
      return undefined;
    case 0xd8:
      size = this.unpack_uint16();
      return this.unpack_string(size);
    case 0xd9:
      size = this.unpack_uint32();
      return this.unpack_string(size);
    case 0xda:
      size = this.unpack_uint16();
      return this.unpack_raw(size);
    case 0xdb:
      size = this.unpack_uint32();
      return this.unpack_raw(size);
    case 0xdc:
      size = this.unpack_uint16();
      return this.unpack_array(size);
    case 0xdd:
      size = this.unpack_uint32();
      return this.unpack_array(size);
    case 0xde:
      size = this.unpack_uint16();
      return this.unpack_map(size);
    case 0xdf:
      size = this.unpack_uint32();
      return this.unpack_map(size);
  }
}

Unpacker.prototype.unpack_uint8 = function(){
  var byteVariable = this.dataView[this.index] &amp; 0xff;
  this.index++;
  return byteVariable;
};

Unpacker.prototype.unpack_uint16 = function(){
  var bytes = this.read(2);
  var uint16 =
    ((bytes[0] &amp; 0xff) * 256) + (bytes[1] &amp; 0xff);
  this.index += 2;
  return uint16;
}

Unpacker.prototype.unpack_uint32 = function(){
  var bytes = this.read(4);
  var uint32 =
     ((bytes[0]  * 256 +
       bytes[1]) * 256 +
       bytes[2]) * 256 +
       bytes[3];
  this.index += 4;
  return uint32;
}

Unpacker.prototype.unpack_uint64 = function(){
  var bytes = this.read(8);
  var uint64 =
   ((((((bytes[0]  * 256 +
       bytes[1]) * 256 +
       bytes[2]) * 256 +
       bytes[3]) * 256 +
       bytes[4]) * 256 +
       bytes[5]) * 256 +
       bytes[6]) * 256 +
       bytes[7];
  this.index += 8;
  return uint64;
}


Unpacker.prototype.unpack_int8 = function(){
  var uint8 = this.unpack_uint8();
  return (uint8 &lt; 0x80 ) ? uint8 : uint8 - (1 &lt;&lt; 8);
};

Unpacker.prototype.unpack_int16 = function(){
  var uint16 = this.unpack_uint16();
  return (uint16 &lt; 0x8000 ) ? uint16 : uint16 - (1 &lt;&lt; 16);
}

Unpacker.prototype.unpack_int32 = function(){
  var uint32 = this.unpack_uint32();
  return (uint32 &lt; Math.pow(2, 31) ) ? uint32 :
    uint32 - Math.pow(2, 32);
}

Unpacker.prototype.unpack_int64 = function(){
  var uint64 = this.unpack_uint64();
  return (uint64 &lt; Math.pow(2, 63) ) ? uint64 :
    uint64 - Math.pow(2, 64);
}

Unpacker.prototype.unpack_raw = function(size){
  if ( this.length &lt; this.index + size){
    throw new Error(&#39;BinaryPackFailure: index is out of range&#39;
      + &#39; &#39; + this.index + &#39; &#39; + size + &#39; &#39; + this.length);
  }
  var buf = this.dataBuffer.slice(this.index, this.index + size);
  this.index += size;

</code></pre>
						</td>
					</tr>
					<tr id="section_3">
						<td class="docs">
							<div class="pilwrap">
								<a class="pilcrow" href="#section_3">&#182;</a>
							</div>
							<p>buf = util.bufferToString(buf);</p>

						</td>
						<td class="code">
							<pre><code class='prettyprint'>
  return buf;
}

Unpacker.prototype.unpack_string = function(size){
  var bytes = this.read(size);
  var i = 0, str = &#39;&#39;, c, code;
  while(i &lt; size){
    c = bytes[i];
    if ( c &lt; 128){
      str += String.fromCharCode(c);
      i++;
    } else if ((c ^ 0xc0) &lt; 32){
      code = ((c ^ 0xc0) &lt;&lt; 6) | (bytes[i+1] &amp; 63);
      str += String.fromCharCode(code);
      i += 2;
    } else {
      code = ((c &amp; 15) &lt;&lt; 12) | ((bytes[i+1] &amp; 63) &lt;&lt; 6) |
        (bytes[i+2] &amp; 63);
      str += String.fromCharCode(code);
      i += 3;
    }
  }
  this.index += size;
  return str;
}

Unpacker.prototype.unpack_array = function(size){
  var objects = new Array(size);
  for(var i = 0; i &lt; size ; i++){
    objects[i] = this.unpack();
  }
  return objects;
}

Unpacker.prototype.unpack_map = function(size){
  var map = {};
  for(var i = 0; i &lt; size ; i++){
    var key  = this.unpack();
    var value = this.unpack();
    map[key] = value;
  }
  return map;
}

Unpacker.prototype.unpack_float = function(){
  var uint32 = this.unpack_uint32();
  var sign = uint32 &gt;&gt; 31;
  var exp  = ((uint32 &gt;&gt; 23) &amp; 0xff) - 127;
  var fraction = ( uint32 &amp; 0x7fffff ) | 0x800000;
  return (sign == 0 ? 1 : -1) *
    fraction * Math.pow(2, exp - 23);
}

Unpacker.prototype.unpack_double = function(){
  var h32 = this.unpack_uint32();
  var l32 = this.unpack_uint32();
  var sign = h32 &gt;&gt; 31;
  var exp  = ((h32 &gt;&gt; 20) &amp; 0x7ff) - 1023;
  var hfrac = ( h32 &amp; 0xfffff ) | 0x100000;
  var frac = hfrac * Math.pow(2, exp - 20) +
    l32   * Math.pow(2, exp - 52);
  return (sign == 0 ? 1 : -1) * frac;
}

Unpacker.prototype.read = function(length){
  var j = this.index;
  if (j + length &lt;= this.length) {
    return this.dataView.subarray(j, j + length);
  } else {
    throw new Error(&#39;BinaryPackFailure: read index out of range&#39;);
  }
}

function Packer(){
  this.bufferBuilder = new BufferBuilder();
}

Packer.prototype.getBuffer = function(){
  return this.bufferBuilder.getBuffer();
}

Packer.prototype.pack = function(value){
  var type = typeof(value);
  if (type == &#39;string&#39;){
    this.pack_string(value);
  } else if (type == &#39;number&#39;){
    if (Math.floor(value) === value){
      this.pack_integer(value);
    } else{
      this.pack_double(value);
    }
  } else if (type == &#39;boolean&#39;){
    if (value === true){
      this.bufferBuilder.append(0xc3);
    } else if (value === false){
      this.bufferBuilder.append(0xc2);
    }
  } else if (type == &#39;undefined&#39;){
    this.bufferBuilder.append(0xc0);
  } else if (type == &#39;object&#39;){
    if (value === null){
      this.bufferBuilder.append(0xc0);
    } else {
      var constructor = value.constructor;
      if (constructor == Array){
        this.pack_array(value);
      } else if (constructor == Blob || constructor == File) {
        this.pack_bin(value);
      } else if (constructor == ArrayBuffer) {
        if(binaryFeatures.useArrayBufferView) {
          this.pack_bin(new Uint8Array(value));
        } else {
          this.pack_bin(value);
        }
      } else if (&#39;BYTES_PER_ELEMENT&#39; in value){
        if(binaryFeatures.useArrayBufferView) {
          this.pack_bin(new Uint8Array(value.buffer));
        } else {
          this.pack_bin(value.buffer);
        }
      } else if (constructor == Object){
        this.pack_object(value);
      } else if (constructor == Date){
        this.pack_string(value.toString());
      } else if (typeof value.toBinaryPack == &#39;function&#39;){
        this.bufferBuilder.append(value.toBinaryPack());
      } else {
        throw new Error(&#39;Type &quot;&#39; + constructor.toString() + &#39;&quot; not yet supported&#39;);
      }
    }
  } else {
    throw new Error(&#39;Type &quot;&#39; + type + &#39;&quot; not yet supported&#39;);
  }
  this.bufferBuilder.flush();
}


Packer.prototype.pack_bin = function(blob){
  var length = blob.length || blob.byteLength || blob.size;
  if (length &lt;= 0x0f){
    this.pack_uint8(0xa0 + length);
  } else if (length &lt;= 0xffff){
    this.bufferBuilder.append(0xda) ;
    this.pack_uint16(length);
  } else if (length &lt;= 0xffffffff){
    this.bufferBuilder.append(0xdb);
    this.pack_uint32(length);
  } else{
    throw new Error(&#39;Invalid length&#39;);
    return;
  }
  this.bufferBuilder.append(blob);
}

Packer.prototype.pack_string = function(str){
  var length = utf8Length(str);

  if (length &lt;= 0x0f){
    this.pack_uint8(0xb0 + length);
  } else if (length &lt;= 0xffff){
    this.bufferBuilder.append(0xd8) ;
    this.pack_uint16(length);
  } else if (length &lt;= 0xffffffff){
    this.bufferBuilder.append(0xd9);
    this.pack_uint32(length);
  } else{
    throw new Error(&#39;Invalid length&#39;);
    return;
  }
  this.bufferBuilder.append(str);
}

Packer.prototype.pack_array = function(ary){
  var length = ary.length;
  if (length &lt;= 0x0f){
    this.pack_uint8(0x90 + length);
  } else if (length &lt;= 0xffff){
    this.bufferBuilder.append(0xdc)
    this.pack_uint16(length);
  } else if (length &lt;= 0xffffffff){
    this.bufferBuilder.append(0xdd);
    this.pack_uint32(length);
  } else{
    throw new Error(&#39;Invalid length&#39;);
  }
  for(var i = 0; i &lt; length ; i++){
    this.pack(ary[i]);
  }
}

Packer.prototype.pack_integer = function(num){
  if ( -0x20 &lt;= num &amp;&amp; num &lt;= 0x7f){
    this.bufferBuilder.append(num &amp; 0xff);
  } else if (0x00 &lt;= num &amp;&amp; num &lt;= 0xff){
    this.bufferBuilder.append(0xcc);
    this.pack_uint8(num);
  } else if (-0x80 &lt;= num &amp;&amp; num &lt;= 0x7f){
    this.bufferBuilder.append(0xd0);
    this.pack_int8(num);
  } else if ( 0x0000 &lt;= num &amp;&amp; num &lt;= 0xffff){
    this.bufferBuilder.append(0xcd);
    this.pack_uint16(num);
  } else if (-0x8000 &lt;= num &amp;&amp; num &lt;= 0x7fff){
    this.bufferBuilder.append(0xd1);
    this.pack_int16(num);
  } else if ( 0x00000000 &lt;= num &amp;&amp; num &lt;= 0xffffffff){
    this.bufferBuilder.append(0xce);
    this.pack_uint32(num);
  } else if (-0x80000000 &lt;= num &amp;&amp; num &lt;= 0x7fffffff){
    this.bufferBuilder.append(0xd2);
    this.pack_int32(num);
  } else if (-0x8000000000000000 &lt;= num &amp;&amp; num &lt;= 0x7FFFFFFFFFFFFFFF){
    this.bufferBuilder.append(0xd3);
    this.pack_int64(num);
  } else if (0x0000000000000000 &lt;= num &amp;&amp; num &lt;= 0xFFFFFFFFFFFFFFFF){
    this.bufferBuilder.append(0xcf);
    this.pack_uint64(num);
  } else{
    throw new Error(&#39;Invalid integer&#39;);
  }
}

Packer.prototype.pack_double = function(num){
  var sign = 0;
  if (num &lt; 0){
    sign = 1;
    num = -num;
  }
  var exp  = Math.floor(Math.log(num) / Math.LN2);
  var frac0 = num / Math.pow(2, exp) - 1;
  var frac1 = Math.floor(frac0 * Math.pow(2, 52));
  var b32   = Math.pow(2, 32);
  var h32 = (sign &lt;&lt; 31) | ((exp+1023) &lt;&lt; 20) |
      (frac1 / b32) &amp; 0x0fffff;
  var l32 = frac1 % b32;
  this.bufferBuilder.append(0xcb);
  this.pack_int32(h32);
  this.pack_int32(l32);
}

Packer.prototype.pack_object = function(obj){
  var keys = Object.keys(obj);
  var length = keys.length;
  if (length &lt;= 0x0f){
    this.pack_uint8(0x80 + length);
  } else if (length &lt;= 0xffff){
    this.bufferBuilder.append(0xde);
    this.pack_uint16(length);
  } else if (length &lt;= 0xffffffff){
    this.bufferBuilder.append(0xdf);
    this.pack_uint32(length);
  } else{
    throw new Error(&#39;Invalid length&#39;);
  }
  for(var prop in obj){
    if (obj.hasOwnProperty(prop)){
      this.pack(prop);
      this.pack(obj[prop]);
    }
  }
}

Packer.prototype.pack_uint8 = function(num){
  this.bufferBuilder.append(num);
}

Packer.prototype.pack_uint16 = function(num){
  this.bufferBuilder.append(num &gt;&gt; 8);
  this.bufferBuilder.append(num &amp; 0xff);
}

Packer.prototype.pack_uint32 = function(num){
  var n = num &amp; 0xffffffff;
  this.bufferBuilder.append((n &amp; 0xff000000) &gt;&gt;&gt; 24);
  this.bufferBuilder.append((n &amp; 0x00ff0000) &gt;&gt;&gt; 16);
  this.bufferBuilder.append((n &amp; 0x0000ff00) &gt;&gt;&gt;  8);
  this.bufferBuilder.append((n &amp; 0x000000ff));
}

Packer.prototype.pack_uint64 = function(num){
  var high = num / Math.pow(2, 32);
  var low  = num % Math.pow(2, 32);
  this.bufferBuilder.append((high &amp; 0xff000000) &gt;&gt;&gt; 24);
  this.bufferBuilder.append((high &amp; 0x00ff0000) &gt;&gt;&gt; 16);
  this.bufferBuilder.append((high &amp; 0x0000ff00) &gt;&gt;&gt;  8);
  this.bufferBuilder.append((high &amp; 0x000000ff));
  this.bufferBuilder.append((low  &amp; 0xff000000) &gt;&gt;&gt; 24);
  this.bufferBuilder.append((low  &amp; 0x00ff0000) &gt;&gt;&gt; 16);
  this.bufferBuilder.append((low  &amp; 0x0000ff00) &gt;&gt;&gt;  8);
  this.bufferBuilder.append((low  &amp; 0x000000ff));
}

Packer.prototype.pack_int8 = function(num){
  this.bufferBuilder.append(num &amp; 0xff);
}

Packer.prototype.pack_int16 = function(num){
  this.bufferBuilder.append((num &amp; 0xff00) &gt;&gt; 8);
  this.bufferBuilder.append(num &amp; 0xff);
}

Packer.prototype.pack_int32 = function(num){
  this.bufferBuilder.append((num &gt;&gt;&gt; 24) &amp; 0xff);
  this.bufferBuilder.append((num &amp; 0x00ff0000) &gt;&gt;&gt; 16);
  this.bufferBuilder.append((num &amp; 0x0000ff00) &gt;&gt;&gt; 8);
  this.bufferBuilder.append((num &amp; 0x000000ff));
}

Packer.prototype.pack_int64 = function(num){
  var high = Math.floor(num / Math.pow(2, 32));
  var low  = num % Math.pow(2, 32);
  this.bufferBuilder.append((high &amp; 0xff000000) &gt;&gt;&gt; 24);
  this.bufferBuilder.append((high &amp; 0x00ff0000) &gt;&gt;&gt; 16);
  this.bufferBuilder.append((high &amp; 0x0000ff00) &gt;&gt;&gt;  8);
  this.bufferBuilder.append((high &amp; 0x000000ff));
  this.bufferBuilder.append((low  &amp; 0xff000000) &gt;&gt;&gt; 24);
  this.bufferBuilder.append((low  &amp; 0x00ff0000) &gt;&gt;&gt; 16);
  this.bufferBuilder.append((low  &amp; 0x0000ff00) &gt;&gt;&gt;  8);
  this.bufferBuilder.append((low  &amp; 0x000000ff));
}

function _utf8Replace(m){
  var code = m.charCodeAt(0);

  if(code &lt;= 0x7ff) return &#39;00&#39;;
  if(code &lt;= 0xffff) return &#39;000&#39;;
  if(code &lt;= 0x1fffff) return &#39;0000&#39;;
  if(code &lt;= 0x3ffffff) return &#39;00000&#39;;
  return &#39;000000&#39;;
}

function utf8Length(str){
  if (str.length &gt; 600) {
</code></pre>
						</td>
					</tr>
					<tr id="section_4">
						<td class="docs">
							<div class="pilwrap">
								<a class="pilcrow" href="#section_4">&#182;</a>
							</div>
							<p>Blob method faster for large strings</p>

						</td>
						<td class="code">
							<pre><code class='prettyprint'>    return (new Blob([str])).size;
  } else {
    return str.replace(/[^\u0000-\u007F]/g, _utf8Replace).length;
  }
}

})(this);
</code></pre>
						</td>
					</tr>
			</tbody>
		</table>
	</div>
</body>
</html>
